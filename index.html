<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Sistema de GestÃ£o Financeira - Advocacia</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
Â  Â  <!-- Biblioteca de GrÃ¡ficos -->
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  background-color: #111827; /* bg-gray-900 */
Â  Â  Â  Â  Â  Â  color: #d1d5db; /* text-gray-300 */
Â  Â  Â  Â  }
Â  Â  Â  Â  body::after {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  background-image: url('https://i.postimg.cc/XNs7dp8C/fabris-e-gurjas.png');
Â  Â  Â  Â  Â  Â  background-repeat: repeat;
Â  Â  Â  Â  Â  Â  background-attachment: fixed;
Â  Â  Â  Â  Â  Â  background-size: 300px;
Â  Â  Â  Â  Â  Â  opacity: 0.03;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  z-index: -1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 40; }
Â  Â  Â  Â  .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
Â  Â  Â  Â  .kanban-column { min-width: 320px; }
Â  Â  Â  Â  .kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px;}
Â  Â  Â  Â  ::-webkit-scrollbar { width: 8px; }
Â  Â  Â  Â  ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } /* gray-600 */
Â  Â  Â  Â  ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
Â  Â  Â  Â  .service-tag {
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  background-color: #374151; /* gray-700 */
Â  Â  Â  Â  Â  Â  color: #d1d5db; /* gray-300 */
Â  Â  Â  Â  Â  Â  padding: 4px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  margin-right: 4px;
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  Â  Â  width: 100%; /* Ocupa a largura toda */
Â  Â  Â  Â  }
Â  Â  Â  Â  .service-tag-small {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background-color: #374151; /* gray-700 */
Â  Â  Â  Â  Â  Â  color: #9ca3af; /* gray-400 */
Â  Â  Â  Â  Â  Â  padding: 2px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  margin-right: 4px;
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .service-tag .remove-tag {
Â  Â  Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-tab {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-bottom: 3px solid transparent;
Â  Â  Â  Â  Â  Â  color: #9ca3af; /* gray-400 */
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-tab:hover {
Â  Â  Â  Â  Â  Â  color: #e5e7eb; /* gray-200 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-tab.active {
Â  Â  Â  Â  Â  Â  border-bottom-color: #6366f1; /* indigo-500 */
Â  Â  Â  Â  Â  Â  color: #e5e7eb; /* gray-200 */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Classe especÃ­fica para o Ã­cone da lixeira */
Â  Â  Â  Â  .nav-tab-icon {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  padding: 10px 15px; /* Padding ligeiramente ajustado */
Â  Â  Â  Â  Â  Â  color: #9ca3af; /* gray-400 */
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-tab-icon:hover {
Â  Â  Â  Â  Â  Â  color: #e5e7eb; /* gray-200 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-tab-icon.active {
Â  Â  Â  Â  Â  Â  Â color: #6366f1; /* indigo-500 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar-bg {
Â  Â  Â  Â  Â  Â  background-color: #374151; /* gray-700 */
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  transition: width 0.5s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-card {
Â  Â  Â  Â  Â  Â  background-color: #1f2937; /* bg-gray-800 */
Â  Â  Â  Â  Â  Â  border: 1px solid #374151; /* border-gray-700 */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ***** CSS DO HEADER RESTAURADO ***** */
Â  Â  Â  Â  .header-with-logo {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ADICIONADO: Nova classe para o bloco de usuÃ¡rio */
Â  Â  Â  Â  .header-user-block {
Â  Â  Â  Â  Â  Â  margin-right: 160px; /* Margem para criar espaÃ§o para a logo */
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-logo {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  Â  Â  max-height: 60px;
Â  Â  Â  Â  Â  Â  opacity: 0.8;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ***** FIM DO CSS RESTAURADO ***** */

Â  Â  Â  Â  /* CORREÃ‡ÃƒO: Removido aninhamento invÃ¡lido */
Â  Â  Â  Â  .sort-button, .filter-button {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  border: 1px solid #4b5563;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  Â  Â  padding: 4px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sort-button:hover, .filter-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #4b5563;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sort-button.active, .filter-button.active {
Â  Â  Â  Â  Â  Â  background-color: #4f46e5;
Â  Â  Â  Â  Â  Â  border-color: #4f46e5;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NOVO: BotÃ£o de filtro de perÃ­odo */
Â  Â  Â  Â  .period-filter-button {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  border: 1px solid #4b5563;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  Â  Â  padding: 6px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .period-filter-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #4b5563;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .period-filter-button.active {
Â  Â  Â  Â  Â  Â  background-color: #4f46e5;
Â  Â  Â  Â  Â  Â  border-color: #4f46e5;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-select {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  border: 1px solid #4b5563;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .filter-select:disabled {
Â  Â  Â  Â  Â  Â  background-color: #4b5563;
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loading-overlay, #auth-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(17, 24, 39, 0.9);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #auth-overlay {
Â  Â  Â  Â  Â  Â  z-index: 99; /* Fica abaixo do loading, mas acima do app */
Â  Â  Â  Â  }
Â  Â  Â  Â  #app-container {
Â  Â  Â  Â  Â  Â  display: none; /* ComeÃ§a escondido */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Esconder elementos para nÃ£o-admins */
Â  Â  Â  Â  .admin-only { display: none; }
Â  Â  Â  Â  body.is-admin .admin-only { display: block; } /* Mostra se o body tiver a classe */
Â  Â  Â  Â  body.is-admin .flex.admin-only { display: flex; } /* Ajuste para flex containers */
Â  Â  Â  Â  body:not(.is-admin) .non-admin-hidden { display: none; }

Â  Â  </style>
</head>
<body class="text-gray-300"> <!-- Classe is-admin serÃ¡ adicionada via JS -->

Â  Â  <div id="loading-overlay">
Â  Â  Â  Â  <i class="fas fa-spinner fa-spin mr-3"></i> Conectando...
Â  Â  </div>

Â  Â  <!-- Tela de Login -->
Â  Â  <div id="auth-overlay">
Â  Â  Â  Â  <div class="w-full max-w-sm p-8 space-y-6 bg-[#1a173a] rounded-lg shadow-xl border border-indigo-800">
Â  Â  Â  Â  Â  Â  <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Logo" class="w-48 mx-auto">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-center text-white">Login</h2>

Â  Â  Â  Â  Â  Â  <div id="auth-error" class="hidden p-3 text-sm text-red-300 bg-red-800/50 border border-red-700 rounded-lg"></div>

Â  Â  Â  Â  Â  Â  <!-- FormulÃ¡rio de Login -->
Â  Â  Â  Â  Â  Â  <form id="login-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="login-email" class="block text-sm font-medium text-gray-400">Email</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="login-password" class="block text-sm font-medium text-gray-400">Senha</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-8">Entrar</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- ConteÃºdo Principal do App (ComeÃ§a escondido) -->
Â  Â  <div id="app-container" class="container mx-auto p-4 md:p-8">

Â  Â  Â  Â  <!-- ***** HEADER RESTAURADO AO ORIGINAL ***** -->
Â  Â  Â  Â  <header class="mb-6 header-with-logo">
Â  Â  Â  Â  Â  Â  <!-- Bloco Esquerdo: TÃ­tulo e DescriÃ§Ã£o -->
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-white">Painel de GestÃ£o</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400">Controle Financeiro e de ProduÃ§Ã£o do EscritÃ³rio</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Bloco Direito: UsuÃ¡rio e Logout (CLASSE ADICIONADA AQUI) -->
Â  Â  Â  Â  Â  Â  <div class="flex items-center header-user-block">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="user-display-name" class="text-sm text-gray-300 font-medium mr-4"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg shadow-md text-sm flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-sign-out-alt"></i> Sair
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <!-- Logo (flutuante) -->
Â  Â  Â  Â  Â  Â  <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Fabris e GurjÃ£o Logo" class="header-logo">
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <!-- ***** FIM DO HEADER RESTAURADO ***** -->


Â  Â  Â  Â  <div class="border-b border-gray-700 mb-8">
Â  Â  Â  Â  Â  Â  <!-- Nav ajustada com justify-between e items-center -->
Â  Â  Â  Â  Â  Â  <!-- Container flex para a barra de navegaÃ§Ã£o -->
Â  Â  Â  Â  Â  Â  <nav class="flex justify-between items-center -mb-px">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Tabs Principais (esquerda) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="nav-tab active">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-tachometer-alt mr-2"></i>Painel Principal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a onclick="window.App.showPage('page-inadimplentes')" id="tab-inadimplentes" class="nav-tab">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-exclamation-triangle mr-2"></i>Inadimplentes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="nav-tab">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-tasks mr-2"></i>ServiÃ§os
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Ãcone da Lixeira (direita) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- A lixeira Ã© visÃ­vel para todos para restaurar seus prÃ³prios itens, mas admins podem excluir perm -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="nav-tab-icon" title="Lixeira">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash-alt"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- ConteÃºdo da PÃ¡gina: Painel Principal -->
Â  Â  Â  Â  <div id="page-dashboard">
Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-4 mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-plus-circle"></i> Novo Contrato
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <!-- BotÃµes apenas para admin -->
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.openReportModal()" class="admin-only bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-chart-line"></i> RelatÃ³rio Mensal
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.showPage('page-analytics')" class="admin-only bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-chart-bar"></i> Ver GrÃ¡ficos
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- Cards serÃ£o preenchidos via JS -->
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">A Receber (PrÃ³x. 30 dias)</h3><p id="dash-a-receber" class="text-3xl font-bold text-green-400"></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">Vencido (Corrigido)</h3><p id="dash-vencido" class="text-3xl font-bold text-red-400"></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">Recebido (Este MÃªs)</h3><p id="dash-recebido" class="text-3xl font-bold text-indigo-400"></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">Meus Contratos Ativos</h3><p id="dash-contratos" class="text-3xl font-bold text-white"></p></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mb-4 border-b border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h2 class="text-2xl font-semibold mb-4 text-white">SituaÃ§Ã£o das Parcelas (Meus Contratos)</h2>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="kanban-board" class="flex overflow-x-auto space-x-4 pb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i>Vencidas</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="kanban-vencidas" class="kanban-content space-y-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg mb-4 text-yellow-400 flex items-center gap-2"><i class="far fa-clock"></i>A Vencer (PrÃ³x. 30 dias)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="kanban-a-vencer" class="kanban-content space-y-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg mb-4 text-gray-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>Pagas (Este MÃªs)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="kanban-pagas" class="kanban-content space-y-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg mb-4 text-indigo-400 flex items-center gap-2"><i class="fas fa-gavel"></i>Aguardando ÃŠxito</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="kanban-exito" class="kanban-content space-y-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-white">Meus Contratos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.exportContractsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-csv"></i> Exportar (CSV)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtro de advogado (visÃ­vel para admin) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-sm text-gray-400">Ordenar por:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="contractSortButtons" class="flex gap-1"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="searchInput" onkeyup="window.App.resetAndRenderContractList()" placeholder="ðŸ”Ž Pesquisar por cliente ou tipo de serviÃ§o..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="contractListContainer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="loadMoreContainer" class="text-center mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.loadMoreContracts()" id="loadMoreButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all flex items-center gap-2 mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-plus"></i> Carregar Mais
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ConteÃºdo da PÃ¡gina: Inadimplentes -->
Â  Â  Â  Â  <div id="page-inadimplentes" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-white">Controle de Inadimplentes (Meus Contratos)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-400">Ordenar por:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="inadimplentesSortButtons" class="flex gap-1"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="inadimplentesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ConteÃºdo da PÃ¡gina: Controle de ServiÃ§os -->
Â  Â  Â  Â  <div id="page-servicos" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h2 class="text-2xl font-semibold text-white">Controle de ProduÃ§Ã£o de ServiÃ§os (Meus Contratos)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtro de advogado (visÃ­vel para admin) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-400">Ordenar por:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="servicosSortButtons" class="flex gap-1"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="servicosSearchInput" onkeyup="window.App.renderServicosPage()" placeholder="ðŸ”Ž Pesquisar..." class="w-full md:w-auto p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <div id="servicosListContainer" class="space-y-6"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ConteÃºdo da PÃ¡gina: AnÃ¡lise GrÃ¡fica (Admin Only) -->
Â  Â  Â  Â  <div id="page-analytics" class="hidden admin-only">
Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-white">AnÃ¡lise GrÃ¡fica</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="analyticsPeriodFilter" class="flex gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.setAnalyticsPeriod('12m')" class="filter-button active" data-period="12m">Ãšltimos 12 Meses</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.setAnalyticsPeriod('thisYear')" class="filter-button" data-period="thisYear">Este Ano</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.setAnalyticsPeriod('lastYear')" class="filter-button" data-period="lastYear">Ano Passado</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card p-6 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold text-white mb-4">Recebimentos Totais</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-96">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="faturamentoChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card p-6 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold text-white mb-4">ProduÃ§Ã£o (Novos Contratos)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-96">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="producaoChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ConteÃºdo da PÃ¡gina: Lixeira -->
Â  Â  Â  Â  <div id="page-lixeira" class="hidden">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-white">Lixeira de Contratos</h2>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p class="text-gray-400 mb-6">Contratos excluÃ­dos sÃ£o mantidos aqui. VocÃª pode restaurÃ¡-los ou excluÃ­-los permanentemente (apenas admins).</p>
Â  Â  Â  Â  Â  Â  <div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modais -->
Â  Â  <!-- Modal: Adicionar Nome -->
Â  Â  <div id="modalDisplayName" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo(a)!</h2>
Â  Â  Â  Â  Â  Â  <p class="text-gray-400 mb-4">Percebemos que Ã© seu primeiro acesso. Como vocÃª gostaria de ser chamado(a)?</p>
Â  Â  Â  Â  Â  Â  <form id="formDisplayName">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="inputDisplayName" class="block text-sm font-medium text-gray-400">Seu Nome de ExibiÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="inputDisplayName" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar e Entrar</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal: Contrato -->
Â  Â  <div id="modalContrato" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="modalContratoTitle" class="text-2xl font-bold text-white">Cadastrar Novo Contrato</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="formContrato">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="contractId">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="clienteNome" class="block text-sm font-medium text-gray-400">Nome do Cliente</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="clienteNome" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="advogadoResponsavel" class="block text-sm font-medium text-gray-400">Advogado ResponsÃ¡vel</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="advogadoResponsavel" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- OpÃ§Ãµes preenchidas via JS -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-400">Adicionar ServiÃ§os</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="servicosContainerWrapper" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="servicosContainer" class="flex flex-wrap items-center gap-1 w-full mb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="contratoServicoInput" class="flex-grow outline-none bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="Nome do ServiÃ§o...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="contratoPrazoInput" class="bg-gray-800 border border-gray-600 rounded-md shadow-sm text-gray-400 px-3 py-2" style="color-scheme: dark;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="addServiceButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Adicionar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="contratoTipoPagamento" class="block text-sm font-medium text-gray-400">Modalidade de Pagamento</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="contratoTipoPagamento" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>Parcelado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>PrÃ³-Abono</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option>Entrada Ãºnica</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="contratoObservacoes" class="block text-sm font-medium text-gray-400">ObservaÃ§Ãµes</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="contratoObservacoes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="Detalhes da negociaÃ§Ã£o, informaÃ§Ãµes do caso, etc..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Campos financeiros (Admin Only) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="admin-only">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4 text-white">Detalhes Financeiros</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="valorTotal" class="block text-sm font-medium text-gray-400">Valor Fixo Total (R$)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="valorTotal" placeholder="0 se for sÃ³ Ãªxito" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="numParcelas" class="block text-sm font-medium text-gray-400">NÂ° de Parcelas</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="numParcelas" placeholder="1 para 'Ã€ Vista'" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" value="1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="vencimentoPrimeiraParcela" class="block text-sm font-medium text-gray-400">Vencimento da 1Âª Parcela</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="vencimentoPrimeiraParcela" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" style="color-scheme: dark;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="taxaExito" class="block text-sm font-medium text-gray-400">Taxa de ÃŠxito (BonificaÃ§Ã£o)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="taxaExito" placeholder="Ex: 20%, 10000, 5 SALARIOS" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal: Pagamento -->
Â  Â  <div id="modalPagamento" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
Â  Â  Â  Â  Â <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white">Registrar Pagamento</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="formPagamento">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded-md text-white"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="pagamentoValor" class="block text-sm font-medium text-gray-400">Valor Pago (R$)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="pagamentoValor" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="pagamentoData" class="block text-sm font-medium text-gray-400">Data do Pagamento</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="pagamentoData" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required style="color-scheme: dark;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="pagamentoContractId">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="pagamentoParcelIndex">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar Pagamento</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal: Cliente -->
Â  Â  <div id="modalCliente" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3">
Â  Â  Â  Â  Â <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="clienteModalTitle" class="text-2xl font-bold text-white"></h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="clienteModalContent" class="space-y-6"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal: RelatÃ³rio (Admin Only) -->
Â  Â  <div id="modalRelatorio" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5 admin-only">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white">RelatÃ³rio Financeiro Mensal</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex gap-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="reportMonth" class="block text-sm font-medium text-gray-400">MÃªs</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="reportMonth" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="reportYear" class="block text-sm font-medium text-gray-400">Ano</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="reportYear" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <div class="flex gap-4 mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Gerar RelatÃ³rio</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Exportar (CSV)</button>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  <div id="reportResult" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- O conteÃºdo serÃ¡ injetado aqui pela generateAndShowReport -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal: ÃŠxito -->
Â  Â  <div id="modalExito" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white">Registrar Recebimento de ÃŠxito</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="formExito">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded-md"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- Campo de valor apenas para admin -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4 admin-only">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="exitoValorRecebido" class="block text-sm font-medium text-gray-400">Valor LÃ­quido Recebido (R$)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="exitoValorRecebido" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" placeholder="Ex: 9500.00" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <!-- Texto para nÃ£o-admin -->
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="mb-4 text-gray-400 non-admin-hidden">Confirme o recebimento do valor de Ãªxito.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="exitoContractId">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Recebimento</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modal-backdrop" class="modal-backdrop"></div>

Â  Â  <script type="module">
Â  Â  Â  Â  // --- Firebase Imports ---
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

Â  Â  Â  Â  // --- Global App Object ---
Â  Â  Â  Â  window.App = {};

Â  Â  Â  Â  // --- Global Variables ---
Â  Â  Â  Â  let db, auth, contractsCollection;
Â  Â  Â  Â  let database = { contracts: [] };
Â  Â  Â  Â  let currentContractSort = 'name-asc';
Â  Â  Â  Â  let currentInadimplentesSort = 'days-desc';
Â  Â  Â  Â  let currentServicosSort = 'name-asc';
Â  Â  Â  Â  let ipcaCache = new Map();
Â  Â  Â  Â  let faturamentoChartInstance = null;
Â  Â  Â  Â  let producaoChartInstance = null;
Â  Â  Â  Â  let backdrop;
Â  Â  Â  Â  let contractListPage = 0;
Â  Â  Â  Â  const CONTRACTS_PER_PAGE = 30;
Â  Â  Â  Â  const ADMIN_USERS = ["Dra. Renata Fabris", "Dr. Felipe GurjÃ£o", "D'Arc"]; // Usernames dos admins
Â  Â  Â  Â  let currentUserDisplayName = null;
Â  Â  Â  Â  let isUserAdmin = false;
Â  Â  Â  Â  let currentAnalyticsPeriod = '12m';

Â  Â  Â  Â  // --- Initialization and Authentication ---
Â  Â  Â  Â  async function initializeAndAuth() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const firebaseConfig = { /* Sua config do Firebase aqui */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authDomain: "fabrisgurjao.firebaseapp.com",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectId: "fabrisgurjao",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  storageBucket: "fabrisgurjao.firebasestorage.app",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messagingSenderId: "466702265991",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appId: "1:466702265991:web:78c4d98b47cab537921222",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  measurementId: "G-E99R5TFMQK"
Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'fabrisgurjao-app';
Â  Â  Â  Â  Â  Â  Â  Â  const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '' && __firebase_config !== '{{ SCRIPT_DATA.firebase_config }}')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? JSON.parse(__firebase_config) : firebaseConfig;

Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(finalConfig);
Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  Â  Â  setLogLevel('debug');

Â  Â  Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadingOverlay = document.getElementById('loading-overlay');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const authOverlay = document.getElementById('auth-overlay');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const appContainer = document.getElementById('app-container');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserDisplayName = user.displayName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isUserAdmin = ADMIN_USERS.includes(currentUserDisplayName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.toggle('is-admin', isUserAdmin); // Adiciona/remove classe no body

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!user.displayName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Primeiro login detectado.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openModal('modalDisplayName');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("UsuÃ¡rio logado:", user.displayName, "Ã‰ admin?", isUserAdmin);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-display-name').textContent = user.displayName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupUIAccess(isUserAdmin);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractsCollection = collection(db, `contracts`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSnapshotListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Nenhum usuÃ¡rio logado.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserDisplayName = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isUserAdmin = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('is-admin');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authOverlay.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro na inicializaÃ§Ã£o:", error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-overlay').textContent = "Erro ao conectar.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupUIAccess(isAdmin) {
Â  Â  Â  Â  Â  Â  // Ajusta visibilidade de botÃµes e inputs financeiros
Â  Â  Â  Â  Â  Â  Â const advogadoFilters = [
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('advogadoFilter'),
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('servicosAdvogadoFilter')
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â advogadoFilters.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  if (select) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.disabled = !isAdmin;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.value = isAdmin ? 'Todos' : currentUserDisplayName;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â // Habilita/desabilita campos no modal de contrato
Â  Â  Â  Â  Â  Â  Â const financialFields = ['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'taxaExito'];
Â  Â  Â  Â  Â  Â  Â financialFields.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const field = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (field) field.disabled = !isAdmin;
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  // Popula o select de advogado no modal de contrato
Â  Â  Â  Â  Â  Â  populateAdvogadoSelectModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupSnapshotListener() {
Â  Â  Â  Â  Â  Â  onSnapshot(contractsCollection, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  database.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  contractListPage = 0;
Â  Â  Â  Â  Â  Â  Â  Â  render(); // Re-renderiza a view atual com os novos dados
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao buscar dados:", error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Navigation and Rendering ---
Â  Â  Â  Â  const getFilteredContracts = (includeDeleted = false) => {
Â  Â  Â  Â  Â  Â  const allContracts = database.contracts;
Â  Â  Â  Â  Â  Â  if (isUserAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  return allContracts.filter(c => includeDeleted ? true : !c.isDeleted);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return allContracts.filter(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const isOwner = c.advogadoResponsavel === currentUserDisplayName;
Â  Â  Â  Â  Â  Â  Â  Â  const isNotDeleted = includeDeleted ? true : !c.isDeleted;
Â  Â  Â  Â  Â  Â  Â  Â  return isOwner && isNotDeleted;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const showPage = (pageId) => {
Â  Â  Â  Â  Â  Â  // Esconde todas as pÃ¡ginas e desativa tabs
Â  Â  Â  Â  Â  Â  ['page-dashboard', 'page-inadimplentes', 'page-servicos', 'page-analytics', 'page-lixeira'].forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (el) el.classList.add('hidden');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  ['tab-dashboard', 'tab-inadimplentes', 'tab-servicos', 'tab-lixeira'].forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const tab = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (tab) tab.classList.remove('active');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Mostra a pÃ¡gina clicada (respeitando admin-only se necessÃ¡rio)
Â  Â  Â  Â  Â  Â  const targetPage = document.getElementById(pageId);
Â  Â  Â  Â  Â  Â  if (targetPage) {
Â  Â  Â  Â  Â  Â  Â  Â  if(targetPage.classList.contains('admin-only') && !isUserAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Acesso negado a ", pageId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Opcional: redirecionar para dashboard ou mostrar mensagem
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showPage('page-dashboard'); // Volta pro dashboard
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  targetPage.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Ativa a tab correspondente
Â  Â  Â  Â  Â  Â  const tabId = `tab-${pageId.split('-')[1]}`;
Â  Â  Â  Â  Â  Â  const targetTab = document.getElementById(tabId);
Â  Â  Â  Â  Â  Â  if (targetTab) targetTab.classList.add('active');

Â  Â  Â  Â  Â  Â  // Renderiza o conteÃºdo especÃ­fico da pÃ¡gina
Â  Â  Â  Â  Â  Â  const filteredData = getFilteredContracts(false);
Â  Â  Â  Â  Â  Â  const allFilteredData = getFilteredContracts(true); // Para lixeira

Â  Â  Â  Â  Â  Â  if (pageId === 'page-dashboard') {
Â  Â  Â  Â  Â  Â  Â  Â  renderKanban(filteredData);
Â  Â  Â  Â  Â  Â  Â  Â  renderContractList(true);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-inadimplentes') {
Â  Â  Â  Â  Â  Â  Â  Â  renderInadimplentesPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-servicos') {
Â  Â  Â  Â  Â  Â  Â  Â  renderServicosPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-analytics' && isUserAdmin) { // SÃ³ renderiza se for admin
Â  Â  Â  Â  Â  Â  Â  Â  renderAnalyticsPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-lixeira') {
Â  Â  Â  Â  Â  Â  Â  Â  renderLixeiraPage(allFilteredData); // Lixeira usa dados incluindo deletados
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.showPage = showPage;

Â  Â  Â  Â  async function render() {
Â  Â  Â  Â  Â  Â  // Garante que o render sÃ³ aconteÃ§a se o app estiver visÃ­vel
Â  Â  Â  Â  Â  Â  if (document.getElementById('app-container').style.display !== 'block') return;

Â  Â  Â  Â  Â  Â  const filteredData = getFilteredContracts(false);
Â  Â  Â  Â  Â  Â  const allFilteredData = getFilteredContracts(true); // Para lixeira
Â  Â  Â  Â  Â  Â  const currentPage = document.querySelector('div[id^="page-"]:not(.hidden)');

Â  Â  Â  Â  Â  Â  if (!currentPage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showPage('page-dashboard'); // Default page
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const pageId = currentPage.id;

Â  Â  Â  Â  Â  Â  // Re-renderiza a pÃ¡gina ativa
Â  Â  Â  Â  Â  Â  if (pageId === 'page-dashboard') {
Â  Â  Â  Â  Â  Â  Â  Â  await renderKanban(filteredData);
Â  Â  Â  Â  Â  Â  Â  Â  renderContractList(); // NÃ£o reseta a paginaÃ§Ã£o aqui
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-inadimplentes') {
Â  Â  Â  Â  Â  Â  Â  Â  await renderInadimplentesPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-servicos') {
Â  Â  Â  Â  Â  Â  Â  Â  renderServicosPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-analytics' && isUserAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  renderAnalyticsPage(filteredData);
Â  Â  Â  Â  Â  Â  } else if (pageId === 'page-lixeira') {
Â  Â  Â  Â  Â  Â  Â  Â  renderLixeiraPage(allFilteredData);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  renderSortButtons();
Â  Â  Â  Â  Â  Â  renderAdvogadoFilters(); // Atualiza os filtros de advogado
Â  Â  Â  Â  }

Â  Â  Â  Â  async function renderKanban(contractsToRender) {
Â  Â  Â  Â  Â  Â  Â const kanbanVencidas = document.getElementById('kanban-vencidas');
Â  Â  Â  Â  Â  Â  Â const kanbanAVencer = document.getElementById('kanban-a-vencer');
Â  Â  Â  Â  Â  Â  Â const kanbanPagas = document.getElementById('kanban-pagas');
Â  Â  Â  Â  Â  Â  Â const kanbanExito = document.getElementById('kanban-exito');

Â  Â  Â  Â  Â  Â  Â kanbanVencidas.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â kanbanAVencer.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â kanbanPagas.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â kanbanExito.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
Â  Â  Â  Â  Â  Â  Â const trintaDiasFrente = new Date(); trintaDiasFrente.setDate(hoje.getDate() + 30);

Â  Â  Â  Â  Â  Â  Â let totalAVencer30dias = 0;
Â  Â  Â  Â  Â  Â  Â let totalVencido = 0;
Â  Â  Â  Â  Â  Â  Â const vencidasPromises = [];

Â  Â  Â  Â  Â  Â  Â for (const contract of contractsToRender) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!contract.parcels) contract.parcels = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â let remainingValue = isUserAdmin ? contract.parcels.reduce((sum, p) => p.status === 'Pendente' ? sum + p.value : sum, 0) : 0; // SÃ³ calcula se for admin

Â  Â  Â  Â  Â  Â  Â  Â  Â for (let i = 0; i < contract.parcels.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const parcel = contract.parcels[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const vencimento = new Date(parcel.dueDate);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (parcel.status === 'Paga') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const dataPagamento = new Date(parcel.paymentDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(dataPagamento >= primeiroDiaMes && dataPagamento <= hoje) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â kanbanPagas.innerHTML += createParcelCard(contract, parcel, i, 'paga', remainingValue);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (vencimento < hoje) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â vencidasPromises.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â calcularValorCorrigido(parcel.value, parcel.dueDate).then(valorCorrigido => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) totalVencido += valorCorrigido; // SÃ³ soma se for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return createParcelCard(contract, parcel, i, 'vencida', remainingValue, valorCorrigido);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (vencimento >= hoje && vencimento <= trintaDiasFrente) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â kanbanAVencer.innerHTML += createParcelCard(contract, parcel, i, 'a-vencer', remainingValue);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) totalAVencer30dias += parcel.value; // SÃ³ soma se for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â // Mostra card de Ãªxito mesmo para nÃ£o-admin, mas sem valor no modal se nÃ£o for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â if (contract.successFee && !contract.successFeePaymentDate && (contract.parcels || []).every(p => p.status === 'Paga')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â kanbanExito.innerHTML += createExitoCard(contract);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const vencidasHtml = await Promise.all(vencidasPromises);
Â  Â  Â  Â  Â  Â  Â kanbanVencidas.innerHTML = vencidasHtml.join('');

Â  Â  Â  Â  Â  Â  Â const totalPagoMes = isUserAdmin ? calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), contractsToRender).totalGeral : 0; // SÃ³ calcula se for admin
Â  Â  Â  Â  Â  Â  Â renderDashboard(totalAVencer30dias, totalVencido, totalPagoMes, contractsToRender.length);
Â  Â  Â  Â  }

Â  Â  Â  Â  function createParcelCard(contract, parcel, index, type, remainingValue, valorCorrigido = null) {
Â  Â  Â  Â  Â  Â  const vencimento = new Date(parcel.dueDate);
Â  Â  Â  Â  Â  Â  const formattedDate = vencimento.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
Â  Â  Â  Â  Â  Â  const formattedValue = isUserAdmin ? parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  const formattedRemaining = isUserAdmin ? remainingValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  const formattedCorrigido = isUserAdmin && valorCorrigido ? valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';

Â  Â  Â  Â  Â  Â  let actionButton = '';
Â  Â  Â  Â  Â  Â  let statusClass = '';
Â  Â  Â  Â  Â  Â  let valorHtml = '';

Â  Â  Â  Â  Â  Â  Â if (type === 'vencida') {
Â  Â  Â  Â  Â  Â  Â  Â  Â statusClass = 'border-red-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â valorHtml = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center text-gray-400 text-xs"><strong>Original:</strong><span class="ml-auto font-medium line-through">${formattedValue}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center text-red-400"><strong>Corrigido:</strong><span class="ml-auto font-semibold text-lg">${formattedCorrigido}</span></div>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : `<div class="text-red-400 font-semibold">Vencida</div>`;
Â  Â  Â  Â  Â  Â  Â } else if (type === 'a-vencer') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  statusClass = 'border-yellow-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  valorHtml = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : `<div class="text-yellow-400 font-semibold">A vencer</div>`;
Â  Â  Â  Â  Â  Â  Â } else { // Paga
Â  Â  Â  Â  Â  Â  Â  Â  Â  statusClass = 'border-gray-600';
Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedPaidValue = isUserAdmin ? (parcel.valuePaid || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  Â  Â  Â  const paymentDate = new Date(parcel.paymentDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
Â  Â  Â  Â  Â  Â  Â  Â  Â  valorHtml = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : ''; // NÃ£o mostra valor se nÃ£o for admin e jÃ¡ estiver pago
Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<div class="mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded-md font-medium">Pago ${isUserAdmin ? formattedPaidValue : ''} em ${paymentDate}</div>`;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  // BotÃ£o de pagamento visÃ­vel para todos, mas modal nÃ£o terÃ¡ valor se nÃ£o for admin
Â  Â  Â  Â  Â  Â  if (type !== 'paga') {
Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-check"></i> Registrar Pagamento</button>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // InformaÃ§Ã£o extra de valor apenas para admin
Â  Â  Â  Â  Â  Â  let extraInfoHtml = isUserAdmin ? `<div class="text-xs text-gray-400 border-t border-gray-700 pt-2 mt-3 flex justify-between"><span>Contrato: <strong>${(contract.totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></span> <span>Restante: <strong>${formattedRemaining}</strong></span></div>` : '';

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card p-4 rounded-lg shadow-md border-l-4 ${statusClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-white">${contract.clientName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')} - Parcela ${parcel.number}/${contract.parcels.length || 1}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-2 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${valorHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-calendar-alt w-5 text-center mr-2 text-gray-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Vencimento:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ml-auto font-medium">${formattedDate}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${extraInfoHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function createExitoCard(contract) {
Â  Â  Â  Â  Â  Â  Â const taxaExitoDisplay = isUserAdmin ? contract.successFee : '[Restrito]';
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-white">${contract.clientName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="my-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400">BonificaÃ§Ã£o Pendente</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl font-semibold text-indigo-400">${taxaExitoDisplay}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.openExitoModal('${contract.id}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-gavel"></i> Registrar Recebimento</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderDashboard(aVencer, vencido, pago, totalContratos) {
Â  Â  Â  Â  Â  Â  // Atualiza apenas os cards que devem ser mostrados
Â  Â  Â  Â  Â  Â  Â document.getElementById('dash-a-receber').textContent = aVencer.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
Â  Â  Â  Â  Â  Â  Â document.getElementById('dash-vencido').textContent = vencido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
Â  Â  Â  Â  Â  Â  Â document.getElementById('dash-recebido').textContent = pago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
Â  Â  Â  Â  Â  Â  Â document.getElementById('dash-contratos').textContent = totalContratos; // Total de contratos do usuÃ¡rio (ou todos para admin)
Â  Â  Â  Â  }

Â  Â  Â  Â  const resetAndRenderContractList = function() {
Â  Â  Â  Â  Â  Â  contractListPage = 0;
Â  Â  Â  Â  Â  Â  renderContractList(true);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.resetAndRenderContractList = resetAndRenderContractList;

Â  Â  Â  Â  const renderContractList = function(resetList = false) {
Â  Â  Â  Â  Â  Â  const listContainer = document.getElementById('contractListContainer');
Â  Â  Â  Â  Â  Â  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
Â  Â  Â  Â  Â  Â  const advogadoFilterEl = document.getElementById('advogadoFilter');
Â  Â  Â  Â  Â  Â  const loadMoreContainer = document.getElementById('loadMoreContainer');

Â  Â  Â  Â  Â  Â  let advogadoFilter = advogadoFilterEl.value;
Â  Â  Â  Â  Â  Â  if (!isUserAdmin) advogadoFilter = currentUserDisplayName;

Â  Â  Â  Â  Â  Â  let filteredContracts = getFilteredContracts(false).filter(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const matchesAdvogado = (isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
Â  Â  Â  Â  Â  Â  Â  Â  const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
Â  Â  Â  Â  Â  Â  Â  Â  return matchesAdvogado && matchesSearch;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // OrdenaÃ§Ã£o
Â  Â  Â  Â  Â  Â  if (currentContractSort === 'name-asc') {
Â  Â  Â  Â  Â  Â  Â  Â  filteredContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
Â  Â  Â  Â  Â  Â  } else if (currentContractSort === 'value-desc' && isUserAdmin) { // Ordenar por valor sÃ³ para admin
Â  Â  Â  Â  Â  Â  Â  Â  filteredContracts.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // PaginaÃ§Ã£o
Â  Â  Â  Â  Â  Â  const startIndex = 0;
Â  Â  Â  Â  Â  Â  const endIndex = (contractListPage + 1) * CONTRACTS_PER_PAGE;
Â  Â  Â  Â  Â  Â  const paginatedContracts = filteredContracts.slice(startIndex, endIndex);

Â  Â  Â  Â  Â  Â  loadMoreContainer.style.display = filteredContracts.length > paginatedContracts.length ? 'block' : 'none';

Â  Â  Â  Â  Â  Â  if (paginatedContracts.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.innerHTML = '<div class="dark-card p-4 rounded-lg shadow-md text-center text-gray-400 py-4">Nenhum contrato encontrado.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (resetList || contractListPage === 0) listContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
Â  Â  Â  Â  Â  Â  paginatedContracts.forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  const { statusText, statusColor, borderColor } = getContractStatus(contract);
Â  Â  Â  Â  Â  Â  Â  Â  let servicesHtml = (contract.serviceTypes || []).map(s => `<span class="service-tag-small">${s.name}</span>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â const valorFixoDisplay = isUserAdmin ? (contract.totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  Â  Â  Â const exitoDisplay = isUserAdmin && contract.successFee ? contract.successFee : (contract.successFee ? '[Restrito]' : '');

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card rounded-lg shadow-lg overflow-hidden border-l-4 ${borderColor} flex flex-col justify-between transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-xl text-white">${contract.clientName}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${statusText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-indigo-300 mb-3"><i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">${servicesHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-t border-gray-700 pt-4 space-y-3 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Valor Fixo:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ml-auto font-medium">${valorFixoDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${contract.successFee ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-star w-5 text-center mr-2 text-gray-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ÃŠxito:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ml-auto font-medium text-indigo-400">${exitoDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-900/50 px-4 py-2 flex justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.App.openClientHistoryModal('${contract.clientName}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-indigo-400 hover:bg-indigo-900/20 py-1 px-3 rounded-md transition-colors" title="Ver HistÃ³rico do Cliente"><i class="fas fa-eye"></i> HistÃ³rico</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.App.openContractModal('${contract.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-green-400 hover:bg-green-900/20 py-1 px-3 rounded-md transition-colors" title="Editar Contrato"><i class="fas fa-pencil-alt"></i> Editar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.App.moveToLixeira('${contract.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-red-400 hover:bg-red-900/20 py-1 px-3 rounded-md transition-colors" title="Mover para Lixeira"><i class="fas fa-trash-alt"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  listContainer.innerHTML = html;
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.renderContractList = renderContractList;

Â  Â  Â  Â  const loadMoreContracts = function() {
Â  Â  Â  Â  Â  Â  contractListPage++;
Â  Â  Â  Â  Â  Â  renderContractList(false);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.loadMoreContracts = loadMoreContracts;

Â  Â  Â  Â  function getContractStatus(contract) {
Â  Â  Â  Â  Â  Â  Â const hasPendingParcels = (contract.parcels || []).some(p => p.status === 'Pendente');
Â  Â  Â  Â  Â  Â  Â if (hasPendingParcels) return { statusText: 'Ativo', statusColor: 'bg-yellow-900/50 text-yellow-300', borderColor: 'border-yellow-500' };
Â  Â  Â  Â  Â  Â  Â if (contract.successFee && !contract.successFeePaymentDate) return { statusText: 'Aguardando ÃŠxito', statusColor: 'bg-indigo-900/50 text-indigo-300', borderColor: 'border-indigo-500' };
Â  Â  Â  Â  Â  Â  Â return { statusText: 'ConcluÃ­do', statusColor: 'bg-gray-700 text-gray-300', borderColor: 'border-gray-600' };
Â  Â  Â  Â  }

Â  Â  Â  Â  async function renderInadimplentesPage(contractsToRender) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('inadimplentesListContainer');
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-indigo-400"></i><p class="mt-2 text-sm text-gray-400">Calculando...</p></div>`;
Â  Â  Â  Â  Â  Â  const hoje = new Date(); hoje.setHours(0, 0, 0, 0);

Â  Â  Â  Â  Â  Â  let inadimplentesList = [];
Â  Â  Â  Â  Â  Â  const promises = contractsToRender.map(async (contract) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!contract.parcels) return [];
Â  Â  Â  Â  Â  Â  Â  Â  const contractInadimplencias = [];
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < contract.parcels.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parcel = contract.parcels[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const vencimento = new Date(parcel.dueDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parcel.status === 'Pendente' && vencimento < hoje) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffTime = Math.abs(hoje - vencimento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractInadimplencias.push({ contract, parcel, index: i, diffDays, valorCorrigido });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return contractInadimplencias;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const results = await Promise.all(promises);
Â  Â  Â  Â  Â  Â  inadimplentesList = results.flat();

Â  Â  Â  Â  Â  Â  // OrdenaÃ§Ã£o (mantÃ©m a lÃ³gica, mas os valores sÃ³ serÃ£o exibidos para admins)
Â  Â  Â  Â  Â  Â  if (currentInadimplentesSort === 'days-desc') {
Â  Â  Â  Â  Â  Â  Â  Â  inadimplentesList.sort((a, b) => b.diffDays - a.diffDays);
Â  Â  Â  Â  Â  Â  } else if (currentInadimplentesSort === 'value-desc' && isUserAdmin) { // Ordenar por valor sÃ³ admin
Â  Â  Â  Â  Â  Â  Â  Â  inadimplentesList.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
Â  Â  Â  Â  Â  Â  } else if (currentInadimplentesSort === 'name-asc') {
Â  Â  Â  Â  Â  Â  Â  Â  inadimplentesList.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (inadimplentesList.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block bg-gray-800 border border-gray-700 text-green-400 p-6 rounded-lg shadow-md"><i class="fas fa-check-circle fa-3x mb-3"></i><p class="font-bold text-xl">Nenhuma pendÃªncia encontrada!</p><p class="text-sm text-gray-400">Todos os pagamentos estÃ£o em dia.</p></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let inadimplentesHtml = '';
Â  Â  Â  Â  Â  Â  inadimplentesList.forEach(({ contract, parcel, index, diffDays, valorCorrigido }) => {
Â  Â  Â  Â  Â  Â  Â  Â  const vencimento = new Date(parcel.dueDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â const valorOriginalDisplay = isUserAdmin ? parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  Â  Â  Â const valorCorrigidoDisplay = isUserAdmin ? valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';

Â  Â  Â  Â  Â  Â  Â  Â  inadimplentesHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dark-card p-5 rounded-lg shadow-lg border-l-4 border-red-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg text-white">${contract.clientName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-t border-gray-700 pt-3 mt-3 space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-sm ${!isUserAdmin ? 'hidden' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-400">Valor Original:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-400 line-through">${valorOriginalDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center ${!isUserAdmin ? 'hidden' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-white">Valor Corrigido:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold text-lg text-red-400">${valorCorrigidoDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-gray-400">Venceu em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-300">${vencimento.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Atrasado hÃ¡:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${diffDays} dia(s)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check"></i> Registrar Pagamento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  container.innerHTML = inadimplentesHtml;
Â  Â  Â  Â  }

Â  Â  Â  Â  const renderServicosPage = (contractsToRender) => {
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('servicosListContainer');
Â  Â  Â  Â  Â  Â  Â const searchTerm = document.getElementById('servicosSearchInput').value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â const advogadoFilterEl = document.getElementById('servicosAdvogadoFilter');
Â  Â  Â  Â  Â  Â  Â let advogadoFilter = advogadoFilterEl.value;
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) advogadoFilter = currentUserDisplayName;

Â  Â  Â  Â  Â  Â  Â container.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â let activeContracts = contractsToRender.filter(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const isNotConcluded = getContractStatus(c).statusText !== 'ConcluÃ­do';
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!isNotConcluded) return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â const matchesAdvogado = (isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
Â  Â  Â  Â  Â  Â  Â  Â  Â const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm)) || c.advogadoResponsavel.toLowerCase().includes(searchTerm);
Â  Â  Â  Â  Â  Â  Â  Â  Â return matchesAdvogado && matchesSearch;
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  // OrdenaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â if (currentServicosSort === 'name-asc') {
Â  Â  Â  Â  Â  Â  Â  Â  Â activeContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
Â  Â  Â  Â  Â  Â  Â } else if (currentServicosSort === 'adv-asc') {
Â  Â  Â  Â  Â  Â  Â  Â  Â activeContracts.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â if (activeContracts.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="text-center py-10"><div class="inline-block dark-card text-indigo-400 p-6 rounded-lg shadow-md"><i class="fas fa-coffee fa-3x mb-3"></i><p class="font-bold text-xl">Nenhum contrato ativo encontrado.</p><p class="text-sm text-gray-400">Nenhum resultado para a busca ou todos os trabalhos estÃ£o concluÃ­dos.</p></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â activeContracts.forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const totalServices = (contract.serviceTypes || []).length;
Â  Â  Â  Â  Â  Â  Â  Â  Â let progressValue = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â (contract.serviceTypes || []).forEach(service => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (service.status === 'ConcluÃ­do') progressValue += 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else if (service.status === '50% ConcluÃ­do') progressValue += 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else if (service.status === 'Em Andamento') progressValue += 0.25;
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â const serviceProgress = totalServices > 0 ? (progressValue / totalServices) * 100 : 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â // Barra financeira apenas para admin
Â  Â  Â  Â  Â  Â  Â  Â  Â const totalPaid = (contract.parcels || []).reduce((sum, p) => sum + (p.valuePaid || 0), 0) + (contract.successFeeValueReceived || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â const financialProgress = (contract.totalValue || 0) > 0 ? (totalPaid / contract.totalValue) * 100 : (totalPaid > 0 ? 100 : 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â const financialProgressBar = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso Financeiro</label><span class="font-medium text-teal-300">${financialProgress.toFixed(0)}%</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-teal-500" style="width: ${financialProgress}%"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>` : '';

Â  Â  Â  Â  Â  Â  Â  Â  Â let servicesHtml = (contract.serviceTypes || []).map((service, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let statusHtml, actionsHtml = '', deadlineHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ... (lÃ³gica de deadline e status permanece a mesma) ...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (service.deadline) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hoje = new Date(); hoje.setHours(0,0,0,0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prazo = new Date(service.deadline + "T12:00:00Z");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffTime = prazo - hoje;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedPrazo = prazo.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffDays < 0 && service.status !== 'ConcluÃ­do') deadlineHtml = `<span class="text-xs font-medium text-red-400"><i class="fas fa-exclamation-triangle"></i> Vencido: ${formattedPrazo}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (diffDays <= 7 && service.status !== 'ConcluÃ­do') deadlineHtml = `<span class="text-xs font-medium text-yellow-400"><i class="fas fa-clock"></i> Vence: ${formattedPrazo}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (service.status !== 'ConcluÃ­do') deadlineHtml = `<span class="text-xs text-gray-500"><i class="far fa-calendar-alt"></i> ${formattedPrazo}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else deadlineHtml = `<span class="text-xs text-gray-500"><i class="far fa-calendar-check"></i> ${formattedPrazo}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  switch(service.status) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'ConcluÃ­do': statusHtml = `<span class="text-xs font-bold text-teal-400">CONCLUÃDO</span>`; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case '50% ConcluÃ­do': statusHtml = `<span class="text-xs font-bold text-purple-400">50%</span>`; actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'ConcluÃ­do')" class="text-xs bg-indigo-600 text-white hover:bg-indigo-500 font-semibold py-1 px-2 rounded-md transition-colors">Concluir</button>`; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'Em Andamento': statusHtml = `<span class="text-xs font-bold text-yellow-400">EM ANDAMENTO</span>`; actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, '50% ConcluÃ­do')" class="text-xs bg-purple-600 text-white hover:bg-purple-500 font-semibold py-1 px-2 rounded-md transition-colors">50%</button><button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'ConcluÃ­do')" class="text-xs bg-indigo-600 text-white hover:bg-indigo-500 font-semibold py-1 px-2 rounded-md transition-colors">Concluir</button>`; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default: statusHtml = `<span class="text-xs font-bold text-gray-400">PENDENTE</span>`; actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'Em Andamento')" class="text-xs bg-yellow-600 text-white hover:bg-yellow-500 font-semibold py-1 px-2 rounded-md transition-colors">Iniciar</button>`; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const iconClass = service.status === 'ConcluÃ­do' ? 'fas fa-check-circle text-teal-500' : (service.status === '50% ConcluÃ­do' ? 'fas fa-adjust text-purple-500' : (service.status === 'Em Andamento' ? 'fas fa-spinner fa-spin text-yellow-500' : 'far fa-circle text-gray-500'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const textClass = service.status === 'ConcluÃ­do' ? 'text-gray-500 line-through' : 'text-gray-300';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const hoverClass = service.status !== 'ConcluÃ­do' ? 'hover:bg-gray-700/50' : 'bg-gray-900/50';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return `<li class="flex items-center justify-between p-2 ${hoverClass} rounded-md"><span class="${textClass}"><i class="${iconClass} mr-2"></i>${service.name}</span><div class="flex items-center gap-2">${deadlineHtml}${statusHtml}${actionsHtml}</div></li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â }).join('');

Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-5 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-xl text-indigo-300 mb-4">${contract.clientName}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400"><i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="space-y-4 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${financialProgressBar}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso dos ServiÃ§os</label><span class="font-medium text-indigo-300">${serviceProgress.toFixed(0)}%</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-indigo-500" style="width: ${serviceProgress}%"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="border-t border-gray-700 pt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4 class="font-semibold text-sm mb-2 text-gray-400">ServiÃ§os do Contrato:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <ul class="space-y-1">${servicesHtml}</ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.renderServicosPage = renderServicosPage;

Â  Â  Â  Â  // --- Analytics Functions (Admin Only) ---
Â  Â  Â  Â  function getAnnualChartData(period, contractsToRender) {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return { labels: [], data: [] }; // Retorna vazio se nÃ£o for admin
Â  Â  Â  Â  Â  Â  Â // ... (resto da lÃ³gica como estava) ...
Â  Â  Â  Â  Â  Â  const labels = [], data = [];
Â  Â  Â  Â  Â  Â  const meses = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
Â  Â  Â  Â  Â  Â  const hoje = new Date();
Â  Â  Â  Â  Â  Â  Â if (period === '12m') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 11; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels.push(`${meses[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const income = calculateMonthlyIncome(d.getFullYear(), d.getMonth(), contractsToRender);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.push(income.totalGeral);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (period === 'thisYear') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < 12; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels.push(meses[i]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const income = calculateMonthlyIncome(hoje.getFullYear(), i, contractsToRender);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.push(income.totalGeral);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (period === 'lastYear') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  const lastYear = hoje.getFullYear() - 1;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < 12; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels.push(meses[i]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const income = calculateMonthlyIncome(lastYear, i, contractsToRender);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.push(income.totalGeral);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â return { labels, data };
Â  Â  Â  Â  }

Â  Â  Â  Â  function getAnnualProducaoData(period, contractsToRender) {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return { labels: [], data: [] }; // Retorna vazio se nÃ£o for admin
Â  Â  Â  Â  Â  Â  Â // ... (resto da lÃ³gica como estava) ...
Â  Â  Â  Â  Â  Â  const labels = [], data = [];
Â  Â  Â  Â  Â  Â  const meses = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
Â  Â  Â  Â  Â  Â  const hoje = new Date();
Â  Â  Â  Â  Â  Â  let yearToScan, startRange, endRange;
Â  Â  Â  Â  Â  Â  Â if (period === '12m') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 11; i >= 0; i--) { const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1); labels.push(`${meses[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`); }
Â  Â  Â  Â  Â  Â  Â  Â  Â startRange = new Date(hoje.getFullYear(), hoje.getMonth() - 11, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â endRange = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
Â  Â  Â  Â  Â  Â  } else if (period === 'thisYear') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  yearToScan = hoje.getFullYear(); labels.push(...meses);
Â  Â  Â  Â  Â  Â  Â  Â  Â startRange = new Date(yearToScan, 0, 1); endRange = new Date(yearToScan, 11, 31);
Â  Â  Â  Â  Â  Â  } else if (period === 'lastYear') { /* ... */
Â  Â  Â  Â  Â  Â  Â  Â  yearToScan = hoje.getFullYear() - 1; labels.push(...meses);
Â  Â  Â  Â  Â  Â  Â  Â  Â startRange = new Date(yearToScan, 0, 1); endRange = new Date(yearToScan, 11, 31);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â const monthlyProduction = new Array(12).fill(0);
Â  Â  Â  Â  Â  Â  Â startRange.setHours(0,0,0,0); endRange.setHours(23,59,59,999);
Â  Â  Â  Â  Â  Â  Â contractsToRender.filter(c => c.parcels && c.parcels.length > 0).forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const firstDueDate = new Date(contract.parcels[0].dueDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (firstDueDate >= startRange && firstDueDate <= endRange) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let dataIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (period === '12m') { const monthDiff = (endRange.getFullYear() - firstDueDate.getFullYear()) * 12 + (endRange.getMonth() - firstDueDate.getMonth()); dataIndex = 11 - monthDiff; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else { dataIndex = firstDueDate.getMonth(); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (dataIndex >= 0 && dataIndex < 12) monthlyProduction[dataIndex] += (contract.totalValue || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â return { labels, data: monthlyProduction };
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderAnalyticsPage(contractsToRender) {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return; // NÃ£o renderiza se nÃ£o for admin

Â  Â  Â  Â  Â  Â  Â // ... (lÃ³gica de destroy e criaÃ§Ã£o dos charts como estava) ...
Â  Â  Â  Â  Â  Â  Â const faturamentoData = getAnnualChartData(currentAnalyticsPeriod, contractsToRender);
Â  Â  Â  Â  Â  Â  Â const producaoData = getAnnualProducaoData(currentAnalyticsPeriod, contractsToRender);
Â  Â  Â  Â  Â  Â  Â const ctxFaturamento = document.getElementById('faturamentoChart').getContext('2d');
Â  Â  Â  Â  Â  Â  Â const ctxProducao = document.getElementById('producaoChart').getContext('2d');
Â  Â  Â  Â  Â  Â  Â if (faturamentoChartInstance) faturamentoChartInstance.destroy();
Â  Â  Â  Â  Â  Â  Â if (producaoChartInstance) producaoChartInstance.destroy();
Â  Â  Â  Â  Â  Â  Â Chart.defaults.color = '#9ca3af'; Chart.defaults.borderColor = '#374151';
Â  Â  Â  Â  Â  Â  Â faturamentoChartInstance = new Chart(ctxFaturamento, { type: 'bar', data: { labels: faturamentoData.labels, datasets: [{ label: 'Faturamento Total Recebido', data: faturamentoData.data, backgroundColor: 'rgba(79, 70, 229, 0.6)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { /* ... opÃ§Ãµes ... */ responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') } } }, plugins: { tooltip: { callbacks: { label: (c) => (c.dataset.label || '') + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.parsed.y) } } } } });
Â  Â  Â  Â  Â  Â  Â producaoChartInstance = new Chart(ctxProducao, { type: 'bar', data: { labels: producaoData.labels, datasets: [{ label: 'Valor de Novos Contratos', data: producaoData.data, backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: 'rgba(56, 189, 248, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { /* ... opÃ§Ãµes idÃªnticas ... */ responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: (v) => 'R$ ' + v.toLocaleString('pt-BR') } } }, plugins: { tooltip: { callbacks: { label: (c) => (c.dataset.label || '') + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.parsed.y) } } } } });
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.renderAnalyticsPage = renderAnalyticsPage;

Â  Â  Â  Â  const setAnalyticsPeriod = function(period) {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return; // AÃ§Ã£o apenas para admin
Â  Â  Â  Â  Â  Â  Â currentAnalyticsPeriod = period;
Â  Â  Â  Â  Â  Â  Â document.querySelectorAll('#analyticsPeriodFilter .filter-button').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â document.querySelector(`#analyticsPeriodFilter .filter-button[data-period="${period}"]`).classList.add('active');
Â  Â  Â  Â  Â  Â  Â renderAnalyticsPage(getFilteredContracts(false)); // Re-renderiza com dados filtrados
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.setAnalyticsPeriod = setAnalyticsPeriod;
Â  Â  Â  Â  window.App.setChartPeriod = setAnalyticsPeriod; // Alias

Â  Â  Â  Â  // --- Lixeira Functions ---
Â  Â  Â  Â  function renderLixeiraPage(contractsToRender) {
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('lixeiraListContainer');
Â  Â  Â  Â  Â  Â  Â container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â const deletedContracts = contractsToRender.filter(c => c.isDeleted === true); // Usa os dados jÃ¡ filtrados por permissÃ£o

Â  Â  Â  Â  Â  Â  Â if (deletedContracts.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block dark-card text-gray-400 p-6 rounded-lg shadow-md"><i class="fas fa-trash fa-3x mb-3"></i><p class="font-bold text-xl">Lixeira Vazia</p><p class="text-sm">Nenhum contrato foi excluÃ­do.</p></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â deletedContracts.forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  Â // BotÃ£o de exclusÃ£o permanente apenas para admin
Â  Â  Â  Â  Â  Â  Â  Â  Â const deleteButton = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.App.deleteContractPermanently('${contract.id}')" class="w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <i class="fas fa-times-circle"></i> Excluir Prmt.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>` : '';

Â  Â  Â  Â  Â  Â  Â  Â  Â container.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-5 rounded-lg shadow-lg border-l-4 border-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="font-bold text-lg text-white">${contract.clientName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="border-t border-gray-700 pt-3 mt-3 flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.App.restoreContract('${contract.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <i class="fas fa-undo"></i> Restaurar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${deleteButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderAdvogadoFilters() {
Â  Â  Â  Â  Â  Â  Â // Popula filtros principais (visÃ­veis apenas para admin)
Â  Â  Â  Â  Â  Â  Â const advogados = [...new Set(database.contracts.map(c => c.advogadoResponsavel))].sort();
Â  Â  Â  Â  Â  Â  Â const filterSelects = [document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')];

Â  Â  Â  Â  Â  Â  Â filterSelects.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!select) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â const currentValue = select.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â select.innerHTML = '<option value="Todos">Todos</option>'; // 'Todos' sÃ³ funciona para admin
Â  Â  Â  Â  Â  Â  Â  Â  Â select.add(new Option("NÃ£o Informado", "NÃ£o Informado"));

Â  Â  Â  Â  Â  Â  Â  Â  Â const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe GurjÃ£o", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle GuimarÃ£es", "Dr. Joaquim OcÃ©lio", "Dra. Larissa Mendes"];
Â  Â  Â  Â  Â  Â  Â  Â  Â const allNames = new Set([...fixedNames, ...advogados]);

Â  Â  Â  Â  Â  Â  Â  Â  Â [...allNames].filter(adv => adv && adv !== "NÃ£o Informado" && adv !== "Todos").sort().forEach(adv => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â select.add(new Option(adv, adv));
Â  Â  Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â  Â  Â select.value = isUserAdmin ? (currentValue || 'Todos') : currentUserDisplayName;
Â  Â  Â  Â  Â  Â  Â  Â  Â select.disabled = !isUserAdmin;
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }
Â  Â  Â  Â  // Popula o select de advogado no modal de contrato
Â  Â  Â  Â  function populateAdvogadoSelectModal() {
Â  Â  Â  Â  Â  Â  Â const select = document.getElementById('advogadoResponsavel');
Â  Â  Â  Â  Â  Â  Â if (!select) return;
Â  Â  Â  Â  Â  Â  Â const currentValue = select.value; // Salva o valor atual se estiver editando

Â  Â  Â  Â  Â  Â  Â select.innerHTML = ''; // Limpa antes de popular
Â  Â  Â  Â  Â  Â  Â select.add(new Option("NÃ£o Informado", "NÃ£o Informado"));

Â  Â  Â  Â  Â  Â  Â const advogados = [...new Set(database.contracts.map(c => c.advogadoResponsavel))].sort();
Â  Â  Â  Â  Â  Â  Â const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe GurjÃ£o", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle GuimarÃ£es", "Dr. Joaquim OcÃ©lio", "Dra. Larissa Mendes"];
Â  Â  Â  Â  Â  Â  Â const allNames = new Set([...fixedNames, ...advogados]);

Â  Â  Â  Â  Â  Â  Â [...allNames].filter(adv => adv && adv !== "NÃ£o Informado").sort().forEach(adv => {
Â  Â  Â  Â  Â  Â  Â  Â  Â select.add(new Option(adv, adv));
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â // Restaura o valor ou define o padrÃ£o
Â  Â  Â  Â  Â  Â  Â select.value = currentValue && currentValue !== 'NÃ£o Informado' ? currentValue : (isUserAdmin ? 'NÃ£o Informado' : currentUserDisplayName);
Â  Â  Â  Â  Â  Â  Â select.disabled = !isUserAdmin && !!currentUserDisplayName; // Desabilita se nÃ£o for admin e jÃ¡ tiver um nome
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderSortButtons() {
Â  Â  Â  Â  Â  Â  // ... (LÃ³gica de renderizar botÃµes como estava) ...
Â  Â  Â  Â  Â  Â  Â const contractSortContainer = document.getElementById('contractSortButtons');
Â  Â  Â  Â  Â  Â  Â const inadimplentesSortContainer = document.getElementById('inadimplentesSortButtons');
Â  Â  Â  Â  Â  Â  Â const servicosSortContainer = document.getElementById('servicosSortButtons');
Â  Â  Â  Â  Â  Â  Â if(!contractSortContainer || !inadimplentesSortContainer || !servicosSortContainer) return;
Â  Â  Â  Â  Â  Â  Â contractSortContainer.innerHTML = ''; inadimplentesSortContainer.innerHTML = ''; servicosSortContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â // Contratos: Ordenar por valor sÃ³ para admin
Â  Â  Â  Â  Â  Â  Â const contractSorts = [{ key: 'name-asc', label: 'Nome (A-Z)' }];
Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) contractSorts.push({ key: 'value-desc', label: 'Valor (Maior)' });
Â  Â  Â  Â  Â  Â  Â contractSorts.forEach(sort => { /* ... criar botÃ£o ... */
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentContractSort === sort.key ? 'active' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => { currentContractSort = sort.key; contractListPage = 0; renderContractList(true); renderSortButtons(); };
Â  Â  Â  Â  Â  Â  Â  Â  contractSortContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â // Inadimplentes: Ordenar por valor sÃ³ para admin
Â  Â  Â  Â  Â  Â  Â const inadimplentesSorts = [{ key: 'days-desc', label: 'Mais Antigas' }, { key: 'name-asc', label: 'Nome (A-Z)' }];
Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) inadimplentesSorts.push({ key: 'value-desc', label: 'Maior Valor' });
Â  Â  Â  Â  Â  Â  Â inadimplentesSorts.forEach(sort => { /* ... criar botÃ£o ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentInadimplentesSort === sort.key ? 'active' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â button.onclick = () => { currentInadimplentesSort = sort.key; renderInadimplentesPage(getFilteredContracts(false)); renderSortButtons(); };
Â  Â  Â  Â  Â  Â  Â  Â  Â inadimplentesSortContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â // ServiÃ§os: OrdenaÃ§Ã£o nÃ£o muda
Â  Â  Â  Â  Â  Â  Â const servicosSorts = [{ key: 'name-asc', label: 'Cliente (A-Z)' }, { key: 'adv-asc', label: 'Advogado (A-Z)' }];
Â  Â  Â  Â  Â  Â  Â servicosSorts.forEach(sort => { /* ... criar botÃ£o ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentServicosSort === sort.key ? 'active' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â button.onclick = () => { currentServicosSort = sort.key; renderServicosPage(getFilteredContracts(false)); renderSortButtons(); };
Â  Â  Â  Â  Â  Â  Â  Â  Â servicosSortContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }

Â  Â  Â  Â  const updateServiceStatus = async function(contractId, serviceIndex, newStatus) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  const contract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  Â if (contract && (contract.serviceTypes || [])[serviceIndex]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const updatedServiceTypes = [...contract.serviceTypes];
Â  Â  Â  Â  Â  Â  Â  Â  Â updatedServiceTypes[serviceIndex].status = newStatus;
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractRef = doc(contractsCollection, contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(contractRef, { serviceTypes: updatedServiceTypes });
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.updateServiceStatus = updateServiceStatus;

Â  Â  Â  Â  // --- Lixeira Functions ---
Â  Â  Â  Â  const moveToLixeira = async function(contractId) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  Â if(window.confirm(`Tem certeza que deseja mover o contrato de "${contract.clientName}" para a lixeira?`)){
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractRef = doc(contractsCollection, contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(contractRef, { isDeleted: true });
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.moveToLixeira = moveToLixeira;

Â  Â  Â  Â  const restoreContract = async function(contractId) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â if(window.confirm(`Tem certeza que deseja restaurar este contrato?`)){
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractRef = doc(contractsCollection, contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(contractRef, { isDeleted: false });
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.restoreContract = restoreContract;

Â  Â  Â  Â  const deleteContractPermanently = async function(contractId) {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) { // SÃ³ admin pode excluir permanentemente
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Apenas administradores podem excluir permanentemente.");
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  Â if(window.confirm(`EXCLUSÃƒO PERMANENTE: Tem certeza que deseja apagar o contrato de "${contract.clientName}" para sempre? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)){
Â  Â  Â  Â  Â  Â  Â  Â  Â await deleteDoc(doc(contractsCollection, contractId));
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.deleteContractPermanently = deleteContractPermanently;

Â  Â  Â  Â  // --- Modal Functions ---
Â  Â  Â  Â  const openModal = function(modalId) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const modal = document.getElementById(modalId);
Â  Â  Â  Â  Â  Â  Â  Â  Â if(modal) { modal.style.display = 'block'; modal.style.zIndex = '1000'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â else { console.error("Modal nÃ£o encontrado:", modalId); }
Â  Â  Â  Â  Â  Â  Â  Â  Â if(backdrop) { backdrop.style.display = 'block'; backdrop.style.zIndex = '999'; }
Â  Â  Â  Â  Â  Â  Â }, 0);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openModal = openModal;

Â  Â  Â  Â  const closeModal = function(modalId) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â if(document.getElementById(modalId)) document.getElementById(modalId).style.display = 'none';
Â  Â  Â  Â  Â  Â  Â if(backdrop) backdrop.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.closeModal = closeModal;

Â  Â  Â  Â  const openContractModal = function(contractId = null) {
Â  Â  Â  Â  Â  Â  const form = document.getElementById('formContrato'); form.reset();
Â  Â  Â  Â  Â  Â  const title = document.getElementById('modalContratoTitle');
Â  Â  Â  Â  Â  Â  const servicosContainer = document.getElementById('servicosContainer'); servicosContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  populateAdvogadoSelectModal(); // Popula o select com a lÃ³gica correta
Â  Â  Â  Â  Â  Â  const advogadoSelect = document.getElementById('advogadoResponsavel');

Â  Â  Â  Â  Â  Â  Â if (contractId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â title.textContent = "Editar Contrato";
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('contractId').value = contract.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('clienteNome').value = contract.clientName;
Â  Â  Â  Â  Â  Â  Â  Â  Â advogadoSelect.value = contract.advogadoResponsavel;
Â  Â  Â  Â  Â  Â  Â  Â  Â (contract.serviceTypes || []).forEach(service => createServiceTag(service.name, service.deadline, service.status));
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('contratoTipoPagamento').value = contract.paymentType;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('contratoObservacoes').value = contract.observations;
Â  Â  Â  Â  Â  Â  Â  Â  Â // Campos financeiros (apenas preenche se admin)
Â  Â  Â  Â  Â  Â  Â  Â  Â if (isUserAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('valorTotal').value = contract.totalValue || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('numParcelas').value = (contract.parcels || []).length || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('taxaExito').value = contract.successFee || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if ((contract.parcels || []).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('vencimentoPrimeiraParcela').value = contract.parcels[0].dueDate.split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â title.textContent = "Cadastrar Novo Contrato";
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('contractId').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â // Define advogado padrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â advogadoSelect.value = isUserAdmin ? 'NÃ£o Informado' : currentUserDisplayName;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â // Habilita/desabilita campos financeiros
Â  Â  Â  Â  Â  Â  Â setupUIAccess(isUserAdmin);
Â  Â  Â  Â  Â  Â  Â openModal('modalContrato');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openContractModal = openContractModal;

Â  Â  Â  Â  const openPaymentModal = async function(contractId, parcelIndex) {
Â  Â  Â  Â  Â  Â  const contract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  if (!contract || !contract.parcels || !contract.parcels[parcelIndex]) return;
Â  Â  Â  Â  Â  Â  const parcel = contract.parcels[parcelIndex];

Â  Â  Â  Â  Â  Â  let valorCorrigido = parcel.value;
Â  Â  Â  Â  Â  Â  let infoCorrecao = '';
Â  Â  Â  Â  Â  Â  if (new Date(parcel.dueDate) < new Date()) {
Â  Â  Â  Â  Â  Â  Â  Â  valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate);
Â  Â  Â  Â  Â  Â  Â  Â  if(isUserAdmin) infoCorrecao = `<p class="text-red-400"><strong>Valor Corrigido:</strong> ${valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('pagamentoContractId').value = contractId;
Â  Â  Â  Â  Â  Â  document.getElementById('pagamentoParcelIndex').value = parcelIndex;
Â  Â  Â  Â  Â  Â  const infoDiv = document.getElementById('pagamentoInfo');
Â  Â  Â  Â  Â  Â  Â infoDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Cliente:</strong> ${contract.clientName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Parcela:</strong> ${parcel.number}/${contract.parcels.length}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â ${isUserAdmin ? `<p><strong>Valor Original:</strong> ${parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â ${infoCorrecao}`;

Â  Â  Â  Â  Â  Â  const valorInput = document.getElementById('pagamentoValor');
Â  Â  Â  Â  Â  Â  valorInput.value = isUserAdmin ? valorCorrigido.toFixed(2) : parcel.value.toFixed(2); // Usa original se nÃ£o for admin
Â  Â  Â  Â  Â  Â  valorInput.disabled = !isUserAdmin; // Desabilita valor se nÃ£o for admin

Â  Â  Â  Â  Â  Â  document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  openModal('modalPagamento');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openPaymentModal = openPaymentModal;

Â  Â  Â  Â  const openClientHistoryModal = function(clientName) {
Â  Â  Â  Â  Â  Â  // Usa todos os contratos do cliente, mesmo os de outros advogados (se admin)
Â  Â  Â  Â  Â  Â  Â const clientContracts = (isUserAdmin ? database.contracts : getFilteredContracts(true))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(c => c.clientName === clientName); // Inclui deletados para histÃ³rico
Â  Â  Â  Â  Â  Â  Â const title = document.getElementById('clienteModalTitle'); title.textContent = `HistÃ³rico de ${clientName}`;
Â  Â  Â  Â  Â  Â  Â const content = document.getElementById('clienteModalContent');

Â  Â  Â  Â  Â  Â  Â let totalContratado = 0, totalPago = 0, html = '';

Â  Â  Â  Â  Â  Â  Â clientContracts.forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractValue = contract.totalValue || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) totalContratado += contractValue; // Soma apenas se admin

Â  Â  Â  Â  Â  Â  Â  Â  Â let contractHtml = `<div class="bg-gray-700 p-4 rounded-lg ${contract.isDeleted ? 'opacity-60 border-l-4 border-gray-500' : ''}">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `<div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3 class="font-bold text-lg text-white">${(contract.serviceTypes || []).map(s => s.name).join(', ')} <span class="text-base font-normal text-gray-400">- ${contract.paymentType}</span></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${contract.isDeleted ? '<span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded-full font-semibold">ExcluÃ­do</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `<p class="text-sm text-gray-400 mb-2">Adv: ${contract.advogadoResponsavel}</p>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â if (contract.observations) contractHtml += `<blockquote class="text-sm mt-2 p-2 bg-gray-600/50 rounded-md text-gray-300 border-l-4 border-indigo-500 pl-4"><strong>Obs:</strong> ${contract.observations}</blockquote>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â if((contract.parcels || []).length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `<ul class="mt-2 text-sm space-y-1">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contract.parcels.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const statusClass = p.status === 'Paga' ? 'text-green-400' : 'text-red-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let valorPagoDisplay = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (p.status === 'Paga') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(isUserAdmin) totalPago += p.valuePaid || 0; // Soma apenas se admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â valorPagoDisplay = isUserAdmin ? `(pago ${(p.valuePaid || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})` : '(pago)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const valorParcelaDisplay = isUserAdmin ? p.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `<li>Parcela ${p.number} - ${valorParcelaDisplay} - <span class="${statusClass}">${p.status}</span> ${valorPagoDisplay}</li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `</ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â if(contract.successFeePaymentDate){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const exitoRecebidoDisplay = isUserAdmin ? (contract.successFeeValueReceived || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Recebido]';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isUserAdmin) totalPago += contract.successFeeValueReceived || 0; // Soma apenas se admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractHtml += `<p class="mt-2 text-sm text-green-400">ÃŠxito Recebido: ${exitoRecebidoDisplay}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â contractHtml += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â html += contractHtml;
Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â // SumÃ¡rio financeiro apenas para admin
Â  Â  Â  Â  Â  Â  Â const summaryHtml = isUserAdmin ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="grid grid-cols-3 gap-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div><p class="text-sm text-gray-400">Total Contratado</p><p class="font-bold text-lg text-white">${totalContratado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div><p class="text-sm text-gray-400">Total Pago</p><p class="font-bold text-lg text-green-400">${totalPago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div><p class="text-sm text-gray-400">Saldo Devedor</p><p class="font-bold text-lg text-red-400">${(totalContratado - totalPago).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div><hr class="my-4 border-gray-700">` : '';

Â  Â  Â  Â  Â  Â  Â content.innerHTML = summaryHtml + html;
Â  Â  Â  Â  Â  Â  Â openModal('modalCliente');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openClientHistoryModal = openClientHistoryModal;

Â  Â  Â  Â  const openReportModal = function() {
Â  Â  Â  Â  Â  Â  if (!isUserAdmin) return; // AÃ§Ã£o apenas para admin
Â  Â  Â  Â  Â  Â  populateDateSelectors();
Â  Â  Â  Â  Â  Â  generateAndShowReport();
Â  Â  Â  Â  Â  Â  openModal('modalRelatorio');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openReportModal = openReportModal;

Â  Â  Â  Â  function populateDateSelectors() { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  const monthSelect = document.getElementById('reportMonth'); const yearSelect = document.getElementById('reportYear');
Â  Â  Â  Â  Â  Â  Â const meses = ["Janeiro", "Fevereiro", "MarÃ§o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
Â  Â  Â  Â  Â  Â  Â const anoAtual = new Date().getFullYear(); if (monthSelect.options.length > 0) return;
Â  Â  Â  Â  Â  Â  Â meses.forEach((mes, index) => { monthSelect.add(new Option(mes, index)); });
Â  Â  Â  Â  Â  Â  Â for (let i = anoAtual; i >= anoAtual - 5; i--) { yearSelect.add(new Option(i, i)); }
Â  Â  Â  Â  Â  Â  Â monthSelect.value = new Date().getMonth(); yearSelect.value = anoAtual;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateMonthlyIncome(year, month, contractsToRender) {
Â  Â  Â  Â  Â  Â  Â // Retorna 0 se nÃ£o for admin
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return { totalParcelas: 0, totalExito: 0, totalGeral: 0, detailedPayments: [] };
Â  Â  Â  Â  Â  Â  Â // ... (resto da lÃ³gica como estava) ...
Â  Â  Â  Â  Â  Â  let totalParcelas = 0, totalExito = 0, detailedPayments = [];
Â  Â  Â  Â  Â  Â  Â contractsToRender.filter(c => !c.isDeleted).forEach(contract => {
Â  Â  Â  Â  Â  Â  Â  Â  Â (contract.parcels || []).forEach(parcel => { if(parcel.status === 'Paga') { const d = new Date(parcel.paymentDate); if (d.getFullYear() === year && d.getMonth() === month) { totalParcelas += parcel.valuePaid; detailedPayments.push({ type: `Parcela ${parcel.number}/${contract.parcels.length}`, clientName: contract.clientName, date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), value: parcel.valuePaid }); } } });
Â  Â  Â  Â  Â  Â  Â  Â  Â if (contract.successFeePaymentDate) { const d = new Date(contract.successFeePaymentDate); if (d.getFullYear() === year && d.getMonth() === month) { totalExito += contract.successFeeValueReceived; detailedPayments.push({ type: 'Taxa de ÃŠxito', clientName: contract.clientName, date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), value: contract.successFeeValueReceived }); } }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â detailedPayments.sort((a,b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')));
Â  Â  Â  Â  Â  Â  Â return { totalParcelas, totalExito, totalGeral: totalParcelas + totalExito, detailedPayments };
Â  Â  Â  Â  }

Â  Â  Â  Â  const generateAndShowReport = function() {
Â  Â  Â  Â  Â  Â  Â if (!isUserAdmin) return; // AÃ§Ã£o apenas para admin
Â  Â  Â  Â  Â  Â  Â const month = parseInt(document.getElementById('reportMonth').value);
Â  Â  Â  Â  Â  Â  Â const year = parseInt(document.getElementById('reportYear').value);
Â  Â  Â  Â  Â  Â  Â const resultDiv = document.getElementById('reportResult');
Â  Â  Â  Â  Â  Â  Â const income = calculateMonthlyIncome(year, month, getFilteredContracts(false)); // Usa dados filtrados

Â  Â  Â  Â  Â  Â  Â let detailsHtml = '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-white">Detalhes dos Recebimentos</h4>';
Â  Â  Â  Â  Â  Â  Â if (income.detailedPayments.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â detailsHtml += '<ul class="space-y-2 mt-2 text-sm">';
Â  Â  Â  Â  Â  Â  Â  Â  Â income.detailedPayments.forEach(p => { detailsHtml += `<li class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><div><p class="font-semibold text-white">${p.clientName}</p><p class="text-xs text-gray-400">${p.type} - ${p.date}</p></div><span class="font-semibold text-green-400 text-lg">${p.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></li>`; });
Â  Â  Â  Â  Â  Â  Â  Â  Â detailsHtml += '</ul>';
Â  Â  Â  Â  Â  Â  Â } else { detailsHtml += '<p class="text-sm text-gray-400 mt-2">Nenhum recebimento neste perÃ­odo.</p>'; }

Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (Parcelas)</p><p class="text-2xl font-bold text-white">${income.totalParcelas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (ÃŠxito)</p><p class="text-2xl font-bold text-indigo-400">${income.totalExito.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 text-center"><p class="text-white font-bold">TOTAL GERAL RECEBIDO</p><p class="text-3xl font-extrabold text-green-400">${income.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
Â  Â  Â  Â  Â  Â  Â ` + detailsHtml;
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.generateAndShowReport = generateAndShowReport;

Â  Â  Â  Â  const openExitoModal = function(contractId) {
Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId); if (!contract) return;
Â  Â  Â  Â  Â  Â  Â document.getElementById('exitoContractId').value = contractId;
Â  Â  Â  Â  Â  Â  Â const exitoInfoEl = document.getElementById('exitoInfo');
Â  Â  Â  Â  Â  Â  Â const valorRecebidoInput = document.getElementById('exitoValorRecebido');

Â  Â  Â  Â  Â  Â  Â exitoInfoEl.innerHTML = `<p><strong>Cliente:</strong> ${contract.clientName}</p><p><strong>ServiÃ§o:</strong> ${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>${isUserAdmin ? `<p><strong>BonificaÃ§Ã£o Prevista:</strong> <span class="font-bold text-indigo-400">${contract.successFee}</span></p>` : ''}`;

Â  Â  Â  Â  Â  Â  Â // Habilita/desabilita input de valor
Â  Â  Â  Â  Â  Â  Â valorRecebidoInput.value = ''; // Limpa o valor anterior
Â  Â  Â  Â  Â  Â  Â valorRecebidoInput.closest('.admin-only').style.display = isUserAdmin ? 'block' : 'none'; // Mostra/esconde a div
Â  Â  Â  Â  Â  Â  Â document.querySelector('#modalExito .non-admin-hidden').style.display = isUserAdmin ? 'none' : 'block'; // Mostra/esconde o texto

Â  Â  Â  Â  Â  Â  Â openModal('modalExito');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.openExitoModal = openExitoModal;

Â  Â  Â  Â  const createServiceTag = function(serviceName, deadline, status = 'Pendente') { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â const container = document.getElementById('servicosContainer'); const tag = document.createElement('div'); tag.className = 'service-tag';
Â  Â  Â  Â  Â  Â  Â tag.dataset.name = serviceName; tag.dataset.deadline = deadline || ''; tag.dataset.status = status;
Â  Â  Â  Â  Â  Â  Â let deadlineHtml = ''; if (deadline) { const prazo = new Date(deadline + "T12:00:00Z"); deadlineHtml = `<span class="text-xs text-gray-400 ml-2">(${prazo.toLocaleDateString('pt-BR', {timeZone: 'UTC'})})</span>`; }
Â  Â  Â  Â  Â  Â  Â tag.innerHTML = `<span>${serviceName}${deadlineHtml}</span><span class="remove-tag" onclick="this.parentElement.remove()">&times;</span>`; container.appendChild(tag);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.createServiceTag = createServiceTag;

Â  Â  Â  Â  // --- Calculation Functions ---
Â  Â  Â  Â  async function fetchIPCA(startDate, endDate) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â const formatApiDate = (d) => `${String(new Date(d).getUTCDate()).padStart(2, '0')}/${String(new Date(d).getUTCMonth() + 1).padStart(2, '0')}/${new Date(d).getUTCFullYear()}`;
Â  Â  Â  Â  Â  Â  Â const startF = formatApiDate(startDate), endF = formatApiDate(endDate); const cacheKey = `${startF}-${endF}`; if (ipcaCache.has(cacheKey)) return ipcaCache.get(cacheKey);
Â  Â  Â  Â  Â  Â  Â const proxy = 'https://api.allorigins.win/get?url='; const api = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.16121/dados';
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const rS = await fetch(`${proxy}${encodeURIComponent(`${api}?formato=json&dataInicial=${startF}&dataFinal=${startF}`)}`); if (!rS.ok) throw Error('...'); let dS = await rS.json(); dS = JSON.parse(dS.contents); const iS = parseFloat(dS[0]?.valor);
Â  Â  Â  Â  Â  Â  Â  Â  Â const rE = await fetch(`${proxy}${encodeURIComponent(`${api}/ultimos/1?formato=json`)}`); if (!rE.ok) throw Error('...'); let dE = await rE.json(); dE = JSON.parse(dE.contents); const iE = parseFloat(dE[0]?.valor);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!iS || !iE) { console.warn("IPCA indexes not found, using factor 1."); return 1; }
Â  Â  Â  Â  Â  Â  Â  Â  Â const mult = iE / iS; ipcaCache.set(cacheKey, mult); return mult;
Â  Â  Â  Â  Â  Â  Â } catch (e) { console.error("IPCA fetch error:", e); return 1; }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function calcularValorCorrigido(valorOriginal, dataVencimento) { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â const hoje = new Date(); const venc = new Date(dataVencimento); if (hoje <= venc) return valorOriginal;
Â  Â  Â  Â  Â  Â  Â const ipcaMult = await fetchIPCA(venc, hoje); let valorCorr = valorOriginal * ipcaMult;
Â  Â  Â  Â  Â  Â  Â const diffMs = hoje - venc; const diffDays = diffMs / 86400000; const mesesAtr = diffDays / 30.44;
Â  Â  Â  Â  Â  Â  Â const jurosFat = (1 + (0.01 * mesesAtr)); return valorCorr * jurosFat;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CSV Export Functions ---
Â  Â  Â  Â  function formatCSVCell(data) { /* ... como estava ... */ if (data == null) return ''; let s = String(data); if (s.includes(',') || s.includes('"') || s.includes('\n')) { s = s.replace(/"/g, '""'); return `"${s}"`; } return s; }
Â  Â  Â  Â  function downloadCSV(csvContent, filename) { /* ... como estava ... */ const b = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement("a"); const u = URL.createObjectURL(b); l.href = u; l.download = filename; l.style.visibility = 'hidden'; document.body.appendChild(l); l.click(); document.body.removeChild(l); }

Â  Â  Â  Â  const exportContractsCSV = function() { /* ... como estava, usa getFilteredContracts ... */
Â  Â  Â  Â  Â  Â  Â const headers = ["ID", "Cliente", "Advogado", "Tipo Pagamento", "Valor Total", "Taxa ÃŠxito", "Status", "ServiÃ§os", "ObservaÃ§Ãµes"]; let csvRows = [headers.join(',')];
Â  Â  Â  Â  Â  Â  Â getFilteredContracts(false).forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const status = getContractStatus(c).statusText; const services = (c.serviceTypes || []).map(s => s.name).join('; ');
Â  Â  Â  Â  Â  Â  Â  Â  Â const row = [ c.id, c.clientName, c.advogadoResponsavel, c.paymentType, isUserAdmin ? c.totalValue : 'Restrito', isUserAdmin ? c.successFee : 'Restrito', status, services, c.observations ].map(formatCSVCell).join(',');
Â  Â  Â  Â  Â  Â  Â  Â  Â csvRows.push(row);
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â downloadCSV(csvRows.join('\n'), 'contratos_export.csv');
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.exportContractsCSV = exportContractsCSV;

Â  Â  Â  Â  const exportReportCSV = function() {
Â  Â  Â  Â  Â  Â  if (!isUserAdmin) return; // AÃ§Ã£o apenas para admin
Â  Â  Â  Â  Â  Â  // ... (resto da lÃ³gica como estava, usa getFilteredContracts) ...
Â  Â  Â  Â  Â  Â  Â const month = parseInt(document.getElementById('reportMonth').value); const year = parseInt(document.getElementById('reportYear').value);
Â  Â  Â  Â  Â  Â  Â const income = calculateMonthlyIncome(year, month, getFilteredContracts(false));
Â  Â  Â  Â  Â  Â  Â if (income.detailedPayments.length === 0) { console.warn("No data to export."); return; }
Â  Â  Â  Â  Â  Â  Â const headers = ["Cliente", "Tipo", "Data", "Valor"]; let csvRows = [headers.join(',')];
Â  Â  Â  Â  Â  Â  Â income.detailedPayments.forEach(p => { const row = [ p.clientName, p.type, p.date, p.value ].map(formatCSVCell).join(','); csvRows.push(row); });
Â  Â  Â  Â  Â  Â  Â const monthName = document.getElementById('reportMonth').options[month].text;
Â  Â  Â  Â  Â  Â  Â downloadCSV(csvRows.join('\n'), `relatorio_${monthName}_${year}.csv`);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.App.exportReportCSV = exportReportCSV;


Â  Â  Â  Â  // --- Page Initialization ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  backdrop = document.getElementById('modal-backdrop');
Â  Â  Â  Â  Â  Â  initializeAndAuth();

Â  Â  Â  Â  Â  Â  // --- Authentication Handlers ---
Â  Â  Â  Â  Â  Â  const loginForm = document.getElementById('login-form');
Â  Â  Â  Â  Â  Â  const authError = document.getElementById('auth-error');
Â  Â  Â  Â  Â  Â  const logoutButton = document.getElementById('logout-button');
Â  Â  Â  Â  Â  Â  const showAuthError = (m) => { authError.textContent = m; authError.classList.remove('hidden'); }
Â  Â  Â  Â  Â  Â  loginForm.addEventListener('submit', async (e) => { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â try { await signInWithEmailAndPassword(auth, email, password); }
Â  Â  Â  Â  Â  Â  Â  Â  Â catch (error) { console.error("Login Error:", error.code); if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found'].includes(error.code)) showAuthError('Email ou senha invÃ¡lidos.'); else showAuthError('Erro ao tentar fazer login.'); }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  logoutButton.addEventListener('click', async () => await signOut(auth));

Â  Â  Â  Â  Â  Â  // --- Display Name Handler ---
Â  Â  Â  Â  Â  Â  const displayNameForm = document.getElementById('formDisplayName');
Â  Â  Â  Â  Â  Â  displayNameForm.addEventListener('submit', async (e) => { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â e.preventDefault(); const name = document.getElementById('inputDisplayName').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â if (name && auth.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await updateProfile(auth.currentUser, { displayName: name });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentUserDisplayName = name; isUserAdmin = ADMIN_USERS.includes(name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.body.classList.toggle('is-admin', isUserAdmin); // Atualiza classe do body
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('user-display-name').textContent = name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â closeModal('modalDisplayName'); document.getElementById('app-container').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setupUIAccess(isUserAdmin);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractsCollection = collection(db, `contracts`); setupSnapshotListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } catch (error) { console.error("Erro ao salvar nome:", error); }
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- App Handlers ---
Â  Â  Â  Â  Â  Â  document.getElementById('formContrato').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractId = document.getElementById('contractId').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â const serviceTags = document.querySelectorAll('#servicosContainer .service-tag');
Â  Â  Â  Â  Â  Â  Â  Â  Â const serviceTypes = Array.from(serviceTags).map(tag => ({ name: tag.dataset.name, status: tag.dataset.status || 'Pendente', deadline: tag.dataset.deadline || null }));

Â  Â  Â  Â  Â  Â  Â  Â  Â if (serviceTypes.length === 0) { console.warn('Adicione pelo menos um serviÃ§o.'); return; }

Â  Â  Â  Â  Â  Â  Â  Â  Â const contractData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â clientName: document.getElementById('clienteNome').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â advogadoResponsavel: document.getElementById('advogadoResponsavel').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â serviceTypes: serviceTypes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â paymentType: document.getElementById('contratoTipoPagamento').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â observations: document.getElementById('contratoObservacoes').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Campos financeiros sÃ³ sÃ£o adicionados/atualizados se for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ...(isUserAdmin && {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalValue: parseFloat(document.getElementById('valorTotal').value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â successFee: document.getElementById('taxaExito').value || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â })
Â  Â  Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â  Â  Â if (!contractId) { // Criando novo contrato
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.parcels = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.successFeeValueReceived = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.successFeePaymentDate = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.isDeleted = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (isUserAdmin) { // Parcelas sÃ³ podem ser criadas por admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const totalValue = contractData.totalValue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const firstDueDate = document.getElementById('vencimentoPrimeiraParcela').value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (numParcels > 0 && totalValue > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!firstDueDate) { console.warn('Informe data da 1Âª parcela.'); return; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const parcelValue = totalValue / numParcels;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let currentDueDate = new Date(firstDueDate + 'T12:00:00Z');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â for (let i = 0; i < numParcels; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.parcels.push({ number: i + 1, value: parcelValue, dueDate: new Date(currentDueDate).toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentDueDate.setMonth(currentDueDate.getMonth() + 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await addDoc(contractsCollection, contractData);

Â  Â  Â  Â  Â  Â  Â  Â  Â } else { // Editando contrato existente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existingContract = database.contracts.find(c => c.id === contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // MantÃ©m dados financeiros e de parcelas se nÃ£o for admin editando
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isUserAdmin && existingContract) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractData.totalValue = existingContract.totalValue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractData.successFee = existingContract.successFee;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractData.parcels = existingContract.parcels;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractData.successFeeValueReceived = existingContract.successFeeValueReceived;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contractData.successFeePaymentDate = existingContract.successFeePaymentDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isUserAdmin && existingContract) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se admin edita, mas nÃ£o informou valor/parcela, mantÃ©m o que existia
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (Assume que nÃ£o quer zerar, apenas nÃ£o mexeu nesses campos)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.parcels = existingContract.parcels; // MantÃ©m parcelas existentes ao editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.successFeeValueReceived = existingContract.successFeeValueReceived;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.successFeePaymentDate = existingContract.successFeePaymentDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // A criaÃ§Ã£o de novas parcelas na ediÃ§Ã£o precisaria de lÃ³gica adicional (nÃ£o implementado)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contractData.isDeleted = existingContract?.isDeleted || false; // MantÃ©m status da lixeira
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const contractRef = doc(contractsCollection, contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(contractRef, contractData);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â closeModal('modalContrato');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.getElementById('formPagamento').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractId = document.getElementById('pagamentoContractId').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â const parcelIndex = parseInt(document.getElementById('pagamentoParcelIndex').value);
Â  Â  Â  Â  Â  Â  Â  Â  Â // Usa o valor do input se for admin, senÃ£o usa o valor original da parcela
Â  Â  Â  Â  Â  Â  Â  Â  Â const valuePaid = isUserAdmin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? parseFloat(document.getElementById('pagamentoValor').value)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : database.contracts.find(c => c.id === contractId)?.parcels[parcelIndex]?.value || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â const paymentDate = document.getElementById('pagamentoData').value;

Â  Â  Â  Â  Â  Â  Â  Â  Â const contractRef = doc(contractsCollection, contractId);
Â  Â  Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId);

Â  Â  Â  Â  Â  Â  Â  Â  Â if (contract && !isNaN(valuePaid)) { // Verifica se valor Ã© vÃ¡lido
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const updatedParcels = [...contract.parcels];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updatedParcels[parcelIndex].status = 'Paga';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updatedParcels[parcelIndex].valuePaid = valuePaid; // Salva o valor pago
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updatedParcels[parcelIndex].paymentDate = new Date(paymentDate + 'T12:00:00Z').toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(contractRef, { parcels: updatedParcels });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â closeModal('modalPagamento');
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Valor de pagamento invÃ¡lido.");
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.getElementById('formExito').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â const contractId = document.getElementById('exitoContractId').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â // Pega valor apenas se for admin, senÃ£o assume um valor simbÃ³lico (ou 0)
Â  Â  Â  Â  Â  Â  Â  Â  Â const valueReceived = isUserAdmin ? parseFloat(document.getElementById('exitoValorRecebido').value) : 0; // NÃ£o-admin sÃ³ confirma, nÃ£o informa valor

Â  Â  Â  Â  Â  Â  Â  Â  Â const contract = database.contracts.find(c => c.id === contractId);

Â  Â  Â  Â  Â  Â  Â  Â  Â if (contract) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Verifica se valor Ã© vÃ¡lido apenas se for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (isUserAdmin && (isNaN(valueReceived) || valueReceived <= 0)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn('Valor de Ãªxito invÃ¡lido.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(doc(contractsCollection, contractId), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â successFeeValueReceived: valueReceived, // Salva 0 se nÃ£o for admin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â successFeePaymentDate: new Date().toISOString() // Data da confirmaÃ§Ã£o/recebimento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â closeModal('modalExito');
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (backdrop) {
Â  Â  Â  Â  Â  Â  Â  Â  backdrop.addEventListener('click', () => { /* ... como estava, fecha modais exceto display name ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (document.getElementById('modalDisplayName').style.display !== 'block') { closeModal('modalContrato'); closeModal('modalRelatorio'); closeModal('modalExito'); closeModal('modalPagamento'); closeModal('modalCliente'); }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Service Tag Handler ---
Â  Â  Â  Â  Â  Â  const addServiceButton = document.getElementById('addServiceButton');
Â  Â  Â  Â  Â  Â  if(addServiceButton) {
Â  Â  Â  Â  Â  Â  Â  Â  addServiceButton.addEventListener('click', () => { /* ... como estava ... */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const serviceInput = document.getElementById('contratoServicoInput'); const deadlineInput = document.getElementById('contratoPrazoInput');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const serviceName = serviceInput.value.trim(); const deadline = deadlineInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (serviceName) { createServiceTag(serviceName, deadline, 'Pendente'); serviceInput.value = ''; deadlineInput.value = ''; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { console.warn('Insira um nome para o serviÃ§o.'); }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
