<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#111827',       // gray-900
                        'dark-card': '#1f2937',     // gray-800
                        'dark-border': '#374151',   // gray-700
                        'dark-text': '#d1d5db',     // gray-300
                        'dark-text-light': '#9ca3af', // gray-400
                        'primary': '#4f46e5',     // indigo-600
                        'primary-hover': '#4338ca', // indigo-700
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .dark-card { background-color: #1f2937; }
        .dark-border { border-color: #374151; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        .kanban-column {
            min-height: 400px;
            background-color: #1f2937; /* gray-800 */
        }
        .kanban-card {
            background-color: #374151; /* gray-700 */
            border-left: 4px solid #4f46e5; /* indigo-600 */
        }
        .kanban-card-prazo { border-left-color: #f59e0b; } /* amber-500 */
        .kanban-card-atrasado { border-left-color: #ef4444; } /* red-500 */

        .kanban-card-concluido {
            border-left-color: #22c55e; /* green-500 */
            opacity: 0.8;
        }
        .kanban-card-concluido .kanban-card-title {
            text-decoration: line-through;
        }

        .kanban-card .kanban-card-title {
            color: #f3f4f6; /* gray-100 */
        }
        .kanban-card .kanban-card-client,
        .kanban-card .kanban-card-prazo-label,
        .kanban-card .kanban-card-advogado {
            color: #d1d5db; /* gray-300 */
            font-size: 0.8rem;
        }
        .kanban-card-prazo-label i {
            margin-right: 4px;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #4b5563; /* gray-600 */
        }
        .sortable-drag {
            opacity: 1;
        }
        
        /* Estilos para Tabela */
        .table-auto th {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            padding: 12px;
            text-align: left;
        }
        .table-auto td {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 12px;
            border-top: 1px solid #374151; /* gray-700 */
        }
        .table-auto tr:nth-child(even) td {
            background-color: #1d2634; /* Um pouco mais escuro que gray-800 */
        }
        .table-auto .action-btn {
            color: #9ca3af; /* gray-400 */
            transition: color 0.2s;
        }
        .table-auto .action-btn:hover {
            color: #ffffff;
        }
        .table-auto .btn-delete:hover { color: #ef4444; } /* red-500 */
        .table-auto .btn-restore:hover { color: #22c55e; } /* green-500 */

        /* Estilos para Tabs */
        .tab-btn {
            padding: 8px 16px;
            background-color: transparent;
            color: #9ca3af; /* gray-400 */
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: #e5e7eb; /* gray-200 */
            border-bottom-color: #374151; /* gray-700 */
        }
        .tab-btn.active-tab {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }

        /* (NOVO) Estilos para Botões de Filtro de Gráfico */
        .analytics-filter-btn {
            padding: 8px 16px;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .analytics-filter-btn:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .analytics-filter-btn.active-filter {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            font-weight: 600;
        }

    </style>
</head>
<body class="bg-dark-bg text-dark-text font-inter">

    <!-- Header Fixo -->
    <header class="bg-dark-card shadow-md sticky top-0 z-40 dark-border border-b">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <!-- Logo e Título -->
            <div class="flex items-center space-x-4">
                <i class="fas fa-balance-scale text-primary text-2xl"></i>
                <h1 class="text-xl font-semibold text-white">Gestão Financeira</h1>
            </div>

            <!-- Navegação Principal (Tabs) -->
            <nav class="flex-1 flex justify-center">
                <div class="flex space-x-2">
                    <button id="nav-main" class="tab-btn active-tab" onclick="App.navigateTo('main')">
                        <i class="fas fa-home mr-2"></i>Painel
                    </button>
                    <button id="nav-services" class="tab-btn" onclick="App.navigateTo('services')">
                        <i class="fas fa-tasks mr-2"></i>Produção (Serviços)
                    </button>
                    <button id="nav-inadimplentes" class="tab-btn" onclick="App.navigateTo('inadimplentes')">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Inadimplentes
                    </button>
                    <button id="nav-analytics" class="tab-btn" onclick="App.navigateTo('analytics')">
                        <i class="fas fa-chart-line mr-2"></i>Análise Gráfica
                    </button>
                    <button id="nav-trash" class="tab-btn" onclick="App.navigateTo('trash')">
                        <i class="fas fa-trash-alt mr-2"></i>Lixeira
                    </button>
                </div>
            </nav>

            <!-- Botões de Ação e Usuário -->
            <div class="flex items-center space-x-4">
                <button id="openReportModalBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Relatório Mensal
                </button>
                <button id="openModalBtn" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Novo Contrato
                </button>
                <div class="flex items-center space-x-2" id="user-info">
                    <i class="fas fa-user-circle text-2xl text-gray-400"></i>
                    <span id="user-name" class="text-white font-medium"></span>
                    <button id="logout-btn" class="text-gray-400 hover:text-white transition">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-6">

        <!-- Página: Painel Principal (Contratos) -->
        <div id="page-main">
            <!-- Barra de Ferramentas -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-white">Painel de Contratos</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="search-contracts" placeholder="Buscar por cliente ou serviço..." class="bg-dark-card w-72 pl-10 pr-4 py-2 rounded-lg text-white border border-dark-border focus:outline-none focus:ring-2 focus:ring-primary">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-dark-text-light"></i>
                    </div>
                </div>
            </div>

            <!-- Lista de Contratos -->
            <div id="contract-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards de contrato serão inseridos aqui pelo JS -->
                <!-- Exemplo de Card (para referência de estilo)
                <div class="dark-card rounded-lg shadow-lg overflow-hidden border border-dark-border">
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-semibold text-white mb-2">Cliente Exemplo</h3>
                            <span class="text-xs font-medium bg-green-600 text-white px-2 py-1 rounded-full">Ativo</span>
                        </div>
                        <p class="text-sm text-dark-text-light mb-1">Serviço: Inventário</p>
                        <p class="text-sm text-dark-text-light mb-4">Adv: Dr. João</p>
                        <div class="mb-4">
                            <p class="text-sm text-white">Valor Total: R$ 5.000,00</p>
                            <p class="text-sm text-dark-text-light">Próxima Parcela: 10/10/2025 (R$ 500,00)</p>
                        </div>
                    </div>
                    <div class="bg-gray-700 px-5 py-3 flex justify-end space-x-2">
                        <button class="text-sm text-primary hover:text-indigo-400"><i class="fas fa-edit mr-1"></i>Editar</button>
                        <button class="text-sm text-red-500 hover:text-red-400"><i class="fas fa-trash-alt mr-1"></i>Excluir</button>
                    </div>
                </div>
                -->
            </div>
            
            <!-- (NOVO) Botão de Paginação -->
            <div id="pagination-container" class="mt-8 text-center">
                <button id="loadMoreContractsBtn" class="hidden bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                    <i class="fas fa-chevron-down mr-2"></i>Carregar Mais
                </button>
            </div>

        </div>

        <!-- Página: Produção (Kanban) -->
        <div id="page-services" class="hidden">
            <h2 class="text-2xl font-semibold text-white mb-6">Painel de Produção (Serviços)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Coluna Pendente -->
                <div class="kanban-column rounded-lg p-4" data-status="pendente">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-pause-circle text-yellow-500 mr-2"></i>Pendente</h3>
                    <div id="kanban-pendente" class="kanban-list space-y-4" data-status="pendente">
                        <!-- Cards de serviço serão inseridos aqui -->
                    </div>
                </div>

                <!-- Coluna Em Andamento -->
                <div class="kanban-column rounded-lg p-4" data-status="em-andamento">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-tasks text-blue-500 mr-2"></i>Em Andamento</h3>
                    <div id="kanban-em-andamento" class="kanban-list space-y-4" data-status="em-andamento">
                        <!-- Cards de serviço serão inseridos aqui -->
                    </div>
                </div>

                <!-- Coluna Prazo Próximo -->
                <div class="kanban-column rounded-lg p-4" data-status="prazo-proximo">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-clock text-amber-500 mr-2"></i>Prazo Próximo (7d)</h3>
                    <div id="kanban-prazo-proximo" class="kanban-list space-y-4" data-status="prazo-proximo">
                        <!-- Cards de serviço serão inseridos aqui -->
                    </div>
                </div>
                
                <!-- Coluna Concluído -->
                <div class="kanban-column rounded-lg p-4" data-status="concluido">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-check-circle text-green-500 mr-2"></i>Concluído</h3>
                    <div id="kanban-concluido" class="kanban-list space-y-4" data-status="concluido">
                        <!-- Cards de serviço serão inseridos aqui -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Página: Inadimplentes -->
        <div id="page-inadimplentes" class="hidden">
            <h2 class="text-2xl font-semibold text-white mb-6">Relatório de Inadimplência</h2>
            <div class="dark-card rounded-lg shadow-lg overflow-hidden border border-dark-border">
                <table class="table-auto w-full">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Parcela (Venc.)</th>
                            <th>Valor Original</th>
                            <th>Valor Corrigido (IPCA)</th>
                            <th>Juros (1%) + Multa (2%)</th>
                            <th>Valor Total Atualizado</th>
                            <th>Advogado</th>
                        </tr>
                    </thead>
                    <tbody id="inadimplentes-table-body">
                        <!-- Linhas serão inseridas aqui pelo JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Página: Análise Gráfica -->
        <div id="page-analytics" class="hidden">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-semibold text-white">Análise Gráfica</h2>
                 <!-- (NOVO) Botões de Filtro -->
                 <div class="flex space-x-2">
                    <button id="filter-12m" class="analytics-filter-btn active-filter">Últimos 12 Meses</button>
                    <button id="filter-this-year" class="analytics-filter-btn">Este Ano</button>
                    <button id="filter-last-year" class="analytics-filter-btn">Ano Passado</button>
                </div>
            </div>
           
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Gráfico de Faturamento -->
                <div class="dark-card p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Recebimentos Totais</h3>
                    <div class="h-96">
                        <canvas id="faturamentoChart"></canvas>
                    </div>
                </div>
                <!-- Gráfico de Produção -->
                <div class="dark-card p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Produção (Novos Contratos)</h3>
                    <div class="h-96">
                        <canvas id="producaoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página: Lixeira -->
        <div id="page-trash" class="hidden">
            <h2 class="text-2xl font-semibold text-white mb-6">Lixeira</h2>
            
            <div class="flex space-x-4 border-b border-dark-border mb-4">
                <button id="trash-tab-contracts" class="tab-btn active-tab" onclick="App.showTrashTab('contracts')">Contratos</button>
                <button id="trash-tab-services" class="tab-btn" onclick="App.showTrashTab('services')">Serviços</button>
            </div>

            <!-- Lixeira de Contratos -->
            <div id="trash-content-contracts">
                <div class="dark-card rounded-lg shadow-lg overflow-hidden border border-dark-border">
                    <table class="table-auto w-full">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Serviço</th>
                                <th>Valor</th>
                                <th>Data Exclusão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="trash-table-body-contracts">
                            <!-- Linhas de contratos excluídos -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lixeira de Serviços -->
            <div id="trash-content-services" class="hidden">
                 <div class="dark-card rounded-lg shadow-lg overflow-hidden border border-dark-border">
                    <table class="table-auto w-full">
                        <thead>
                            <tr>
                                <th>Serviço</th>
                                <th>Cliente</th>
                                <th>Status</th>
                                <th>Data Exclusão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="trash-table-body-services">
                            <!-- Linhas de serviços excluídos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Loading -->
    <div id="loadingModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center">
        <div class="flex items-center space-x-3 bg-dark-card p-6 rounded-lg shadow-xl">
            <i class="fas fa-spinner fa-spin text-2xl text-primary"></i>
            <span id="loadingText" class="text-white text-lg">A carregar...</span>
        </div>
    </div>

    <!-- Modal: Genérico (Alertas) -->
    <div id="alertModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center">
        <div class="bg-dark-card rounded-lg shadow-xl w-full max-w-md border border-dark-border">
            <div class="flex justify-between items-center p-5 border-b border-dark-border">
                <h3 id="alertModalTitle" class="text-xl font-semibold text-white">Aviso</h3>
                <button id="closeAlertModalBtn" class="text-dark-text-light hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p id="alertModalMessage" class="text-dark-text"></p>
            </div>
            <div class="p-4 bg-gray-700 flex justify-end rounded-b-lg">
                <button id="confirmAlertModalBtn" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-6 rounded-lg">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Relatório Mensal -->
    <div id="reportModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center">
        <div class="bg-dark-card rounded-lg shadow-xl w-full max-w-2xl border border-dark-border">
            <div class="flex justify-between items-center p-5 border-b border-dark-border">
                <h3 class="text-xl font-semibold text-white">Relatório Mensal</h3>
                <button id="closeReportModalBtn" class="text-dark-text-light hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex space-x-4 mb-4">
                    <div class="flex-1">
                        <label for="reportMonth" class="block text-sm font-medium text-dark-text-light mb-1">Mês</label>
                        <select id="reportMonth" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <!-- Options preenchidas por JS -->
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="reportYear" class="block text-sm font-medium text-dark-text-light mb-1">Ano</label>
                        <select id="reportYear" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <!-- Options preenchidas por JS -->
                        </select>
                    </div>
                    <div class="flex-none self-end">
                        <button id="generateReportBtn" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-6 rounded-lg h-full">
                            Gerar
                        </button>
                    </div>
                </div>

                <!-- (NOVO) Área de Resultado Estilizada -->
                <div id="reportResult" class="mt-6 max-h-96 overflow-y-auto p-4 bg-dark-bg rounded-lg border border-dark-border">
                    <p class="text-dark-text-light text-center">Selecione o mês e ano para gerar o relatório.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Novo/Editar Contrato -->
    <div id="contractModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center">
        <div class="bg-dark-card rounded-lg shadow-xl w-full max-w-4xl border border-dark-border max-h-screen overflow-y-auto">
            <!-- Header -->
            <div class="flex justify-between items-center p-5 border-b border-dark-border sticky top-0 bg-dark-card z-10">
                <h3 id="modalTitle" class="text-xl font-semibold text-white">Novo Contrato</h3>
                <button id="closeModalBtn" class="text-dark-text-light hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Formulário -->
            <form id="contractForm" class="p-6">
                <input type="hidden" id="contractId">
                <input type="hidden" id="createdDate">

                <!-- Seção 1: Cliente e Advogado -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-dark-text-light mb-1">Nome do Cliente</label>
                        <input type="text" id="clientName" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="lawyerName" class="block text-sm font-medium text-dark-text-light mb-1">Advogado Responsável</label>
                        <input type="text" id="lawyerName" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>

                <!-- Seção 2: Serviço e Valor -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="serviceName" class="block text-sm font-medium text-dark-text-light mb-1">Nome do Serviço</label>
                        <input type="text" id="serviceName" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="totalValue" class="block text-sm font-medium text-dark-text-light mb-1">Valor Total (R$)</label>
                        <input type="number" id="totalValue" step="0.01" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>

                <!-- Seção 3: Tipo de Contrato (Honorários) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-dark-text-light mb-2">Tipo de Honorários</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center text-white">
                            <input type="radio" name="paymentType" value="parcelado" class="text-primary focus:ring-primary mr-2" checked>
                            Parcelado
                        </label>
                        <label class="flex items-center text-white">
                            <input type="radio" name="paymentType" value="exito" class="text-primary focus:ring-primary mr-2">
                            Êxito
                        </label>
                    </div>
                </div>

                <!-- Seção 4: Detalhes de Pagamento (Parcelado) -->
                <div id="parcelas-section" class="mb-6">
                    <h4 class="text-lg font-semibold text-white mb-3">Detalhes das Parcelas</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="numParcels" class="block text-sm font-medium text-dark-text-light mb-1">Nº de Parcelas</label>
                            <input type="number" id="numParcels" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2" min="1">
                        </div>
                        <div>
                            <label for="firstDueDate" class="block text-sm font-medium text-dark-text-light mb-1">1º Vencimento</label>
                            <input type="date" id="firstDueDate" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2">
                        </div>
                        <div>
                            <label for="parcelValue" class="block text-sm font-medium text-dark-text-light mb-1">Valor da Parcela</label>
                            <input type="number" step="0.01" id="parcelValue" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2" placeholder="Automático...">
                        </div>
                        <div class="self-end">
                            <button type="button" id="generateParcelsBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg h-full">
                                <i class="fas fa-cogs mr-2"></i>Gerar
                            </button>
                        </div>
                    </div>
                    <div id="parcels-container" class="mt-4 max-h-60 overflow-y-auto space-y-3">
                        <!-- Parcelas geradas aqui -->
                    </div>
                </div>

                <!-- Seção 5: Detalhes de Pagamento (Êxito) -->
                <div id="exito-section" class="hidden mb-6">
                    <h4 class="text-lg font-semibold text-white mb-3">Detalhes do Êxito</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="exitoType" class="block text-sm font-medium text-dark-text-light mb-1">Tipo de Êxito</label>
                            <select id="exitoType" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2">
                                <option value="percent">Percentual (%)</option>
                                <option value="fixed">Valor Fixo (R$)</option>
                            </select>
                        </div>
                        <div>
                            <label for="exitoValue" class="block text-sm font-medium text-dark-text-light mb-1">Valor do Êxito</label>
                            <input type="number" id="exitoValue" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2" placeholder="% ou R$">
                        </div>
                    </div>
                     <div class="mt-4">
                        <label class="flex items-center text-white">
                            <input type="checkbox" id="exitoReceived" class="text-primary focus:ring-primary mr-2 h-5 w-5">
                            Recebido?
                        </label>
                    </div>
                    <div id="exito-received-details" class="hidden mt-4 grid grid-cols-2 gap-4">
                         <div>
                            <label for="exitoReceivedValue" class="block text-sm font-medium text-dark-text-light mb-1">Valor Recebido (R$)</label>
                            <input type="number" step="0.01" id="exitoReceivedValue" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2" placeholder="Valor efetivamente recebido">
                        </div>
                        <div>
                            <label for="exitoReceivedDate" class="block text-sm font-medium text-dark-text-light mb-1">Data Recebimento</label>
                            <input type="date" id="exitoReceivedDate" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2">
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Footer (Botões) -->
            <div class="p-6 bg-gray-700 flex justify-end space-x-4 sticky bottom-0 z-10">
                <button type="button" id="cancelModalBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-6 rounded-lg">
                    Cancelar
                </button>
                <button type="submit" form="contractForm" class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-6 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </div>
    </div>


    <!-- Imports Firebase e Lógica Principal -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            signInAnonymously, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            collection, 
            query, 
            where, 
            getDocs,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- Configuração Global ---
        setLogLevel('Debug');
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Estado Global da Aplicação ---
        const App = {
            userId: null,
            proxyUrl: 'https://us-central1-meu-app-dev-01.cloudfunctions.net/proxyBCB',
            currentPage: 'main',
            currentTrashTab: 'contracts',
            activeFilters: {
                services: ['pendente', 'em-andamento', 'prazo-proximo'] // (NOVO) Ideia 3 - Filtros de serviço
            },
            displayedContractsCount: 30, // (NOVO) Ideia 2 - Paginação
            analyticsPeriod: '12m', // (NOVO) Ideia 5 - Filtro de Gráfico
        };
        window.App = App; // Expor para o HTML

        // --- Base de Dados Local (Cache) ---
        const database = {
            contracts: [],
            services: [],
            payments: [],
        };

        // Variáveis globais
        let ipcaCache = new Map(); // Cache para os valores do IPCA (Performance)
        let faturamentoChartInstance = null; // Instância do gráfico Faturamento
        let producaoChartInstance = null; // Instância do gráfico Produção

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        async function initializeAndAuth() {
            showLoading("A autenticar...");
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                showModal("Erro de Autenticação", "Não foi possível autenticar. A aplicação pode não funcionar corretamente.");
                hideLoading();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    App.userId = user.uid;
                    document.getElementById('user-name').textContent = user.isAnonymous ? 'Anónimo' : (user.email || user.uid.substring(0, 8));
                    document.getElementById('user-info').classList.remove('hidden');
                    
                    showLoading("A carregar dados...");
                    await fetchData();
                    
                    // (NOVO) Ideia 2: Adiciona listener de paginação e pesquisa
                    document.getElementById('loadMoreContractsBtn').addEventListener('click', () => {
                        App.displayedContractsCount += 30; // Aumenta o limite
                        App.renderMainPage(); // Re-renderiza a lista
                    });
                    
                    document.getElementById('search-contracts').addEventListener('input', () => {
                        App.displayedContractsCount = 30; // Reseta a contagem ao pesquisar
                        App.renderMainPage();
                    });

                    // (NOVO) Ideia 5: Adiciona listeners dos filtros de gráfico
                    document.getElementById('filter-12m').addEventListener('click', () => setAnalyticsPeriod('12m'));
                    document.getElementById('filter-this-year').addEventListener('click', () => setAnalyticsPeriod('thisYear'));
                    document.getElementById('filter-last-year').addEventListener('click', () => setAnalyticsPeriod('lastYear'));

                    // Renderiza a página inicial
                    App.navigateTo('main'); 
                    hideLoading();
                } else {
                    App.userId = null;
                    document.getElementById('user-info').classList.add('hidden');
                    // TODO: Mostrar ecrã de login se necessário
                }
            });

            // Listeners globais
            setupModalListeners();
            setupFormListeners();
            setupKanbanListeners();

            // Listener de Logout
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await signOut(auth);
                window.location.reload(); // Recarrega a página
            });
        }
        
        // (NOVO) Ideia 5: Função para definir período de análise
        function setAnalyticsPeriod(period) {
            App.analyticsPeriod = period;
            // Atualiza classes ativas
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.remove('active-filter');
            });
            // Constrói o ID corretamente
            const btnId = `filter-${period.replace('Y', 'Y').toLowerCase()}`;
            document.getElementById(btnId).classList.add('active-filter');
            
            // Re-renderiza os gráficos
            if(App.currentPage === 'analytics') {
                App.renderAnalyticsPage();
            }
        }

        // --- LÓGICA DE NAVEGAÇÃO ---
        App.navigateTo = (page) => {
            // Oculta todas as páginas
            document.getElementById('page-main').classList.add('hidden');
            document.getElementById('page-services').classList.add('hidden');
            document.getElementById('page-inadimplentes').classList.add('hidden');
            document.getElementById('page-analytics').classList.add('hidden');
            document.getElementById('page-trash').classList.add('hidden');

            // Desativa todas as tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));

            // Mostra a página e ativa a tab correta
            const pageId = `page-${page}`;
            const navId = `nav-${page}`;
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(navId).classList.add('active-tab');

            App.currentPage = page;

            // Renderiza o conteúdo da página
            switch(page) {
                case 'main':
                    App.renderMainPage();
                    break;
                case 'services':
                    App.renderServicosPage();
                    break;
                case 'inadimplentes':
                    App.renderInadimplentesPage();
                    break;
                case 'analytics':
                    App.renderAnalyticsPage();
                    break;
                case 'trash':
                    App.renderTrashPage();
                    break;
            }
        };
        window.App.navigateTo = App.navigateTo;

        // --- LÓGICA DE BUSCA DE DADOS (FETCH) ---
        async function fetchData() {
            if (!App.userId) return;

            const collections = ['contracts', 'services', 'payments'];
            const promises = collections.map(col => 
                getDocs(query(collection(db, `artifacts/${appId}/users/${App.userId}/${col}`)))
            );

            try {
                const [contractsSnapshot, servicesSnapshot, paymentsSnapshot] = await Promise.all(promises);
                
                database.contracts = contractsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                database.services = servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                database.payments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Pré-processamento: Associar serviços aos contratos
                database.contracts.forEach(contract => {
                    contract.service = database.services.find(s => s.contractId === contract.id && !s.isDeleted) || null;
                });

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showModal("Erro de Dados", "Não foi possível carregar os dados do Firestore.");
            }
        }
        
        // --- RENDERIZAÇÃO DAS PÁGINAS ---

        // (ATUALIZADO) Ideia 2: Paginação
        App.renderMainPage = () => {
            const container = document.getElementById('contract-list-container');
            const searchTerm = document.getElementById('search-contracts').value.toLowerCase();

            // Filtra contratos (não excluídos) e aplica pesquisa
            const filteredContracts = database.contracts.filter(c => 
                !c.isDeleted &&
                (c.clientName.toLowerCase().includes(searchTerm) || 
                 c.serviceName.toLowerCase().includes(searchTerm))
            );

            // Ordena por data de criação (mais recente primeiro)
            filteredContracts.sort((a, b) => (b.createdDate?.seconds || 0) - (a.createdDate?.seconds || 0));

            // (NOVO) Aplica a paginação (slice)
            const contractsToRender = filteredContracts.slice(0, App.displayedContractsCount);
            
            if (contractsToRender.length === 0) {
                container.innerHTML = `<p class="text-dark-text-light text-center col-span-full">Nenhum contrato encontrado.</p>`;
            } else {
                container.innerHTML = contractsToRender.map(contract => 
                    renderContractCard(contract)
                ).join('');
            }
            
            // Adiciona listeners aos botões dos cards
            container.querySelectorAll('.btn-edit-contract').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    App.editContract(id);
                });
            });
            container.querySelectorAll('.btn-delete-contract').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    App.deleteContract(id);
                });
            });
            
            // (NOVO) Controla a visibilidade do botão "Carregar Mais"
            const loadMoreBtn = document.getElementById('loadMoreContractsBtn');
            if (filteredContracts.length > App.displayedContractsCount) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        };
        window.App.renderMainPage = App.renderMainPage;

        function renderContractCard(contract) {
            const nextParcel = getNextParcel(contract);
            const status = getContractStatus(contract);
            
            let statusBadge = '';
            switch(status) {
                case 'Ativo': statusBadge = '<span class="text-xs font-medium bg-green-600 text-white px-2 py-1 rounded-full">Ativo</span>'; break;
                case 'Inadimplente': statusBadge = '<span class="text-xs font-medium bg-red-600 text-white px-2 py-1 rounded-full">Inadimplente</span>'; break;
                case 'Concluído': statusBadge = '<span class="text-xs font-medium bg-gray-500 text-white px-2 py-1 rounded-full">Concluído</span>'; break;
                case 'Êxito': statusBadge = '<span class="text-xs font-medium bg-yellow-500 text-white px-2 py-1 rounded-full">Êxito</span>'; break;
            }

            return `
                <div class="dark-card rounded-lg shadow-lg overflow-hidden border border-dark-border flex flex-col justify-between">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-white">${contract.clientName}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-dark-text-light mb-1">Serviço: ${contract.serviceName}</p>
                        <p class="text-sm text-dark-text-light mb-4">Adv: ${contract.lawyerName}</p>
                        <div class="mb-4">
                            <p class="text-sm text-white">Valor Total: ${formatCurrency(contract.totalValue)}</p>
                            ${nextParcel ? 
                                `<p class="text-sm text-dark-text-light">Próxima Parcela: ${formatDate(nextParcel.dueDate)} (${formatCurrency(nextParcel.value)})</p>` :
                                (contract.paymentType === 'exito' ? `<p class="text-sm text-dark-text-light">Aguardando êxito</p>` : `<p class="text-sm text-dark-text-light">Sem parcelas pendentes</p>`)
                            }
                        </div>
                    </div>
                    <div class="bg-gray-700 px-5 py-3 flex justify-end space-x-3">
                        <button class="btn-edit-contract text-sm text-primary hover:text-indigo-400 transition" data-id="${contract.id}">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button class="btn-delete-contract text-sm text-red-500 hover:text-red-400 transition" data-id="${contract.id}">
                            <i class="fas fa-trash-alt mr-1"></i>Excluir
                        </button>
                    </div>
                </div>
            `;
        }
        
        App.renderServicosPage = () => {
            // Limpa as colunas
            const columns = ['pendente', 'em-andamento', 'prazo-proximo', 'concluido'];
            columns.forEach(col => document.getElementById(`kanban-${col}`).innerHTML = '');

            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            const seteDias = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);

            const activeServices = database.services.filter(s => !s.isDeleted);

            activeServices.forEach(service => {
                const contract = database.contracts.find(c => c.id === service.contractId);
                if (!contract) return; // Contrato pode ter sido excluído

                // Determina a coluna correta
                let targetColumnId = '';
                const prazoDate = service.prazo ? new Date(service.prazo) : null;
                
                if (service.status === 'concluido') {
                    targetColumnId = 'kanban-concluido';
                } else if (service.status === 'em-andamento') {
                    targetColumnId = 'kanban-em-andamento';
                } else if (service.status === 'pendente') {
                    if (prazoDate && prazoDate <= seteDias && prazoDate >= hoje) {
                         targetColumnId = 'kanban-prazo-proximo';
                    } else {
                        targetColumnId = 'kanban-pendente';
                    }
                }
                
                const targetColumn = document.getElementById(targetColumnId);
                if (targetColumn) {
                    targetColumn.innerHTML += renderKanbanCard(service, contract, prazoDate);
                }
            });
            
            // Adiciona listeners de exclusão aos cards
            document.querySelectorAll('.btn-delete-service').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Impede o drag
                    const serviceId = e.currentTarget.dataset.id;
                    App.deleteService(serviceId);
                });
            });
        };
        window.App.renderServicosPage = App.renderServicosPage;

        function renderKanbanCard(service, contract, prazoDate) {
            let prazoClass = 'kanban-card';
            let prazoLabel = '';
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            if (service.status !== 'concluido' && prazoDate) {
                if (prazoDate < hoje) {
                    prazoClass = 'kanban-card-atrasado';
                    prazoLabel = `<i class="fas fa-exclamation-circle text-red-400"></i>Atrasado (${formatDate(service.prazo)})`;
                } else if (prazoDate <= new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                    prazoClass = 'kanban-card-prazo';
                    prazoLabel = `<i class="fas fa-clock text-amber-400"></i>Prazo: ${formatDate(service.prazo)}`;
                } else {
                    prazoLabel = `<i class="fas fa-calendar-alt"></i>Prazo: ${formatDate(service.prazo)}`;
                }
            } else if (service.status === 'concluido') {
                prazoClass = 'kanban-card-concluido';
                if(service.prazo) prazoLabel = `<i class="fas fa-check"></i>Concluído`;
            }

            return `
                <div class="kanban-card p-4 rounded-lg shadow cursor-grab ${prazoClass}" data-service-id="${service.id}">
                    <div class="flex justify-between items-start">
                        <h4 class="kanban-card-title font-semibold mb-2">${service.name}</h4>
                        <button class="btn-delete-service text-dark-text-light hover:text-red-500 transition" data-id="${service.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="kanban-card-client mb-3">${contract.clientName}</p>
                    <div class="flex justify-between items-center">
                        <span class="kanban-card-prazo-label">${prazoLabel}</span>
                        <span class="kanban-card-advogado"><i class="fas fa-user-tie mr-1"></i>${contract.lawyerName}</span>
                    </div>
                </div>
            `;
        }

        // (ATUALIZADO) Ideia 1: Performance com Promise.all()
        App.renderInadimplentesPage = async () => {
            const tableBody = document.getElementById('inadimplentes-table-body');
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-6"><i class="fas fa-spinner fa-spin mr-2"></i>A calcular inadimplência e corrigir valores...</td></tr>`;

            const inadimplentes = App.getInadimplentes();
            
            if (inadimplentes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-6">Nenhuma parcela inadimplente encontrada.</td></tr>`;
                return;
            }

            showLoading("Corrigindo valores (IPCA)...");
            
            // (NOVO) Executa todas as atualizações de valor em PARALELO
            const updatePromises = inadimplentes.map(parcel => {
                // Passa o contrato e a parcela específica
                return App.updateContractValue(parcel.contract, parcel); 
            });
            
            try {
                // Espera todas as chamadas de API (com cache) terminarem
                const updatedValues = await Promise.all(updatePromises);
                hideLoading();

                // Agora que temos os valores, renderiza a tabela
                const tableRows = inadimplentes.map((parcel, index) => {
                    const contract = parcel.contract;
                    const { originalValue, correctedValue, interestAndFine, totalUpdatedValue } = updatedValues[index];

                    return `
                        <tr>
                            <td>${contract.clientName}</td>
                            <td>${contract.serviceName}</td>
                            <td>${formatDate(parcel.dueDate)}</td>
                            <td>${formatCurrency(originalValue)}</td>
                            <td>${formatCurrency(correctedValue)}</td>
                            <td>${formatCurrency(interestAndFine)}</td>
                            <td class="font-bold text-white">${formatCurrency(totalUpdatedValue)}</td>
                            <td>${contract.lawyerName}</td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = tableRows;
                
            } catch (error) {
                console.error("Erro ao atualizar valores em paralelo:", error);
                hideLoading();
                showModal("Erro de API", "Ocorreu um erro ao calcular os valores corrigidos. Tente novamente.");
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-6 text-red-400">Erro ao calcular valores.</td></tr>`;
            }
        };
        window.App.renderInadimplentesPage = App.renderInadimplentesPage;
        
        // (ATUALIZADO) Ideia 5: Filtros de Gráfico
        App.renderAnalyticsPage = () => {
            const ctxFaturamento = document.getElementById('faturamentoChart')?.getContext('2d');
            const ctxProducao = document.getElementById('producaoChart')?.getContext('2d');
            
            if (!ctxFaturamento || !ctxProducao) {
                console.error("Canvas dos gráficos não encontrado.");
                return;
            }
            
            // (NOVO) Passa o período selecionado
            const faturamentoData = getAnnualChartData(App.analyticsPeriod);
            const producaoData = getAnnualProducaoData(App.analyticsPeriod);
            
            // Destrói gráficos anteriores
            if (faturamentoChartInstance) faturamentoChartInstance.destroy();
            if (producaoChartInstance) producaoChartInstance.destroy();

            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';

            // Gráfico de Faturamento
            faturamentoChartInstance = new Chart(ctxFaturamento, {
                type: 'bar',
                data: {
                    labels: faturamentoData.labels,
                    datasets: [{
                        label: 'Faturamento Total Recebido',
                        data: faturamentoData.data,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)', 
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: getChartOptions() // Usa função helper
            });

            // Gráfico de Produção
            producaoChartInstance = new Chart(ctxProducao, {
                type: 'bar', 
                data: {
                    labels: producaoData.labels,
                    datasets: [{
                        label: 'Valor de Novos Contratos',
                        data: producaoData.data,
                        backgroundColor: 'rgba(14, 165, 233, 0.6)', 
                        borderColor: 'rgba(56, 189, 248, 1)', 
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: getChartOptions() // Usa função helper
            });
        };
        window.App.renderAnalyticsPage = App.renderAnalyticsPage;
        
        App.renderTrashPage = () => {
            App.showTrashTab(App.currentTrashTab); // Renderiza a tab ativa
        };
        window.App.renderTrashPage = App.renderTrashPage;

        // --- LÓGICA DAS PÁGINAS (Helpers) ---

        // (ATUALIZADO) Ideia 5: Filtros de Gráfico
        function getAnnualChartData(period) {
            const labels = [];
            const meses = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const hoje = new Date();
            let startDate, endDate;

            // Define o intervalo de datas e os rótulos com base no período
            if (period === '12m') {
                endDate = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0); // Fim do mês atual
                startDate = new Date(hoje.getFullYear(), hoje.getMonth() - 11, 1);
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    labels.push(`${meses[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
                }
            } else if (period === 'thisYear') {
                startDate = new Date(hoje.getFullYear(), 0, 1); // 1º Jan
                endDate = new Date(hoje.getFullYear(), 11, 31); // 31 Dez
                labels.push(...meses.map(m => `${m}/${String(hoje.getFullYear()).slice(-2)}`));
            } else { // lastYear
                const lastYear = hoje.getFullYear() - 1;
                startDate = new Date(lastYear, 0, 1); // 1º Jan (ano passado)
                endDate = new Date(lastYear, 11, 31); // 31 Dez (ano passado)
                labels.push(...meses.map(m => `${m}/${String(lastYear).slice(-2)}`));
            }
            
            const monthlyData = new Array(12).fill(0);
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);

            // Filtra os pagamentos
            database.payments.forEach(payment => {
                const paymentDate = new Date(payment.date);
                if (paymentDate >= startDate && paymentDate <= endDate) {
                    let monthIndex;
                    if (period === '12m') {
                        // Calcula a diferença de meses a partir de "hoje"
                        const monthDiff = (hoje.getFullYear() - paymentDate.getFullYear()) * 12 + (hoje.getMonth() - paymentDate.getMonth());
                        monthIndex = 11 - monthDiff; // 11 é o índice do mês atual
                    } else { // thisYear or lastYear
                        monthIndex = paymentDate.getMonth(); // Índice direto do mês
                    }
                    
                    if (monthIndex >= 0 && monthIndex < 12) {
                        monthlyData[monthIndex] += payment.value;
                    }
                }
            });
            
            return { labels, data: monthlyData };
        }

        // (ATUALIZADO) Ideia 5: Filtros de Gráfico
        function getAnnualProducaoData(period) {
            const labels = [];
            const meses = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const hoje = new Date();
            let startDate, endDate;

            // Define o intervalo de datas e os rótulos
            if (period === '12m') {
                endDate = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0); 
                startDate = new Date(hoje.getFullYear(), hoje.getMonth() - 11, 1);
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    labels.push(`${meses[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
                }
            } else if (period === 'thisYear') {
                startDate = new Date(hoje.getFullYear(), 0, 1); 
                endDate = new Date(hoje.getFullYear(), 11, 31); 
                labels.push(...meses.map(m => `${m}/${String(hoje.getFullYear()).slice(-2)}`));
            } else { // lastYear
                const lastYear = hoje.getFullYear() - 1;
                startDate = new Date(lastYear, 0, 1); 
                endDate = new Date(lastYear, 11, 31);
                labels.push(...meses.map(m => `${m}/${String(lastYear).slice(-2)}`));
            }
            
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);

            const monthlyProduction = new Array(12).fill(0);

            // Filtra os contratos
            database.contracts.filter(c => !c.isDeleted && c.parcels && c.parcels.length > 0).forEach(contract => {
                // Usa a data de criação do contrato (ou primeira parcela)
                const createdDate = contract.parcels[0].dueDate ? new Date(contract.parcels[0].dueDate) : new Date(contract.createdDate.seconds * 1000);
                createdDate.setHours(0,0,0,0);

                if (createdDate >= startDate && createdDate <= endDate) {
                    let monthIndex;
                    if (period === '12m') {
                        const monthDiff = (hoje.getFullYear() - createdDate.getFullYear()) * 12 + (hoje.getMonth() - createdDate.getMonth());
                        monthIndex = 11 - monthDiff;
                    } else { // thisYear or lastYear
                        monthIndex = createdDate.getMonth();
                    }
                    
                    if (monthIndex >= 0 && monthIndex < 12) {
                        monthlyProduction[monthIndex] += (contract.totalValue || 0);
                    }
                }
            });

            return { labels, data: monthlyProduction };
        }
        
        // Helper para opções dos gráficos
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#9ca3af',
                            callback: (value) => 'R$ ' + value.toLocaleString('pt-BR')
                        },
                        grid: { color: '#374151' }
                    },
                    x: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'transparent' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#d1d5db' }
                    },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleColor: '#e5e7eb',
                        bodyColor: '#d1d5db',
                        borderColor: '#374151',
                        borderWidth: 1,
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            };
        }

        function getContractStatus(contract) {
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            if (contract.paymentType === 'exito') {
                return (contract.exito?.received) ? 'Concluído' : 'Êxito';
            }

            if (!contract.parcels || contract.parcels.length === 0) {
                return 'Concluído'; // Sem parcelas, considera concluído
            }

            let hasPending = false;
            for (const parcel of contract.parcels) {
                const dueDate = new Date(parcel.dueDate);
                if (!parcel.paid) {
                    hasPending = true;
                    if (dueDate < hoje) {
                        return 'Inadimplente'; // Se qualquer parcela não paga estiver vencida
                    }
                }
            }
            
            return hasPending ? 'Ativo' : 'Concluído';
        }
        
        function getNextParcel(contract) {
            if (!contract.parcels || contract.paymentType === 'exito') return null;
            
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            // Encontra a primeira parcela não paga, ordenada por data
            const sortedParcels = [...contract.parcels].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            return sortedParcels.find(p => !p.paid) || null;
        }

        App.getInadimplentes = () => {
            const inadimplentes = [];
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            database.contracts.forEach(contract => {
                if (contract.isDeleted || !contract.parcels || contract.paymentType === 'exito') {
                    return;
                }
                
                contract.parcels.forEach((parcel, index) => {
                    const dueDate = new Date(parcel.dueDate);
                    if (!parcel.paid && dueDate < hoje) {
                        inadimplentes.push({
                            ...parcel,
                            contract: contract, // Anexa o contrato inteiro para referência
                            parcelIndex: index
                        });
                    }
                });
            });
            
            // Ordena por data de vencimento mais antiga
            inadimplentes.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            return inadimplentes;
        };
        window.App.getInadimplentes = App.getInadimplentes;
        
        // (ATUALIZADO) Ideia 1: Otimizado para ser chamado via Promise.all
        // Agora aceita a parcela específica para evitar recalcular
        App.updateContractValue = async (contract, parcel) => {
            const hoje = new Date();
            const dueDate = new Date(parcel.dueDate);
            
            const diffTime = Math.abs(hoje - dueDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const diffInMonths = Math.max(0, Math.floor(diffDays / 30.44)); // Média de dias no mês
            
            let correctedValue = parcel.value;
            
            try {
                // O cache (Map) já existente em fetchIPCAValue será usado
                const ipcaValue = await fetchIPCAValue(App.proxyUrl, diffInMonths); 
                
                if (ipcaValue) {
                    // Simulação simples de correção (ex: 0.5% = 0.005)
                    // A API do BCB retorna o *índice*. A correção real é (Vlr * IndiceHoje / IndiceVencimento)
                    // Esta API proxy parece retornar a *variação percentual* (ex: 0.45)
                    // Assumindo que ipcaValue é o percentual (ex: 0.45 para 0.45%)
                    const correctionFactor = (parseFloat(ipcaValue) / 100);
                    correctedValue = parcel.value * (1 + correctionFactor);
                }
            } catch (error) {
                console.warn(`Não foi possível buscar IPCA para contrato ${contract.id}. Usando valor original.`);
                // Continua com o valor original se a API falhar
            }
            
            // Cálculo de Juros (1% a.m.) e Multa (2% fixo)
            const jurosAoMes = 0.01;
            const multa = 0.02;

            // Juros simples (pro-rata)
            // (1% / 30 dias) * dias de atraso
            const juros = (correctedValue * (jurosAoMes / 30) * diffDays);
            const valorMulta = (correctedValue * multa);
            
            const interestAndFine = juros + valorMulta;
            const totalUpdatedValue = correctedValue + interestAndFine;

            return {
                originalValue: parcel.value,
                correctedValue: correctedValue,
                interestAndFine: interestAndFine,
                totalUpdatedValue: totalUpdatedValue
            };
        };
        window.App.updateContractValue = App.updateContractValue;
        
        // Função de cache da API (Já existia no código, mantida pela Ideia 1)
        async function fetchIPCAValue(proxyUrl, diffInMonths) {
            // Se 0, é o mais recente. Se > 0, é o de X meses atrás.
            const cacheKey = diffInMonths; 
            
            // Verifica o cache
            if (ipcaCache.has(cacheKey)) {
                return ipcaCache.get(cacheKey);
            }

            try {
                const response = await fetch(`${proxyUrl}?meses=${diffInMonths}`);
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }
                const data = await response.json();
                
                // data é um array, ex: [{ "data": "31/08/2024", "valor": "0.15" }]
                if (data && data.length > 0 && data[0].valor) {
                    const valor = parseFloat(data[0].valor);
                    ipcaCache.set(cacheKey, valor); // Armazena no cache
                    return valor;
                } else {
                    throw new Error("Resposta inesperada da API do BCB.");
                }
            } catch (error) {
                console.error(`Erro ao buscar IPCA (meses=${diffInMonths}):`, error);
                return null; // Retorna nulo em caso de falha
            }
        }
        
        // --- LÓGICA DA LIXEIRA ---
        
        App.showTrashTab = (tab) => {
            App.currentTrashTab = tab;
            // Controla tabs
            document.getElementById('trash-tab-contracts').classList.toggle('active-tab', tab === 'contracts');
            document.getElementById('trash-tab-services').classList.toggle('active-tab', tab === 'services');
            // Controla conteúdo
            document.getElementById('trash-content-contracts').classList.toggle('hidden', tab !== 'contracts');
            document.getElementById('trash-content-services').classList.toggle('hidden', tab !== 'services');
            
            if (tab === 'contracts') {
                renderTrashContracts();
            } else {
                renderTrashServices();
            }
        };
        window.App.showTrashTab = App.showTrashTab;

        function renderTrashContracts() {
            const body = document.getElementById('trash-table-body-contracts');
            const deletedContracts = database.contracts.filter(c => c.isDeleted);
            deletedContracts.sort((a,b) => (b.deletedDate?.seconds || 0) - (a.deletedDate?.seconds || 0));

            if(deletedContracts.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="text-center p-6">Lixeira de contratos vazia.</td></tr>`;
                return;
            }
            body.innerHTML = deletedContracts.map(c => `
                <tr>
                    <td>${c.clientName}</td>
                    <td>${c.serviceName}</td>
                    <td>${formatCurrency(c.totalValue)}</td>
                    <td>${c.deletedDate ? formatDate(c.deletedDate.seconds * 1000) : 'N/A'}</td>
                    <td class="space-x-4">
                        <button class="action-btn btn-restore" title="Restaurar" onclick="App.restoreContract('${c.id}')"><i class="fas fa-undo"></i></button>
                        <button class="action-btn btn-delete" title="Excluir Permanentemente" onclick="App.deleteContractPermanent('${c.id}')"><i class="fas fa-fire-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderTrashServices() {
            const body = document.getElementById('trash-table-body-services');
            const deletedServices = database.services.filter(s => s.isDeleted);
            deletedServices.sort((a,b) => (b.deletedDate?.seconds || 0) - (a.deletedDate?.seconds || 0));

            if(deletedServices.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="text-center p-6">Lixeira de serviços vazia.</td></tr>`;
                return;
            }
            body.innerHTML = deletedServices.map(s => {
                const contract = database.contracts.find(c => c.id === s.contractId);
                return `
                <tr>
                    <td>${s.name}</td>
                    <td>${contract ? contract.clientName : 'Contrato não encontrado'}</td>
                    <td>${s.status}</td>
                    <td>${s.deletedDate ? formatDate(s.deletedDate.seconds * 1000) : 'N/A'}</td>
                    <td class="space-x-4">
                        <button class="action-btn btn-restore" title="Restaurar" onclick="App.restoreService('${s.id}')"><i class="fas fa-undo"></i></button>
                        <button class="action-btn btn-delete" title="Excluir Permanentemente" onclick="App.deleteServicePermanent('${s.id}')"><i class="fas fa-fire-alt"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // --- Formatação ---
        const formatCurrency = (value) => {
            if (typeof value !== 'number') value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        const formatDate = (dateInput) => {
            // Aceita string, timestamp do Firestore ou objeto Date
            let date;
            if (typeof dateInput === 'string') {
                date = new Date(dateInput);
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); // Ajusta fuso
            } else if (dateInput && typeof dateInput.seconds === 'number') {
                date = new Date(dateInput.seconds * 1000);
            } else if (dateInput instanceof Date) {
                date = dateInput;
            } else {
                return 'N/A';
            }
            return date.toLocaleDateString('pt-BR');
        };

        // --- LÓGICA DE MODAIS ---
        function setupModalListeners() {
            // Modal Principal (Contrato)
            document.getElementById('openModalBtn').addEventListener('click', App.openContractModal);
            document.getElementById('closeModalBtn').addEventListener('click', App.closeContractModal);
            document.getElementById('cancelModalBtn').addEventListener('click', App.closeContractModal);
            
            // Modal de Relatório
            document.getElementById('openReportModalBtn').addEventListener('click', App.openReportModal);
            document.getElementById('closeReportModalBtn').addEventListener('click', () => document.getElementById('reportModal').classList.add('hidden'));
            document.getElementById('generateReportBtn').addEventListener('click', App.showMonthlyReport);

            // Modal de Alerta
            document.getElementById('closeAlertModalBtn').addEventListener('click', hideModal);
            document.getElementById('confirmAlertModalBtn').addEventListener('click', hideModal);
        }

        // Modais de Loading e Alerta
        function showLoading(message = "A carregar...") {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }
        function showModal(title, message) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }
        function hideModal() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        // --- LÓGICA DO FORMULÁRIO (MODAL CONTRATO) ---
        function setupFormListeners() {
            const form = document.getElementById('contractForm');
            form.addEventListener('submit', App.saveContract);

            // Troca de Tipo de Pagamento
            document.querySelectorAll('input[name="paymentType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isParcelado = e.target.value === 'parcelado';
                    document.getElementById('parcelas-section').classList.toggle('hidden', !isParcelado);
                    document.getElementById('exito-section').classList.toggle('hidden', isParcelado);
                });
            });

            // Gerador de Parcelas
            document.getElementById('generateParcelsBtn').addEventListener('click', generateParcelsPreview);
            
            // Checkbox "Êxito Recebido"
            document.getElementById('exitoReceived').addEventListener('change', (e) => {
                 document.getElementById('exito-received-details').classList.toggle('hidden', !e.target.checked);
                 if(e.target.checked) {
                     // Preenche data e valor (se vazio)
                     if(!document.getElementById('exitoReceivedDate').value) {
                        document.getElementById('exitoReceivedDate').valueAsDate = new Date();
                     }
                     if(!document.getElementById('exitoReceivedValue').value) {
                        const totalValue = parseFloat(document.getElementById('totalValue').value) || 0;
                        const exitoValue = parseFloat(document.getElementById('exitoValue').value) || 0;
                        const exitoType = document.getElementById('exitoType').value;
                        
                        let calculatedValue = 0;
                        if(exitoType === 'percent') {
                            calculatedValue = totalValue * (exitoValue / 100);
                        } else {
                            calculatedValue = exitoValue;
                        }
                        document.getElementById('exitoReceivedValue').value = calculatedValue.toFixed(2);
                     }
                 }
            });
        }
        
        App.openContractModal = (contract = null) => {
            const form = document.getElementById('contractForm');
            form.reset();
            document.getElementById('parcels-container').innerHTML = '';
            
            // Reseta tipo de pagamento para o padrão
            document.querySelector('input[name="paymentType"][value="parcelado"]').checked = true;
            document.getElementById('parcelas-section').classList.remove('hidden');
            document.getElementById('exito-section').classList.add('hidden');
            document.getElementById('exito-received-details').classList.add('hidden');

            if (contract) {
                // Modo Edição
                document.getElementById('modalTitle').textContent = 'Editar Contrato';
                document.getElementById('contractId').value = contract.id;
                document.getElementById('createdDate').value = contract.createdDate?.seconds ? (contract.createdDate.seconds * 1000) : new Date().getTime();
                document.getElementById('clientName').value = contract.clientName;
                document.getElementById('lawyerName').value = contract.lawyerName;
                document.getElementById('serviceName').value = contract.serviceName;
                document.getElementById('totalValue').value = contract.totalValue;

                // Preenche tipo de pagamento
                const paymentType = contract.paymentType || 'parcelado';
                document.querySelector(`input[name="paymentType"][value="${paymentType}"]`).checked = true;
                
                if (paymentType === 'parcelado' && contract.parcels) {
                    document.getElementById('parcelas-section').classList.remove('hidden');
                    document.getElementById('exito-section').classList.add('hidden');
                    // Preenche a primeira parcela e o número (para referência)
                    document.getElementById('numParcels').value = contract.parcels.length;
                    if(contract.parcels.length > 0) {
                        document.getElementById('firstDueDate').value = contract.parcels[0].dueDate;
                        document.getElementById('parcelValue').value = contract.parcels[0].value;
                    }
                    // Renderiza as parcelas editáveis
                    renderParcelsPreview(contract.parcels);
                } else if (paymentType === 'exito' && contract.exito) {
                    document.getElementById('parcelas-section').classList.add('hidden');
                    document.getElementById('exito-section').classList.remove('hidden');
                    document.getElementById('exitoType').value = contract.exito.type || 'percent';
                    document.getElementById('exitoValue').value = contract.exito.value || 0;
                    
                    if(contract.exito.received) {
                        document.getElementById('exitoReceived').checked = true;
                        document.getElementById('exito-received-details').classList.remove('hidden');
                        document.getElementById('exitoReceivedValue').value = contract.exito.receivedValue || 0;
                        document.getElementById('exitoReceivedDate').value = contract.exito.receivedDate || '';
                    } else {
                        document.getElementById('exitoReceived').checked = false;
                        document.getElementById('exito-received-details').classList.add('hidden');
                    }
                }
                
            } else {
                // Modo Novo
                document.getElementById('modalTitle').textContent = 'Novo Contrato';
                document.getElementById('contractId').value = '';
                document.getElementById('createdDate').value = new Date().getTime(); // Agora (em milissegundos)
            }
            
            document.getElementById('contractModal').classList.remove('hidden');
        };
        window.App.openContractModal = App.openContractModal;

        App.closeContractModal = () => {
            document.getElementById('contractModal').classList.add('hidden');
            document.getElementById('contractForm').reset();
            document.getElementById('parcels-container').innerHTML = '';
        };
        window.App.closeContractModal = App.closeContractModal;

        function generateParcelsPreview() {
            const totalValue = parseFloat(document.getElementById('totalValue').value);
            const numParcels = parseInt(document.getElementById('numParcels').value);
            const firstDueDateStr = document.getElementById('firstDueDate').value;

            if (isNaN(totalValue) || isNaN(numParcels) || !firstDueDateStr || numParcels <= 0) {
                showModal("Dados Inválidos", "Por favor, preencha o Valor Total, Nº de Parcelas e 1º Vencimento.");
                return;
            }
            
            const firstDueDate = new Date(firstDueDateStr);
            // Ajuste de fuso horário (input date é local)
            firstDueDate.setMinutes(firstDueDate.getMinutes() + firstDueDate.getTimezoneOffset());
            
            const parcelValue = parseFloat((totalValue / numParcels).toFixed(2));
            const diff = parseFloat((totalValue - (parcelValue * numParcels)).toFixed(2));

            let parcels = [];
            for (let i = 0; i < numParcels; i++) {
                const dueDate = new Date(firstDueDate.getFullYear(), firstDueDate.getMonth() + i, firstDueDate.getDate());
                
                let currentParcelValue = parcelValue;
                if (i === 0) {
                    currentParcelValue = parseFloat((parcelValue + diff).toFixed(2)); // Ajusta a primeira parcela
                }
                
                parcels.push({
                    id: i + 1,
                    value: currentParcelValue,
                    dueDate: dueDate.toISOString().split('T')[0], // Formato YYYY-MM-DD
                    paid: false,
                    paymentDate: null
                });
            }
            
            // Preenche o valor da parcela no campo (para referência)
            document.getElementById('parcelValue').value = parcelValue.toFixed(2);
            
            renderParcelsPreview(parcels);
        }

        function renderParcelsPreview(parcels) {
            const container = document.getElementById('parcels-container');
            container.innerHTML = parcels.map((parcel, index) => `
                <div class="grid grid-cols-4 gap-3 items-center" data-index="${index}">
                    <span class="text-white font-medium p-2">#${parcel.id}</span>
                    <input type="date" value="${parcel.dueDate}" class="parcel-duedate w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-sm">
                    <input type="number" step="0.01" value="${parcel.value}" class="parcel-value w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-sm">
                    <div class="flex items-center">
                        <input type="checkbox" ${parcel.paid ? 'checked' : ''} class="parcel-paid text-primary focus:ring-primary h-5 w-5 mr-3">
                        <input type="date" value="${parcel.paymentDate || ''}" class="parcel-paymentdate w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-sm ${parcel.paid ? '' : 'hidden'}">
                    </div>
                </div>
            `).join('');
            
            // Adiciona listeners para os checkboxes de "pago"
            container.querySelectorAll('.parcel-paid').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const paymentDateInput = e.target.closest('.grid').querySelector('.parcel-paymentdate');
                    paymentDateInput.classList.toggle('hidden', !e.target.checked);
                    if(e.target.checked && !paymentDateInput.value) {
                        // Preenche a data de pagamento com hoje se estiver vazio
                        paymentDateInput.valueAsDate = new Date();
                    }
                });
            });
        }
        
        // --- LÓGICA DE CRUD (CONTRATO E SERVIÇO) ---

        App.saveContract = async (e) => {
            e.preventDefault();
            showLoading("A salvar contrato...");

            const contractId = document.getElementById('contractId').value;
            const createdTimestamp = document.getElementById('createdDate').value;
            
            const contractData = {
                clientName: document.getElementById('clientName').value,
                lawyerName: document.getElementById('lawyerName').value,
                serviceName: document.getElementById('serviceName').value,
                totalValue: parseFloat(document.getElementById('totalValue').value),
                paymentType: document.querySelector('input[name="paymentType"]:checked').value,
                parcels: [],
                exito: null,
                isDeleted: false,
                // Converte o timestamp (ms) de volta para o formato Firestore
                createdDate: Timestamp.fromMillis(parseInt(createdTimestamp)), 
            };
            
            const batch = writeBatch(db);
            let service = null;

            if (contractData.paymentType === 'parcelado') {
                // Coleta dados das parcelas
                document.querySelectorAll('#parcels-container .grid').forEach(row => {
                    const id = parseInt(row.querySelector('span').textContent.replace('#', ''));
                    const dueDate = row.querySelector('.parcel-duedate').value;
                    const value = parseFloat(row.querySelector('.parcel-value').value);
                    const paid = row.querySelector('.parcel-paid').checked;
                    const paymentDate = row.querySelector('.parcel-paymentdate').value || null;
                    
                    contractData.parcels.push({ id, dueDate, value, paid, paymentDate });
                    
                    // Se a parcela foi paga, registra/atualiza o pagamento
                    if(paid && paymentDate) {
                        const paymentId = `${contractId || 'new'}_p_${id}`; // ID único para o pagamento
                        const paymentRef = doc(db, `artifacts/${appId}/users/${App.userId}/payments`, paymentId);
                        batch.set(paymentRef, {
                            contractId: contractId || 'new', // Será atualizado depois se for novo
                            type: 'parcela',
                            value: value,
                            date: paymentDate
                        });
                    }
                });
            } else {
                // Coleta dados do êxito
                const exitoReceived = document.getElementById('exitoReceived').checked;
                const exitoReceivedValue = parseFloat(document.getElementById('exitoReceivedValue').value) || 0;
                const exitoReceivedDate = document.getElementById('exitoReceivedDate').value || null;

                contractData.exito = {
                    type: document.getElementById('exitoType').value,
                    value: parseFloat(document.getElementById('exitoValue').value) || 0,
                    received: exitoReceived,
                    receivedValue: exitoReceivedValue,
                    receivedDate: exitoReceivedDate
                };
                
                // Se o êxito foi recebido, registra/atualiza o pagamento
                if(exitoReceived && exitoReceivedDate) {
                    const paymentId = `${contractId || 'new'}_exito`; // ID único
                    const paymentRef = doc(db, `artifacts/${appId}/users/${App.userId}/payments`, paymentId);
                     batch.set(paymentRef, {
                        contractId: contractId || 'new', // Será atualizado depois
                        type: 'exito',
                        value: exitoReceivedValue,
                        date: exitoReceivedDate
                    });
                }
            }

            try {
                let docRef;
                if (contractId) {
                    // Atualiza Contrato
                    docRef = doc(db, `artifacts/${appId}/users/${App.userId}/contracts`, contractId);
                    batch.update(docRef, contractData);

                    // Atualiza Serviço (se existir)
                    const existingService = database.services.find(s => s.contractId === contractId && !s.isDeleted);
                    if (existingService) {
                        const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, existingService.id);
                        batch.update(serviceRef, {
                            name: contractData.serviceName,
                            clientName: contractData.clientName // Sincroniza nome
                        });
                        service = { ...existingService, name: contractData.serviceName, clientName: contractData.clientName };
                    }
                    
                } else {
                    // Novo Contrato
                    docRef = doc(collection(db, `artifacts/${appId}/users/${App.userId}/contracts`));
                    batch.set(docRef, contractData);
                    
                    // (NOVO) Corrige IDs de pagamento no batch
                    if (contractData.paymentType === 'parcelado') {
                         contractData.parcels.forEach(parcel => {
                             if(parcel.paid && parcel.paymentDate) {
                                const oldPaymentId = `new_p_${parcel.id}`;
                                const newPaymentId = `${docRef.id}_p_${parcel.id}`;
                                // Isso é uma limitação do batch, não podemos ler e escrever.
                                // Vamos ter que salvar o contrato e depois os pagamentos.
                                // VOU REMOVER O BATCH de pagamentos por enquanto para simplificar.
                                // TODO: Re-implementar pagamentos com IDs corretos após salvar.
                             }
                         });
                    }
                    // A LÓGICA DE PAGAMENTOS FOI REMOVIDA DO BATCH PARA SIMPLICIDADE
                    // TODO: Salvar pagamentos *depois* que o contrato é salvo (em um 2º passo)
                    
                    // Cria Serviço associado
                    const serviceRef = doc(collection(db, `artifacts/${appId}/users/${App.userId}/services`));
                    service = {
                        id: serviceRef.id,
                        contractId: docRef.id,
                        name: contractData.serviceName,
                        clientName: contractData.clientName,
                        status: 'pendente', // Padrão
                        prazo: contractData.parcels.length > 0 ? contractData.parcels[contractData.parcels.length - 1].dueDate : null,
                        isDeleted: false,
                        createdDate: Timestamp.now()
                    };
                    batch.set(serviceRef, service);
                    
                    contractData.id = docRef.id; // Adiciona ID para o cache local
                }

                // A LÓGICA DE PAGAMENTOS FOI MOVIDA PARA FORA DO BATCH
                // (O batch foi removido, salvando um por um)

                if(contractId) {
                    // ATUALIZAÇÃO
                    const contractRef = doc(db, `artifacts/${appId}/users/${App.userId}/contracts`, contractId);
                    await updateDoc(contractRef, contractData);
                    
                    if(service) {
                         const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, service.id);
                         await updateDoc(serviceRef, { name: service.name, clientName: service.clientName });
                    }
                    
                    // Atualiza cache local
                    const index = database.contracts.findIndex(c => c.id === contractId);
                    database.contracts[index] = { ...database.contracts[index], ...contractData };
                    if(service) {
                        const sIndex = database.services.findIndex(s => s.id === service.id);
                        database.services[sIndex] = service;
                    }
                    
                } else {
                    // CRIAÇÃO
                    const contractRef = await addDoc(collection(db, `artifacts/${appId}/users/${App.userId}/contracts`), contractData);
                    contractData.id = contractRef.id;
                    
                    // Cria serviço
                    service.contractId = contractRef.id; // Define o ID do contrato
                    const serviceRef = await addDoc(collection(db, `artifacts/${appId}/users/${App.userId}/services`), service);
                    service.id = serviceRef.id;

                    // Atualiza cache local
                    database.contracts.push(contractData);
                    database.services.push(service);
                }
                
                // (NOVO) Salva/Atualiza pagamentos (AGORA COM IDs CORRETOS)
                await savePaymentsFromContract(contractData);
                
                hideLoading();
                App.closeContractModal();
                App.navigateTo(App.currentPage); // Recarrega a página atual

            } catch (error) {
                console.error("Erro ao salvar contrato: ", error);
                hideLoading();
                showModal("Erro", "Não foi possível salvar o contrato.");
            }
        };
        window.App.saveContract = App.saveContract;

        // (NOVO) Função separada para salvar pagamentos (pós-salvar contrato)
        async function savePaymentsFromContract(contract) {
            const batch = writeBatch(db);
            const paymentsToCache = [];
            
            if (contract.paymentType === 'parcelado') {
                contract.parcels.forEach(parcel => {
                    const paymentId = `${contract.id}_p_${parcel.id}`;
                    const paymentRef = doc(db, `artifacts/${appId}/users/${App.userId}/payments`, paymentId);
                    
                    if(parcel.paid && parcel.paymentDate) {
                        const paymentData = {
                            id: paymentId,
                            contractId: contract.id,
                            type: 'parcela',
                            value: parcel.value,
                            date: parcel.paymentDate
                        };
                        batch.set(paymentRef, paymentData);
                        paymentsToCache.push(paymentData);
                    } else {
                        // Se não está paga, remove o registro de pagamento (caso exista)
                        batch.delete(paymentRef);
                    }
                });
            } else if (contract.paymentType === 'exito') {
                const paymentId = `${contract.id}_exito`;
                const paymentRef = doc(db, `artifacts/${appId}/users/${App.userId}/payments`, paymentId);

                if (contract.exito.received && contract.exito.receivedDate) {
                     const paymentData = {
                        id: paymentId,
                        contractId: contract.id,
                        type: 'exito',
                        value: contract.exito.receivedValue,
                        date: contract.exito.receivedDate
                    };
                    batch.set(paymentRef, paymentData);
                    paymentsToCache.push(paymentData);
                } else {
                    // Se não foi recebido, remove o registro
                    batch.delete(paymentRef);
                }
            }
            
            try {
                await batch.commit();
                
                // Atualiza o cache de pagamentos local
                // Remove todos os pagamentos antigos deste contrato
                database.payments = database.payments.filter(p => p.contractId !== contract.id);
                // Adiciona os novos
                database.payments.push(...paymentsToCache);
                
            } catch (error) {
                console.error("Erro ao salvar pagamentos:", error);
            }
        }

        App.editContract = (id) => {
            const contract = database.contracts.find(c => c.id === id);
            if (contract) {
                App.openContractModal(contract);
            }
        };
        window.App.editContract = App.editContract;

        App.deleteContract = async (id) => {
            if (!confirm("Tem a certeza que quer enviar este contrato para a lixeira?")) return;
            
            showLoading("A enviar para a lixeira...");
            try {
                const contractRef = doc(db, `artifacts/${appId}/users/${App.userId}/contracts`, id);
                await updateDoc(contractRef, {
                    isDeleted: true,
                    deletedDate: Timestamp.now()
                });
                
                // Atualiza cache
                const contract = database.contracts.find(c => c.id === id);
                contract.isDeleted = true;
                contract.deletedDate = Timestamp.now();
                
                hideLoading();
                App.renderMainPage(); // Recarrega
            } catch (error) {
                console.error("Erro ao excluir (soft delete) contrato:", error);
                hideLoading();
            }
        };
        window.App.deleteContract = App.deleteContract;

        App.restoreContract = async (id) => {
            showLoading("A restaurar contrato...");
            try {
                const contractRef = doc(db, `artifacts/${appId}/users/${App.userId}/contracts`, id);
                await updateDoc(contractRef, {
                    isDeleted: false,
                    deletedDate: null
                });
                
                // Atualiza cache
                const contract = database.contracts.find(c => c.id === id);
                contract.isDeleted = false;
                contract.deletedDate = null;
                
                hideLoading();
                App.renderTrashPage(); // Recarrega lixeira
            } catch (error) {
                console.error("Erro ao restaurar contrato:", error);
                hideLoading();
            }
        };
        window.App.restoreContract = App.restoreContract;

        App.deleteContractPermanent = async (id) => {
             if (!confirm("EXCLUSÃO PERMANENTE.\n\nTem ABSOLUTA certeza? Isto não pode ser desfeito e apagará o contrato e serviços associados.")) return;
             
             showLoading("A excluir permanentemente...");
             try {
                const batch = writeBatch(db);
                
                // 1. Apaga contrato
                const contractRef = doc(db, `artifacts/${appId}/users/${App.userId}/contracts`, id);
                batch.delete(contractRef);
                
                // 2. Apaga serviços associados
                const servicesToDelete = database.services.filter(s => s.contractId === id);
                servicesToDelete.forEach(s => {
                    const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, s.id);
                    batch.delete(serviceRef);
                });
                
                // 3. Apaga pagamentos associados
                const paymentsToDelete = database.payments.filter(p => p.contractId === id);
                paymentsToDelete.forEach(p => {
                    const paymentRef = doc(db, `artifacts/${appId}/users/${App.userId}/payments`, p.id);
                    batch.delete(paymentRef);
                });

                await batch.commit();
                
                // Atualiza cache local
                database.contracts = database.contracts.filter(c => c.id !== id);
                database.services = database.services.filter(s => s.contractId !== id);
                database.payments = database.payments.filter(p => p.contractId !== id);
                
                hideLoading();
                App.renderTrashPage();
             } catch (error) {
                 console.error("Erro ao excluir permanentemente:", error);
                 hideLoading();
             }
        };
        window.App.deleteContractPermanent = App.deleteContractPermanent;
        
        App.deleteService = async (id) => {
            // Soft delete (para a lixeira)
            if (!confirm("Tem a certeza que quer enviar este serviço para a lixeira?")) return;
            
            showLoading("A enviar para a lixeira...");
            try {
                const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, id);
                await updateDoc(serviceRef, {
                    isDeleted: true,
                    deletedDate: Timestamp.now()
                });
                
                // Atualiza cache
                const service = database.services.find(s => s.id === id);
                service.isDeleted = true;
                service.deletedDate = Timestamp.now();
                
                hideLoading();
                App.renderServicosPage(); // Recarrega Kanban
            } catch (error) {
                console.error("Erro ao excluir (soft delete) serviço:", error);
                hideLoading();
            }
        };
        window.App.deleteService = App.deleteService;
        
        App.restoreService = async (id) => {
            showLoading("A restaurar serviço...");
            try {
                const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, id);
                await updateDoc(serviceRef, {
                    isDeleted: false,
                    deletedDate: null
                });
                
                // Atualiza cache
                const service = database.services.find(s => s.id === id);
                service.isDeleted = false;
                service.deletedDate = null;
                
                hideLoading();
                App.renderTrashPage(); // Recarrega lixeira
            } catch (error) {
                console.error("Erro ao restaurar serviço:", error);
                hideLoading();
            }
        };
        window.App.restoreService = App.restoreService;
        
        App.deleteServicePermanent = async (id) => {
            if (!confirm("EXCLUSÃO PERMANENTE.\n\nTem ABSOLUTA certeza? O contrato associado NÃO será apagado.")) return;
             
            showLoading("A excluir serviço...");
            try {
                const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, id);
                await deleteDoc(serviceRef);
                
                // Atualiza cache
                database.services = database.services.filter(s => s.id !== id);
                
                hideLoading();
                App.renderTrashPage();
            } catch (error) {
                console.error("Erro ao excluir permanentemente serviço:", error);
                hideLoading();
            }
        };
        window.App.deleteServicePermanent = App.deleteServicePermanent;

        // --- LÓGICA DO KANBAN (DRAG & DROP) ---
        function setupKanbanListeners() {
            const lists = document.querySelectorAll('.kanban-list');
            lists.forEach(list => {
                new Sortable(list, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: async (evt) => {
                        const serviceId = evt.item.dataset.serviceId;
                        const newStatus = evt.to.dataset.status;
                        
                        // O 'prazo-proximo' não é um status, é uma view. Mapeia de volta.
                        const targetStatus = (newStatus === 'prazo-proximo') ? 'pendente' : newStatus;
                        
                        // Atualiza no DB
                        showLoading("A atualizar status...");
                        try {
                            const serviceRef = doc(db, `artifacts/${appId}/users/${App.userId}/services`, serviceId);
                            await updateDoc(serviceRef, { status: targetStatus });
                            
                            // Atualiza cache
                            const service = database.services.find(s => s.id === serviceId);
                            service.status = targetStatus;
                            
                            hideLoading();
                            App.renderServicosPage(); // Re-renderiza para garantir a ordem e classes corretas
                        } catch (error) {
                            console.error("Erro ao atualizar status do serviço:", error);
                            hideLoading();
                            // Reverte visualmente (ou recarrega)
                            App.renderServicosPage();
                        }
                    }
                });
            });
        }
        
        // --- LÓGICA DO RELATÓRIO MENSAL ---
        
        App.openReportModal = () => {
            // Preenche os selects de Mês e Ano
            const monthSelect = document.getElementById('reportMonth');
            const yearSelect = document.getElementById('reportYear');
            const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const hoje = new Date();
            const currentMonth = hoje.getMonth();
            const currentYear = hoje.getFullYear();

            // Meses
            if (monthSelect.options.length === 0) {
                monthSelect.innerHTML = meses.map((mes, index) => 
                    `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${mes}</option>`
                ).join('');
            } else {
                 monthSelect.value = currentMonth;
            }

            // Anos (últimos 5 anos + atual)
            if (yearSelect.options.length === 0) {
                let yearOptions = '';
                for (let i = 0; i < 5; i++) {
                    const year = currentYear - i;
                    yearOptions += `<option value="${year}" ${i === 0 ? 'selected' : ''}>${year}</option>`;
                }
                yearSelect.innerHTML = yearOptions;
            } else {
                yearSelect.value = currentYear;
            }
            
            // Limpa resultado anterior
            document.getElementById('reportResult').innerHTML = `<p class="text-dark-text-light text-center">Selecione o mês e ano para gerar o relatório.</p>`;
            document.getElementById('reportModal').classList.remove('hidden');
        };
        window.App.openReportModal = App.openReportModal;

        // (ATUALIZADO) Ideia 4: Estilo do Relatório
        App.showMonthlyReport = () => {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const reportResult = document.getElementById('reportResult');
            
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0); // Último dia do mês
            endDate.setHours(23, 59, 59);

            // 1. Faturamento (Pagamentos recebidos no período)
            const receivedPayments = database.payments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate >= startDate && paymentDate <= endDate;
            });
            const totalReceived = receivedPayments.reduce((sum, p) => sum + p.value, 0);
            const totalExito = receivedPayments.filter(p => p.type === 'exito').reduce((sum, p) => sum + p.value, 0);

            // 2. Produção (Novos contratos no período)
            const newContracts = database.contracts.filter(c => {
                const createdDate = new Date(c.createdDate.seconds * 1000);
                return createdDate >= startDate && createdDate <= endDate && !c.isDeleted;
            });
            const totalValueNewContracts = newContracts.reduce((sum, c) => sum + c.totalValue, 0);

            // 3. Inadimplência (Parcelas vencidas *no fim* desse mês)
            const inadimplentesNoMes = [];
            database.contracts.forEach(c => {
                if (c.isDeleted || !c.parcels) return;
                c.parcels.forEach(p => {
                    const dueDate = new Date(p.dueDate);
                    // Venceu *até* o fim do mês E (não foi paga OU foi paga *depois* do fim do mês)
                    if (dueDate <= endDate && (!p.paid || (p.paid && new Date(p.paymentDate) > endDate))) {
                        inadimplentesNoMes.push(p);
                    }
                });
            });
            const totalInadimplente = inadimplentesNoMes.reduce((sum, p) => sum + p.value, 0);
            
            // (NOVO) Renderiza HTML Estilizado
            let reportHtml = `<div class="space-y-4">`;

            // Card Resumo
            reportHtml += `
                <div class="bg-gray-800 p-4 rounded-lg shadow border border-gray-700">
                    <h4 class="text-lg font-semibold text-white mb-3">Resumo do Mês</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <span class="text-dark-text-light">Total Recebido:</span> 
                        <span class="font-bold text-green-400 text-right">${formatCurrency(totalReceived)}</span>
                        
                        <span class="text-dark-text-light">Novos Contratos (Valor):</span> 
                        <span class="font-bold text-sky-400 text-right">${formatCurrency(totalValueNewContracts)}</span>
                        
                        <span class="text-dark-text-light">Inadimplência (Acum.):</span> 
                        <span class="font-bold text-red-400 text-right">${formatCurrency(totalInadimplente)}</span>
                    </div>
                </div>`;
            
            // Card Recebimentos
            reportHtml += `
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-indigo-400 mb-2">Detalhes de Recebimentos</h4>
                    <div class="flex justify-between text-sm"><span>Pagamentos de Parcelas:</span> <span class="font-medium">${formatCurrency(totalReceived - totalExito)}</span></div>
                    <div class="flex justify-between text-sm"><span>Pagamentos de Êxito:</span> <span class="font-medium">${formatCurrency(totalExito)}</span></div>
                    <div class="flex justify-between text-sm mt-2 pt-2 border-t border-gray-700"><strong>Total:</strong> <strong class="text-green-400">${formatCurrency(totalReceived)}</strong></div>
                </div>`;

            // Card Produção
            reportHtml += `
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-sky-400 mb-2">Detalhes de Produção</h4>
                    <div class="flex justify-between text-sm"><span>Qtd. Novos Contratos:</span> <span class="font-medium">${newContracts.length}</span></div>
                    <div class="flex justify-between text-sm"><span>Valor Total (Novos):</span> <span class="font-medium">${formatCurrency(totalValueNewContracts)}</span></div>
                </div>`;
            
             // Card Inadimplência
            reportHtml += `
                <div class="bg-gray-800 p-4 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-red-400 mb-2">Detalhes de Inadimplência</h4>
                    <div class="flex justify-between text-sm"><span>Qtd. Parcelas Vencidas:</span> <span class="font-medium">${inadimplentesNoMes.length}</span></div>
                    <div class="flex justify-between text-sm"><span>Valor Original (Vencido):</span> <span class="font-medium">${formatCurrency(totalInadimplente)}</span></div>
                </div>`;

            reportHtml += `</div>`;
            reportResult.innerHTML = reportHtml;
        };
        window.App.showMonthlyReport = App.showMonthlyReport;
        
        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', initializeAndAuth);

    </script>

</body>
</html>

