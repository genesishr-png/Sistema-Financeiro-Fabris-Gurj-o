<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira - Advocacia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Biblioteca de Gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            position: relative;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        body::after {
            content: '';
            background-image: url('https://i.postimg.cc/XNs7dp8C/fabris-e-gurjas.png');
            background-repeat: repeat;
            background-attachment: fixed;
            background-size: 300px;
            opacity: 0.03;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            position: fixed;
            z-index: -1;
        }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        .kanban-column { min-width: 320px; }
        .kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px;}
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
        .service-tag {
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            margin-right: 4px;
            margin-bottom: 4px;
            width: 100%; /* Ocupa a largura toda */
        }
        .service-tag-small {
            display: inline-block;
            background-color: #374151; /* gray-700 */
            color: #9ca3af; /* gray-400 */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .service-tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .nav-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            color: #9ca3af; /* gray-400 */
            transition: all 0.2s;
        }
        .nav-tab:hover {
            color: #e5e7eb; /* gray-200 */
        }
        .nav-tab.active {
            border-bottom-color: #6366f1; /* indigo-500 */
            color: #e5e7eb; /* gray-200 */
        }
        .progress-bar-bg {
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .dark-card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .header-with-logo {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-logo {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            max-height: 60px; 
            opacity: 0.8; 
        }
        /* Estilos do Header removidos pois n√£o s√£o mais necess√°rios com o flex */
        .sort-button {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sort-button:hover {
            background-color: #4b5563;
            color: white;
        }
        .sort-button.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        .filter-select {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        #loading-overlay, #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-size: 1.2rem;
            transition: opacity 0.3s;
        }
        #auth-overlay {
            z-index: 99; /* Fica abaixo do loading, mas acima do app */
        }
        #app-container {
            display: none; /* Come√ßa escondido */
        }
    </style>
</head>
<body class="text-gray-300">

    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin mr-3"></i> Conectando...
    </div>

    <!-- Tela de Login -->
    <div id="auth-overlay">
        <div class="w-full max-w-sm p-8 space-y-6 bg-[#1a173a] rounded-lg shadow-xl border border-indigo-800">
            <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Logo" class="w-48 mx-auto">
            <h2 class="text-2xl font-bold text-center text-white">Login</h2>

            <div id="auth-error" class="hidden p-3 text-sm text-red-300 bg-red-800/50 border border-red-700 rounded-lg"></div>

            <!-- Formul√°rio de Login -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-400">Email</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-400">Senha</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                </div>
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-8">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conte√∫do Principal do App (Come√ßa escondido) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="mb-6 header-with-logo">
            <div>
                <h1 class="text-3xl font-bold text-white">Painel de Gest√£o</h1>
                <p class="text-gray-400">Controle Financeiro e de Produ√ß√£o do Escrit√≥rio</p>
        
        <!-- ***** HEADER MODIFICADO ***** -->
        <header class="mb-6 flex justify-between items-center">
            <!-- Bloco Esquerdo: Logo e T√≠tulo -->
            <div class="flex items-center gap-4">
                <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Fabris e Gurj√£o Logo" class="h-12">
                 <h1 class="text-3xl font-bold text-white">Painel de Gest√£o</h1>
                 <!-- Descri√ß√£o removida -->
            </div>
            
            <!-- Bloco Direito: Usu√°rio e Logout -->
            <div class="flex items-center">
                <span id="user-display-name" class="text-sm text-gray-300 font-medium mr-4"></span>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg shadow-md text-sm flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
                <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Fabris e Gurj√£o Logo" class="header-logo" style="position: relative; right: auto; top: auto; transform: none; margin-left: 20px;">
                <!-- Logo removida deste bloco -->
            </div>
        </header>
        <!-- ***** FIM DO HEADER MODIFICADO ***** -->


        <div class="border-b border-gray-700 mb-8">
            <nav class="flex -mb-px">
                <a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="nav-tab active">
                    <i class="fas fa-tachometer-alt mr-2"></i>Painel Principal
                </a>
                <a onclick="window.App.showPage('page-inadimplentes')" id="tab-inadimplentes" class="nav-tab">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Inadimplentes
                </a>
                <a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="nav-tab">
                    <i class="fas fa-tasks mr-2"></i>Servi√ßos
                </a>
                <!-- Nova Aba de Lixeira -->
                <a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="nav-tab">
                    <i class="fas fa-trash-alt mr-2"></i>Lixeira
                </a>
            </nav>
        </div>

        <!-- Conte√∫do da P√°gina: Painel Principal -->
        <div id="page-dashboard">
            <div class="flex flex-wrap gap-4 mb-8">
                <button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> Novo Contrato
                </button>
                <button onclick="window.App.openReportModal()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> Relat√≥rio Mensal
                </button>
                <!-- Bot√£o para Gr√°ficos -->
                <button onclick="window.App.showPage('page-analytics')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-chart-bar"></i> Ver Gr√°ficos
                </button>
            </div>

            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>

            <div class="mb-4 border-b border-gray-700">
                 <h2 class="text-2xl font-semibold mb-4 text-white">Situa√ß√£o das Parcelas</h2>
            </div>

            <div id="kanban-board" class="flex overflow-x-auto space-x-4 pb-4">
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i>Vencidas</h3>
                    <div id="kanban-vencidas" class="kanban-content space-y-3"></div>
                </div>
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-yellow-400 flex items-center gap-2"><i class="far fa-clock"></i>A Vencer (Pr√≥x. 30 dias)</h3>
                    <div id="kanban-a-vencer" class="kanban-content space-y-3"></div>
                </div>
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-gray-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>Pagas (Este M√™s)</h3>
                    <div id="kanban-pagas" class="kanban-content space-y-3"></div>
                </div>
                 <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-indigo-400 flex items-center gap-2"><i class="fas fa-gavel"></i>Aguardando √äxito</h3>
                    <div id="kanban-exito" class="kanban-content space-y-3"></div>
                </div>
            </div>

            <div class="mt-12">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-semibold text-white">Todos os Contratos</h2>
                    <div class="flex items-center gap-4">
                        <button onclick="window.App.exportContractsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2 text-sm">
                            <i class="fas fa-file-csv"></i> Exportar (CSV)
                        </button>
                        <select id="advogadoFilter" onchange="window.App.renderContractList()" class="filter-select"></select>
                        <div class="flex items-center gap-2">
                           <span class="text-sm text-gray-400">Ordenar por:</span>
                           <div id="contractSortButtons" class="flex gap-1"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchInput" onkeyup="window.App.renderContractList()" placeholder="üîé Pesquisar por cliente ou tipo de servi√ßo..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                </div>
                <div id="contractListContainer"></div>
            </div>
        </div>

        <!-- Conte√∫do da P√°gina: Inadimplentes -->
        <div id="page-inadimplentes" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Controle de Inadimplentes</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400">Ordenar por:</span>
                    <div id="inadimplentesSortButtons" class="flex gap-1"></div>
                </div>
            </div>
            <div id="inadimplentesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Conte√∫do da P√°gina: Controle de Servi√ßos -->
        <div id="page-servicos" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-semibold text-white">Controle de Produ√ß√£o de Servi√ßos</h2>
                 <div class="flex items-center gap-4">
                    <select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select"></select>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Ordenar por:</span>
                        <div id="servicosSortButtons" class="flex gap-1"></div>
                    </div>
                    <input type="text" id="servicosSearchInput" onkeyup="window.App.renderServicosPage()" placeholder="üîé Pesquisar..." class="w-full md:w-auto p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                 </div>
            </div>
             <div id="servicosListContainer" class="space-y-6"></div>
        </div>

        <!-- Conte√∫do da P√°gina: An√°lise Gr√°fica -->
        <div id="page-analytics" class="hidden">
            <h2 class="text-2xl font-semibold text-white mb-6">An√°lise Gr√°fica</h2>
            <div class="grid grid-cols-1 gap-6">
                <div class="dark-card p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Recebimentos Totais (√öltimos 12 Meses)</h3>
                    <div class="h-96">
                        <canvas id="faturamentoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do da P√°gina: Lixeira (NOVO) -->
        <div id="page-lixeira" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Lixeira de Contratos</h2>
            </div>
            <p class="text-gray-400 mb-6">Contratos exclu√≠dos s√£o mantidos aqui. Voc√™ pode restaur√°-los ou exclu√≠-los permanentemente.</p>
            <div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- Modais -->
    <!-- Modal: Adicionar Nome (NOVO) -->
    <div id="modalDisplayName" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo(a)!</h2>
            <p class="text-gray-400 mb-4">Percebemos que √© seu primeiro acesso. Como voc√™ gostaria de ser chamado(a)?</p>
            <form id="formDisplayName">
                <div class="mb-4">
                    <label for="inputDisplayName" class="block text-sm font-medium text-gray-400">Seu Nome de Exibi√ß√£o</label>
                    <input type="text" id="inputDisplayName" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar e Entrar</button>
            </form>
        </div>
    </div>

    <div id="modalContrato" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalContratoTitle" class="text-2xl font-bold text-white">Cadastrar Novo Contrato</h2>
                <button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formContrato">
                <input type="hidden" id="contractId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clienteNome" class="block text-sm font-medium text-gray-400">Nome do Cliente</label>
                        <input type="text" id="clienteNome" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                    <div>
                        <label for="advogadoResponsavel" class="block text-sm font-medium text-gray-400">Advogado Respons√°vel</label>
                        <select id="advogadoResponsavel" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                            <option>N√£o Informado</option>
                            <option>Dra. Renata Fabris</option>
                            <option>Dr. Felipe Gurj√£o</option>
                            <option>Dr. Glaison</option>
                            <option>Dr. Bruno D'Lucas</option>
                            <option>Dra. Danielle</option>
                        </select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400">Adicionar Servi√ßos</label>
                    <div id="servicosContainerWrapper" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm">
                        <div id="servicosContainer" class="flex flex-wrap items-center gap-1 w-full mb-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="contratoServicoInput" class="flex-grow outline-none bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="Nome do Servi√ßo...">
                            <input type="date" id="contratoPrazoInput" class="bg-gray-800 border border-gray-600 rounded-md shadow-sm text-gray-400 px-3 py-2" style="color-scheme: dark;">
                            <button type="button" id="addServiceButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Adicionar</button>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="contratoTipoPagamento" class="block text-sm font-medium text-gray-400">Modalidade de Pagamento</label>
                    <select id="contratoTipoPagamento" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                        <option>Parcelado</option>
                        <option>Pr√≥-Abono</option>
                        <option>Entrada √∫nica</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="contratoObservacoes" class="block text-sm font-medium text-gray-400">Observa√ß√µes</label>
                    <textarea id="contratoObservacoes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="Detalhes da negocia√ß√£o, informa√ß√µes do caso, etc..."></textarea>
                </div>
                <h3 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4 text-white">Detalhes Financeiros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="valorTotal" class="block text-sm font-medium text-gray-400">Valor Fixo Total (R$)</label>
                        <input type="number" step="0.01" id="valorTotal" placeholder="0 se for s√≥ √™xito" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
                    </div>
                    <div class="mb-4">
                        <label for="numParcelas" class="block text-sm font-medium text-gray-400">N¬∞ de Parcelas</label>
                        <input type="number" id="numParcelas" placeholder="1 para '√Ä Vista'" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" value="1">
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="vencimentoPrimeiraParcela" class="block text-sm font-medium text-gray-400">Vencimento da 1¬™ Parcela</label>
                    <input type="date" id="vencimentoPrimeiraParcela" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" style="color-scheme: dark;">
                </div>
                <div class="mb-4">
                    <label for="taxaExito" class="block text-sm font-medium text-gray-400">Taxa de √äxito (Bonifica√ß√£o)</label>
                    <input type="text" id="taxaExito" placeholder="Ex: 20%, 10000, 5 SALARIOS" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalPagamento" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
         <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Registrar Pagamento</h2>
                <button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formPagamento">
                <div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded-md text-white"></div>
                <div class="mb-4">
                    <label for="pagamentoValor" class="block text-sm font-medium text-gray-400">Valor Pago (R$)</label>
                    <input type="number" step="0.01" id="pagamentoValor" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
                </div>
                <div class="mb-4">
                    <label for="pagamentoData" class="block text-sm font-medium text-gray-400">Data do Pagamento</label>
                    <input type="date" id="pagamentoData" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required style="color-scheme: dark;">
                </div>
                <input type="hidden" id="pagamentoContractId">
                <input type="hidden" id="pagamentoParcelIndex">
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalCliente" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3">
         <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="clienteModalTitle" class="text-2xl font-bold text-white"></h2>
                <button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="clienteModalContent" class="space-y-6"></div>
        </div>
    </div>

    <div id="modalRelatorio" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Relat√≥rio Financeiro Mensal</h2>
                <button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label for="reportMonth" class="block text-sm font-medium text-gray-400">M√™s</label>
                    <select id="reportMonth" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
                <div class="flex-1">
                    <label for="reportYear" class="block text-sm font-medium text-gray-400">Ano</label>
                    <select id="reportYear" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
            </div>
             <div class="flex gap-4 mb-6">
                <button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Gerar Relat√≥rio</button>
                <button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Exportar (CSV)</button>
             </div>
            <div id="reportResult" class="space-y-3"></div>
        </div>
    </div>

    <div id="modalExito" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Registrar Recebimento de √äxito</h2>
                <button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formExito">
                <div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded-md"></div>
                <div class="mb-4">
                    <label for="exitoValorRecebido" class="block text-sm font-medium text-gray-400">Valor L√≠quido Recebido (R$)</label>
                    <input type="number" step="0.01" id="exitoValorRecebido" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" placeholder="Ex: 9500.00" required>
                </div>
                <input type="hidden" id="exitoContractId">
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Recebimento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop"></div>

    <script type="module">
        // --- IN√çCIO: Importa√ß√µes do Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile // Importar a fun√ß√£o de atualizar perfil
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // --- FIM: Importa√ß√µes do Firebase ---

        // --- OBJETO GLOBAL PARA EXPOR FUN√á√ïES ---
        window.App = {}; // Objeto global para "pendurar" nossas fun√ß√µes

        // --- VARI√ÅVEIS GLOBAIS ---
        let db;
        let auth;
        let contractsCollection;
        let database = { contracts: [] };
        let currentContractSort = 'name-asc';
        let currentInadimplentesSort = 'days-desc';
        let currentServicosSort = 'name-asc';
        let ipcaCache = new Map(); // Cache para os valores do IPCA
        let faturamentoChartInstance = null; // Vari√°vel para guardar a inst√¢ncia do gr√°fico

        // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
        async function initializeAndAuth() {
            try {
                // Suas credenciais do Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4",
                    authDomain: "fabrisgurjao.firebaseapp.com",
                    projectId: "fabrisgurjao",
                    storageBucket: "fabrisgurjao.appspot.com",
                    messagingSenderId: "466702265991",
                    appId: "1:466702265991:web:78c4d98b47cab537921222",
                    measurementId: "G-E99R5TFMQK"
                };

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'fabrisgurjao-app';
                const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '') ? JSON.parse(__firebase_config) : firebaseConfig;

                const app = initializeApp(finalConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Obter a inst√¢ncia do Auth
                setLogLevel('debug');

                // Listener do estado de autentica√ß√£o
                onAuthStateChanged(auth, (user) => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const authOverlay = document.getElementById('auth-overlay');
                    const appContainer = document.getElementById('app-container');

                    if (user) {
                        // Usu√°rio est√° logado
                        if (!user.displayName) {
                            // NOVO: Se √© o primeiro login (sem nome), mostrar o modal de nome
                            loadingOverlay.style.display = 'none';
                            authOverlay.style.display = 'none';
                            appContainer.style.display = 'none';
                            openModal('modalDisplayName');
                        } else {
                            // Login normal: mostrar o app
                            console.log("Usu√°rio logado:", user.displayName);
                            document.getElementById('user-display-name').textContent = user.displayName;
                            authOverlay.style.display = 'none';
                            appContainer.style.display = 'block';

                            contractsCollection = collection(db, `contracts`);
                            setupSnapshotListener();

                            loadingOverlay.style.display = 'none';
                        }
                    } else {
                        // Usu√°rio est√° deslogado
                        console.log("Nenhum usu√°rio logado.");
                        authOverlay.style.display = 'flex';
                        appContainer.style.display = 'none';
                        loadingOverlay.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Erro na inicializa√ß√£o ou autentica√ß√£o:", error);
                document.getElementById('loading-overlay').textContent = "Erro ao conectar. Verifique as credenciais.";
            }
        }

        function setupSnapshotListener() {
            onSnapshot(contractsCollection, (snapshot) => {
                database.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => {
                console.error("Erro ao buscar dados:", error);
                document.getElementById('loading-overlay').textContent = "Erro ao carregar dados. Verifique as regras de seguran√ßa do Firestore.";
            });
        }

        // --- FUN√á√ïES DE NAVEGA√á√ÉO E RENDERIZA√á√ÉO ---
        const showPage = (pageId) => {
            // Esconde todas as p√°ginas
            ['page-dashboard', 'page-inadimplentes', 'page-servicos', 'page-analytics', 'page-lixeira'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).classList.add('hidden');
            });
            // Desativa todas as abas principais
            ['tab-dashboard', 'tab-inadimplentes', 'tab-servicos', 'tab-lixeira'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).classList.remove('active');
            });

            // Mostra a p√°gina clicada
            if(document.getElementById(pageId)) document.getElementById(pageId).classList.remove('hidden');

            // Ativa a aba correspondente, se for uma aba principal
            const tabId = `tab-${pageId.split('-')[1]}`;
            if(document.getElementById(tabId)) {
                document.getElementById(tabId).classList.add('active');
            }

            // Roda a fun√ß√£o espec√≠fica da p√°gina
            if (pageId === 'page-inadimplentes') renderInadimplentesPage();
            if (pageId === 'page-servicos') renderServicosPage();
            if (pageId === 'page-analytics') renderAnalyticsPage();
            if (pageId === 'page-lixeira') renderLixeiraPage(); // Nova
        }
        window.App.showPage = showPage;

        async function render() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay && (!document.getElementById('page-dashboard').classList.contains('hidden') || !document.getElementById('page-inadimplentes').classList.contains('hidden'))) {
                 loadingOverlay.style.display = 'flex';
            }

            if(document.getElementById('page-dashboard') && !document.getElementById('page-dashboard').classList.contains('hidden')) {
                await renderKanban();
                renderContractList();
            }
            if(document.getElementById('page-inadimplentes') && !document.getElementById('page-inadimplentes').classList.contains('hidden')) {
                await renderInadimplentesPage();
            }
            if(document.getElementById('page-servicos') && !document.getElementById('page-servicos').classList.contains('hidden')) {
                renderServicosPage();
            }
            if(document.getElementById('page-analytics') && !document.getElementById('page-analytics').classList.contains('hidden')) {
                renderAnalyticsPage();
            }
            if(document.getElementById('page-lixeira') && !document.getElementById('page-lixeira').classList.contains('hidden')) {
                renderLixeiraPage();
            }

            renderSortButtons();
            renderAdvogadoFilters();

            if (loadingOverlay) loadingOverlay.style.display = 'none';
        }

        async function renderKanban() {
            const kanbanVencidas = document.getElementById('kanban-vencidas');
            const kanbanAVencer = document.getElementById('kanban-a-vencer');
            const kanbanPagas = document.getElementById('kanban-pagas');
            const kanbanExito = document.getElementById('kanban-exito');

            kanbanVencidas.innerHTML = '';
            kanbanAVencer.innerHTML = '';
            kanbanPagas.innerHTML = '';
            kanbanExito.innerHTML = '';

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const trintaDiasFrente = new Date();
            trintaDiasFrente.setDate(hoje.getDate() + 30);

            let totalAVencer30dias = 0;
            let totalVencido = 0;

            for (const contract of database.contracts.filter(c => !c.isDeleted)) { // Filtra lixeira
                if (!contract.parcels) contract.parcels = []; 
                let remainingValue = contract.parcels.reduce((sum, p) => p.status === 'Pendente' ? sum + p.value : sum, 0);

                for (let i = 0; i < contract.parcels.length; i++) {
                    const parcel = contract.parcels[i];
                    const vencimento = new Date(parcel.dueDate);

                    if (parcel.status === 'Paga') {
                         const dataPagamento = new Date(parcel.paymentDate);
                         if(dataPagamento >= primeiroDiaMes && dataPagamento <= hoje) {
                            kanbanPagas.innerHTML += createParcelCard(contract, parcel, i, 'paga', remainingValue);
                         }
                    } else { 
                        if (vencimento < hoje) {
                            const valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate);
                            kanbanVencidas.innerHTML += createParcelCard(contract, parcel, i, 'vencida', remainingValue, valorCorrigido);
                            totalVencido += valorCorrigido; // Soma o valor corrigido
                        } else if (vencimento >= hoje && vencimento <= trintaDiasFrente) {
                            kanbanAVencer.innerHTML += createParcelCard(contract, parcel, i, 'a-vencer', remainingValue);
                            totalAVencer30dias += parcel.value;
                        }
                    }
                }

                if (contract.successFee && !contract.successFeePaymentDate && (contract.parcels || []).every(p => p.status === 'Paga')) {
                    kanbanExito.innerHTML += createExitoCard(contract);
                }
            }

            const totalPagoMes = calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth()).totalGeral;
            renderDashboard(totalAVencer30dias, totalVencido, totalPagoMes, database.contracts.filter(c => !c.isDeleted).length);
        }

        function createParcelCard(contract, parcel, index, type, remainingValue, valorCorrigido = null) {
            const vencimento = new Date(parcel.dueDate);
            const formattedDate = vencimento.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            const formattedValue = parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formattedRemaining = remainingValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            let actionButton = '';
            let statusClass = '';
            let valorHtml = '';

            if (type === 'vencida') {
                statusClass = 'border-red-400';
                valorHtml = `
                    <div class="flex items-center text-gray-400 text-xs">
                        <strong>Original:</strong>
                        <span class="ml-auto font-medium line-through">${formattedValue}</span>
                    </div>
                    <div class="flex items-center text-red-400">
                        <strong>Corrigido:</strong>
                        <span class="ml-auto font-semibold text-lg">${valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                    </div>`;
            } else if (type === 'a-vencer') {
                 statusClass = 'border-yellow-400';
                 valorHtml = `
                    <div class="flex items-center text-gray-300">
                        <i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i>
                        <strong>Valor:</strong>
                        <span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span>
                    </div>`;
            } else { // Paga
                 statusClass = 'border-gray-600';
                 valorHtml = `
                    <div class="flex items-center text-gray-300">
                        <i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i>
                        <strong>Valor:</strong>
                        <span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span>
                    </div>`;
            }

            if (type !== 'paga') {
                actionButton = `<button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-check"></i> Registrar Pagamento</button>`;
            } else {
                 const formattedPaidValue = parcel.valuePaid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                 const paymentDate = new Date(parcel.paymentDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                 actionButton = `<div class="mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded-md font-medium">Pago ${formattedPaidValue} em ${paymentDate}</div>`;
            }

            let extraInfoHtml = `<div class="text-xs text-gray-400 border-t border-gray-700 pt-2 mt-3 flex justify-between"><span>Contrato: <strong>${(contract.totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></span> <span>Restante: <strong>${formattedRemaining}</strong></span></div>`;

            return `
                <div class="dark-card p-4 rounded-lg shadow-md border-l-4 ${statusClass}">
                    <p class="font-bold text-white">${contract.clientName}</p>
                    <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')} - Parcela ${parcel.number}/${contract.parcels.length || 1}</p>
                    <div class="space-y-2 text-sm">
                        ${valorHtml}
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-calendar-alt w-5 text-center mr-2 text-gray-500"></i>
                            <strong>Vencimento:</strong>
                            <span class="ml-auto font-medium">${formattedDate}</span>
                        </div>
                    </div>
                    ${extraInfoHtml}
                    ${actionButton}
                </div>`;
        }

        function createExitoCard(contract) {
            return `
                <div class="dark-card p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                    <p class="font-bold text-white">${contract.clientName}</p>
                    <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
                    <div class="my-4 text-center">
                        <p class="text-sm text-gray-400">Bonifica√ß√£o Pendente</p>
                        <p class="text-2xl font-semibold text-indigo-400">${contract.successFee}</p>
                    </div>
                    <button onclick="window.App.openExitoModal('${contract.id}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-gavel"></i> Registrar Recebimento</button>
                </div>`;
        }

        function renderDashboard(aVencer, vencido, pago, totalContratos) {
            document.getElementById('dashboard').innerHTML = `
                <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">A Receber (Pr√≥x. 30 dias)</h3><p class="text-3xl font-bold text-green-400">${aVencer.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">Vencido (Corrigido)</h3><p class="text-3xl font-bold text-red-400">${vencido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">Recebido (Este M√™s)</h3><p class="text-3xl font-bold text-indigo-400">${pago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">Contratos Ativos</h3><p class="text-3xl font-bold text-white">${totalContratos}</p></div>`;
        }

        const renderContractList = function() {
            const listContainer = document.getElementById('contractListContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const advogadoFilter = document.getElementById('advogadoFilter').value;

            let filteredContracts = database.contracts.filter(c => {
                const notDeleted = !c.isDeleted; // Filtra lixeira
                const matchesAdvogado = advogadoFilter === 'Todos' || c.advogadoResponsavel === advogadoFilter;
                const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || 
                                     (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
                return notDeleted && matchesAdvogado && matchesSearch;
            });

            if (currentContractSort === 'name-asc') {
                filteredContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
            } else if (currentContractSort === 'value-desc') {
                filteredContracts.sort((a, b) => b.totalValue - a.totalValue);
            }

            if (filteredContracts.length === 0) {
                listContainer.innerHTML = '<div class="dark-card p-4 rounded-lg shadow-md text-center text-gray-400 py-4">Nenhum contrato encontrado.</div>';
                return;
            }

            let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
            filteredContracts.forEach(contract => {
                const { statusText, statusColor, borderColor } = getContractStatus(contract);
                let servicesHtml = (contract.serviceTypes || []).map(s => `<span class="service-tag-small">${s.name}</span>`).join('');

                html += `
                    <div class="dark-card rounded-lg shadow-lg overflow-hidden border-l-4 ${borderColor} flex flex-col justify-between transition-all duration-300 transform hover:-translate-y-2 hover:shadow-2xl">
                        <div class="p-5">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-xl text-white">${contract.clientName}</h3>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${statusText}</span>
                            </div>
                            <p class="text-xs text-indigo-300 mb-3"><i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}</p>
                            <div class="mb-4">
                                ${servicesHtml}
                            </div>
                            <div class="border-t border-gray-700 pt-4 space-y-3 text-sm">
                                <div class="flex items-center text-gray-300">
                                    <i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i>
                                    <strong>Valor Fixo:</strong>
                                    <span class="ml-auto font-medium">${(contract.totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                ${contract.successFee ? `
                                <div class="flex items-center text-gray-300">
                                    <i class="fas fa-star w-5 text-center mr-2 text-gray-500"></i>
                                    <strong>√äxito:</strong>
                                    <span class="ml-auto font-medium text-indigo-400">${contract.successFee}</span>
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="bg-gray-900/50 px-4 py-2 flex justify-end gap-2">
                           <button onclick="window.App.openClientHistoryModal('${contract.clientName}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-indigo-400 hover:bg-indigo-900/20 py-1 px-3 rounded-md transition-colors" title="Ver Hist√≥rico do Cliente"><i class="fas fa-eye"></i> Hist√≥rico</button>
                           <button onclick="window.App.openContractModal('${contract.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-green-400 hover:bg-green-900/20 py-1 px-3 rounded-md transition-colors" title="Editar Contrato"><i class="fas fa-pencil-alt"></i> Editar</button>
                           <button onclick="window.App.moveToLixeira('${contract.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-red-400 hover:bg-red-900/20 py-1 px-3 rounded-md transition-colors" title="Excluir Contrato"><i class="fas fa-trash-alt"></i> Excluir</button>
                           <button onclick="window.App.moveToLixeira('${contract.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-red-400 hover:bg-red-900/20 py-1 px-3 rounded-md transition-colors" title="Mover para Lixeira"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            listContainer.innerHTML = html;
        }
        window.App.renderContractList = renderContractList; // Expor ao HTML

        function getContractStatus(contract) {
            const hasPendingParcels = (contract.parcels || []).some(p => p.status === 'Pendente');
            if (hasPendingParcels) {
                return { statusText: 'Ativo', statusColor: 'bg-yellow-900/50 text-yellow-300', borderColor: 'border-yellow-500' };
            }
            if (contract.successFee && !contract.successFeePaymentDate) {
                return { statusText: 'Aguardando √äxito', statusColor: 'bg-indigo-900/50 text-indigo-300', borderColor: 'border-indigo-500' };
            }
            return { statusText: 'Conclu√≠do', statusColor: 'bg-gray-700 text-gray-300', borderColor: 'border-gray-600' };
        }

        async function renderInadimplentesPage() {
            const container = document.getElementById('inadimplentesListContainer');
            container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-indigo-400"></i><p class="mt-2 text-sm text-gray-400">Calculando juros e corre√ß√£o monet√°ria...</p></div>`;
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            let inadimplentesList = [];
            for (const contract of database.contracts.filter(c => !c.isDeleted)) { // Filtra lixeira
                if (!contract.parcels) continue; // Pula se n√£o houver parcelas
                for (let i = 0; i < contract.parcels.length; i++) {
                    const parcel = contract.parcels[i];
                    const vencimento = new Date(parcel.dueDate);
                    if (parcel.status === 'Pendente' && vencimento < hoje) {
                        const diffTime = Math.abs(hoje - vencimento);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate);
                        inadimplentesList.push({ contract, parcel, index: i, diffDays, valorCorrigido });
                    }
                }
            }

            if (currentInadimplentesSort === 'days-desc') {
                inadimplentesList.sort((a, b) => b.diffDays - a.diffDays);
            } else if (currentInadimplentesSort === 'value-desc') {
                inadimplentesList.sort((a, b) => b.valorCorrigido - a.valorCorrigido);
            } else if (currentInadimplentesSort === 'name-asc') {
                inadimplentesList.sort((a, b) => a.contract.clientName.localeCompare(b.contract.clientName));
            }

            if (inadimplentesList.length === 0) {
                container.innerHTML = `<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-10"><div class="inline-block bg-gray-800 border border-gray-700 text-green-400 p-6 rounded-lg shadow-md"><i class="fas fa-check-circle fa-3x mb-3"></i><p class="font-bold text-xl">Nenhuma pend√™ncia encontrada!</p><p class="text-sm text-gray-400">Todos os pagamentos est√£o em dia.</p></div></div>`;
                return;
            }

            let inadimplentesHtml = '';
            inadimplentesList.forEach(({ contract, parcel, index, diffDays, valorCorrigido }) => {
                const vencimento = new Date(parcel.dueDate);
                inadimplentesHtml += `
                    <div class="dark-card p-5 rounded-lg shadow-lg border-l-4 border-red-500">
                        <p class="font-bold text-lg text-white">${contract.clientName}</p>
                        <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
                        
                        <div class="border-t border-gray-700 pt-3 mt-3 space-y-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">Valor Original:</span>
                                <span class="font-medium text-gray-400 line-through">${parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white">Valor Corrigido:</span>
                                <span class="font-semibold text-lg text-red-400">${valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">Venceu em:</span>
                                <span class="font-medium text-gray-300">${vencimento.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span>
                            </div>
                            <div class="flex justify-between items-center text-red-400 font-bold text-sm bg-red-900/30 px-2 py-1 rounded">
                                <span>Atrasado h√°:</span>
                                <span>${diffDays} dia(s)</span>
                            </div>
                        </div>

                        <button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-check"></i> Registrar Pagamento
                        </button>
                    </div>
                `;
            });
            container.innerHTML = inadimplentesHtml;
        }

        const renderServicosPage = () => {
            const container = document.getElementById('servicosListContainer');
            const searchTerm = document.getElementById('servicosSearchInput').value.toLowerCase();
            const advogadoFilter = document.getElementById('servicosAdvogadoFilter').value;
            container.innerHTML = '';

            let activeContracts = database.contracts.filter(c => {
                const notDeleted = !c.isDeleted; // Filtra lixeira
                const isNotConcluded = getContractStatus(c).statusText !== 'Conclu√≠do';
                if (!isNotConcluded || !notDeleted) return false;

                const matchesAdvogado = advogadoFilter === 'Todos' || c.advogadoResponsavel === advogadoFilter;
                const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || 
                                     (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm)) ||
                                     c.advogadoResponsavel.toLowerCase().includes(searchTerm);
                return matchesAdvogado && matchesSearch;
            });

            if (currentServicosSort === 'name-asc') {
                activeContracts.sort((a, b) => a.clientName.localeCompare(b.clientName));
            } else if (currentServicosSort === 'adv-asc') {
                activeContracts.sort((a, b) => a.advogadoResponsavel.localeCompare(b.advogadoResponsavel));
            }

            if (activeContracts.length === 0) {
                 container.innerHTML = `<div class="text-center py-10"><div class="inline-block dark-card text-indigo-400 p-6 rounded-lg shadow-md"><i class="fas fa-coffee fa-3x mb-3"></i><p class="font-bold text-xl">Nenhum contrato ativo encontrado.</p><p class="text-sm text-gray-400">Nenhum resultado para a busca ou todos os trabalhos est√£o conclu√≠dos.</p></div></div>`;
                 return;
            }

            activeContracts.forEach(contract => {
                const totalServices = (contract.serviceTypes || []).length;
                let progressValue = 0;
                (contract.serviceTypes || []).forEach(service => {
                    if (service.status === 'Conclu√≠do') progressValue += 1;
                    else if (service.status === '50% Conclu√≠do') progressValue += 0.5;
                    else if (service.status === 'Em Andamento') progressValue += 0.25;
                });
                const serviceProgress = totalServices > 0 ? (progressValue / totalServices) * 100 : 0;

                const totalPaid = (contract.parcels || []).reduce((sum, p) => sum + (p.valuePaid || 0), 0) + (contract.successFeeValueReceived || 0);
                const financialProgress = contract.totalValue > 0 ? (totalPaid / contract.totalValue) * 100 : (totalPaid > 0 ? 100 : 0);

                let servicesHtml = (contract.serviceTypes || []).map((service, index) => {
                    let statusHtml, actionsHtml;
                    let deadlineHtml = '';

                    if (service.deadline) {
                        const hoje = new Date();
                        const prazo = new Date(service.deadline + "T12:00:00Z"); // Adiciona T12:00:00Z para evitar problemas de fuso
                        const diffTime = prazo - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const formattedPrazo = prazo.toLocaleDateString('pt-BR', {timeZone: 'UTC'});

                        if (diffDays < 0 && service.status !== 'Conclu√≠do') {
                            deadlineHtml = `<span class="text-xs font-medium text-red-400"><i class="fas fa-exclamation-triangle"></i> Vencido: ${formattedPrazo}</span>`;
                        } else if (diffDays <= 7 && service.status !== 'Conclu√≠do') {
                            deadlineHtml = `<span class="text-xs font-medium text-yellow-400"><i class="fas fa-clock"></i> Vence: ${formattedPrazo}</span>`;
                        } else {
                            deadlineHtml = `<span class="text-xs text-gray-500"><i class="far fa-calendar-alt"></i> ${formattedPrazo}</span>`;
                        }
                    }

                    switch(service.status) {
                        case 'Conclu√≠do':
                            statusHtml = `<span class="text-xs font-bold text-teal-400">CONCLU√çDO</span>`;
                            return `<li class="flex items-center justify-between p-2 bg-gray-900/50 rounded-md"><span class="text-gray-500 line-through"><i class="fas fa-check-circle text-teal-500 mr-2"></i>${service.name}</span><div class="flex items-center gap-2">${deadlineHtml}${statusHtml}</div></li>`;
                        case '50% Conclu√≠do':
                            statusHtml = `<span class="text-xs font-bold text-purple-400">50%</span>`;
                            actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'Conclu√≠do')" class="text-xs bg-indigo-600 text-white hover:bg-indigo-500 font-semibold py-1 px-2 rounded-md transition-colors">Concluir</button>`;
                             return `<li class="flex items-center justify-between p-2 hover:bg-gray-700/50 rounded-md text-gray-300"><span><i class="fas fa-adjust text-purple-500 mr-2"></i>${service.name}</span><div class="flex items-center gap-2">${deadlineHtml}${statusHtml}${actionsHtml}</div></li>`;
                        case 'Em Andamento':
                             statusHtml = `<span class="text-xs font-bold text-yellow-400">EM ANDAMENTO</span>`;
                             actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, '50% Conclu√≠do')" class="text-xs bg-purple-600 text-white hover:bg-purple-500 font-semibold py-1 px-2 rounded-md transition-colors">50%</button><button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'Conclu√≠do')" class="text-xs bg-indigo-600 text-white hover:bg-indigo-500 font-semibold py-1 px-2 rounded-md transition-colors">Concluir</button>`;
                             return `<li class="flex items-center justify-between p-2 hover:bg-gray-700/50 rounded-md text-gray-300"><span><i class="fas fa-spinner fa-spin text-yellow-500 mr-2"></i>${service.name}</span><div class="flex items-center gap-2">${deadlineHtml}${statusHtml}${actionsHtml}</div></li>`;
                        default: // Pendente
                            statusHtml = `<span class="text-xs font-bold text-gray-400">PENDENTE</span>`;
                            actionsHtml = `<button onclick="window.App.updateServiceStatus('${contract.id}', ${index}, 'Em Andamento')" class="text-xs bg-yellow-600 text-white hover:bg-yellow-500 font-semibold py-1 px-2 rounded-md transition-colors">Iniciar</button>`;
                            return `<li class="flex items-center justify-between p-2 hover:bg-gray-700/50 rounded-md text-gray-300"><span><i class="far fa-circle text-gray-500 mr-2"></i>${service.name}</span><div class="flex items-center gap-2">${deadlineHtml}${statusHtml}${actionsHtml}</div></li>`;
                    }
                }).join('');

                container.innerHTML += `
                    <div class="dark-card p-5 rounded-lg shadow-lg">
                        <div class="flex justify-between items-start">
                             <h3 class="font-bold text-xl text-indigo-300 mb-4">${contract.clientName}</h3>
                             <p class="text-sm text-gray-400"><i class="fas fa-user-tie mr-1"></i> ${contract.advogadoResponsavel}</p>
                        </div>
                        
                        <div class="space-y-4 mb-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso Financeiro</label><span class="font-medium text-teal-300">${financialProgress.toFixed(0)}%</span></div>
                                <div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-teal-500" style="width: ${financialProgress}%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1 text-gray-300"><label>Progresso dos Servi√ßos</label><span class="font-medium text-indigo-300">${serviceProgress.toFixed(0)}%</span></div>
                                <div class="progress-bar-bg h-3 w-full"><div class="progress-bar bg-indigo-500" style="width: ${serviceProgress}%"></div></div>
                            </div>
                        </div>

                        <div class="border-t border-gray-700 pt-3">
                            <h4 class="font-semibold text-sm mb-2 text-gray-400">Servi√ßos do Contrato:</h4>
                            <ul class="space-y-1">${servicesHtml}</ul>
                        </div>
                    </div>
                `;
            });
        }
        window.App.renderServicosPage = renderServicosPage; // Expor ao HTML

        // --- NOVA FUN√á√ÉO PARA GR√ÅFICOS ---
        function getAnnualChartData() {
            const labels = [];
            const data = [];
            const meses = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const hoje = new Date();

            for (let i = 11; i >= 0; i--) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const month = d.getMonth();
                const year = d.getFullYear();

                labels.push(`${meses[month]}/${String(year).slice(-2)}`);
                const income = calculateMonthlyIncome(year, month);
                data.push(income.totalGeral);
            }
            return { labels, data };
        }

        function renderAnalyticsPage() {
            const ctx = document.getElementById('faturamentoChart').getContext('2d');
            const chartData = getAnnualChartData();

            // Destr√≥i gr√°fico anterior se existir
            if (faturamentoChartInstance) {
                faturamentoChartInstance.destroy();
            }

            // Configura√ß√µes globais do Chart.js para modo escuro
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';

            faturamentoChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Faturamento Total Recebido',
                        data: chartData.data,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)', // Cor indigo-600 com opacidade
                        borderColor: 'rgba(99, 102, 241, 1)', // Cor indigo-500
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        window.App.renderAnalyticsPage = renderAnalyticsPage;

        // --- NOVA FUN√á√ÉO PARA LIXEIRA ---
        function renderLixeiraPage() {
            const container = document.getElementById('lixeiraListContainer');
            container.innerHTML = '';

            const deletedContracts = database.contracts.filter(c => c.isDeleted === true);

            if (deletedContracts.length === 0) {
                 container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block dark-card text-gray-400 p-6 rounded-lg shadow-md"><i class="fas fa-trash fa-3x mb-3"></i><p class="font-bold text-xl">Lixeira Vazia</p><p class="text-sm">Nenhum contrato foi exclu√≠do.</p></div></div>`;
                 return;
            }

            deletedContracts.forEach(contract => {
                container.innerHTML += `
                    <div class="dark-card p-5 rounded-lg shadow-lg border-l-4 border-gray-600">
                        <p class="font-bold text-lg text-white">${contract.clientName}</p>
                        <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
                        <div class="border-t border-gray-700 pt-3 mt-3 flex gap-2">
                            <button onclick="window.App.restoreContract('${contract.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button onclick="window.App.deleteContractPermanently('${contract.id}')" class="w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-times-circle"></i> Excluir Prmt.
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function renderAdvogadoFilters() {
            const advogadoFilters = [document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')];
            const advogados = [...new Set(database.contracts.map(c => c.advogadoResponsavel))];
            advogados.sort();

            advogadoFilters.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option>Todos</option>';
                // Adiciona a op√ß√£o "N√£o Informado"
                select.add(new Option("N√£o Informado", "N√£o Informado"));
                advogados.forEach(adv => {
                    if (adv && adv !== "N√£o Informado") { // Garante que n√£o duplique
                        const option = document.createElement('option');
                        option.value = adv;
                        option.textContent = adv;
                        select.appendChild(option);
                    }
                });
                select.value = currentValue || 'Todos';
            });
        }

        function renderSortButtons() {
            const contractSortContainer = document.getElementById('contractSortButtons');
            const inadimplentesSortContainer = document.getElementById('inadimplentesSortButtons');
            const servicosSortContainer = document.getElementById('servicosSortButtons');

            if(!contractSortContainer || !inadimplentesSortContainer || !servicosSortContainer) return;

            contractSortContainer.innerHTML = '';
            inadimplentesSortContainer.innerHTML = '';
            servicosSortContainer.innerHTML = '';

            const contractSorts = [{ key: 'name-asc', label: 'Nome (A-Z)' }, { key: 'value-desc', label: 'Valor (Maior)' }];
            contractSorts.forEach(sort => {
                const button = document.createElement('button');
                button.textContent = sort.label;
                button.className = `sort-button ${currentContractSort === sort.key ? 'active' : ''}`;
                button.onclick = () => { currentContractSort = sort.key; renderContractList(); renderSortButtons(); };
                contractSortContainer.appendChild(button);
            });

            const inadimplentesSorts = [{ key: 'days-desc', label: 'Mais Antigas' }, { key: 'value-desc', label: 'Maior Valor' }, { key: 'name-asc', label: 'Nome (A-Z)' }];
            inadimplentesSorts.forEach(sort => {
                const button = document.createElement('button');
                button.textContent = sort.label;
                button.className = `sort-button ${currentInadimplentesSort === sort.key ? 'active' : ''}`;
                button.onclick = () => { currentInadimplentesSort = sort.key; renderInadimplentesPage(); renderSortButtons(); };
                inadimplentesSortContainer.appendChild(button);
            });

            const servicosSorts = [{ key: 'name-asc', label: 'Cliente (A-Z)' }, { key: 'adv-asc', label: 'Advogado (A-Z)' }];
            servicosSorts.forEach(sort => {
                const button = document.createElement('button');
                button.textContent = sort.label;
                button.className = `sort-button ${currentServicosSort === sort.key ? 'active' : ''}`;
                button.onclick = () => { currentServicosSort = sort.key; renderServicosPage(); renderSortButtons(); };
                servicosSortContainer.appendChild(button);
            });
        }


        const updateServiceStatus = async function(contractId, serviceIndex, newStatus) {
            const contract = database.contracts.find(c => c.id === contractId);
            if (contract && (contract.serviceTypes || [])[serviceIndex]) {
                const updatedServiceTypes = [...contract.serviceTypes];
                updatedServiceTypes[serviceIndex].status = newStatus;
                // Atualiza no DB
                const contractRef = doc(contractsCollection, contractId);
                await updateDoc(contractRef, { serviceTypes: updatedServiceTypes });
            }
        }
        window.App.updateServiceStatus = updateServiceStatus; // Expor ao HTML

        // --- NOVAS FUN√á√ïES DA LIXEIRA ---
        const moveToLixeira = async function(contractId) {
            const contract = database.contracts.find(c => c.id === contractId);
            if(confirm(`Tem certeza que deseja mover o contrato de "${contract.clientName}" para a lixeira?`)){
                const contractRef = doc(contractsCollection, contractId);
                await updateDoc(contractRef, { isDeleted: true });
            }
        }
        window.App.moveToLixeira = moveToLixeira;

        const restoreContract = async function(contractId) {
            if(confirm(`Tem certeza que deseja restaurar este contrato?`)){
                const contractRef = doc(contractsCollection, contractId);
                await updateDoc(contractRef, { isDeleted: false });
            }
        }
        window.App.restoreContract = restoreContract;

        const deleteContractPermanently = async function(contractId) {
            const contract = database.contracts.find(c => c.id === contractId);
            if(confirm(`EXCLUS√ÉO PERMANENTE: Tem certeza que deseja apagar o contrato de "${contract.clientName}" para sempre? Esta a√ß√£o n√£o pode ser desfeita.`)){
                await deleteDoc(doc(contractsCollection, contractId));
            }
        }
        window.App.deleteContractPermanently = deleteContractPermanently;
        // --- FIM DAS FUN√á√ïES DA LIXEIRA ---


        const backdrop = document.getElementById('modal-backdrop');
        const openModal = function(modalId) {
            if(document.getElementById(modalId)) document.getElementById(modalId).style.display = 'block';
            if(backdrop) backdrop.style.display = 'block';
        }
        window.App.openModal = openModal; // Expor ao HTML

        const closeModal = function(modalId) {
            if(document.getElementById(modalId)) document.getElementById(modalId).style.display = 'none';
            if(backdrop) backdrop.style.display = 'none';
        }
        window.App.closeModal = closeModal; // Expor ao HTML

        const openContractModal = function(contractId = null) {
            const form = document.getElementById('formContrato');
            form.reset();
            const title = document.getElementById('modalContratoTitle');
            const servicosContainer = document.getElementById('servicosContainer');
            servicosContainer.innerHTML = '';

            if (contractId) {
                const contract = database.contracts.find(c => c.id === contractId);
                title.textContent = "Editar Contrato";
                document.getElementById('contractId').value = contract.id;
                document.getElementById('clienteNome').value = contract.clientName;
                document.getElementById('advogadoResponsavel').value = contract.advogadoResponsavel;
                (contract.serviceTypes || []).forEach(service => createServiceTag(service.name, service.deadline));
                document.getElementById('contratoTipoPagamento').value = contract.paymentType;
                document.getElementById('valorTotal').value = contract.totalValue;
                document.getElementById('numParcelas').value = (contract.parcels || []).length || 1;
                document.getElementById('taxaExito').value = contract.successFee;
                document.getElementById('contratoObservacoes').value = contract.observations;
                if ((contract.parcels || []).length > 0) {
                    document.getElementById('vencimentoPrimeiraParcela').value = contract.parcels[0].dueDate.split('T')[0];
                }
            } else {
                title.textContent = "Cadastrar Novo Contrato";
                document.getElementById('contractId').value = '';
            }
            openModal('modalContrato');
        }
        window.App.openContractModal = openContractModal; // Expor ao HTML

        const openPaymentModal = async function(contractId, parcelIndex) {
            const contract = database.contracts.find(c => c.id === contractId);
            const parcel = contract.parcels[parcelIndex];

            let valorCorrigido = parcel.value;
            if (new Date(parcel.dueDate) < new Date()) {
                 valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate);
            }

            document.getElementById('pagamentoContractId').value = contractId;
            document.getElementById('pagamentoParcelIndex').value = parcelIndex;

            const infoDiv = document.getElementById('pagamentoInfo');
            infoDiv.innerHTML = `
                <p><strong>Cliente:</strong> ${contract.clientName}</p>
                <p><strong>Valor Original:</strong> ${parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                <p class="text-red-400"><strong>Valor Corrigido:</strong> ${valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>`;

            document.getElementById('pagamentoValor').value = valorCorrigido.toFixed(2);
            document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];

            openModal('modalPagamento');
        }
        window.App.openPaymentModal = openPaymentModal; // Expor ao HTML

        const openClientHistoryModal = function(clientName) {
            const clientContracts = database.contracts.filter(c => c.clientName === clientName);
            const title = document.getElementById('clienteModalTitle');
            const content = document.getElementById('clienteModalContent');

            title.textContent = `Hist√≥rico de ${clientName}`;

            let totalContratado = 0;
            let totalPago = 0;
            let html = '';

            clientContracts.forEach(contract => {
                totalContratado += contract.totalValue || 0;
                let contractHtml = `<div class="bg-gray-700 p-4 rounded-lg">`;
                contractHtml += `<h3 class="font-bold text-lg text-white">${(contract.serviceTypes || []).map(s => s.name).join(', ')} <span class="text-base font-normal text-gray-400">- ${contract.paymentType}</span></h3>`;

                if (contract.observations) {
                    contractHtml += `<blockquote class="text-sm mt-2 p-2 bg-gray-600/50 rounded-md text-gray-300 border-l-4 border-indigo-500 pl-4"><strong>Obs:</strong> ${contract.observations}</blockquote>`;
                }

                if((contract.parcels || []).length > 0) {
                    contractHtml += `<ul class="mt-2 text-sm space-y-1">`;
                    contract.parcels.forEach(p => {
                        const statusClass = p.status === 'Paga' ? 'text-green-400' : 'text-red-400';
                        const valorPago = p.status === 'Paga' ? `(pago ${p.valuePaid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})` : '';
                        totalPago += p.valuePaid || 0;
                        contractHtml += `<li>Parcela ${p.number} - ${p.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} - <span class="${statusClass}">${p.status}</span> ${valorPago}</li>`;
                    });
                    contractHtml += `</ul>`;
                }
                 if(contract.successFeePaymentDate){
                    totalPago += contract.successFeeValueReceived;
                    contractHtml += `<p class="mt-2 text-sm text-green-400">√äxito Recebido: ${contract.successFeeValueReceived.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>`;
                 }
                contractHtml += `</div>`;
                html += contractHtml;
            });

            const summaryHtml = `
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div><p class="text-sm text-gray-400">Total Contratado</p><p class="font-bold text-lg text-white">${totalContratado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                    <div><p class="text-sm text-gray-400">Total Pago</p><p class="font-bold text-lg text-green-400">${totalPago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                    <div><p class="text-sm text-gray-400">Saldo Devedor</p><p class="font-bold text-lg text-red-400">${(totalContratado - totalPago).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                </div>
            `;

            content.innerHTML = summaryHtml + '<hr class="my-4 border-gray-700">' + html;
            openModal('modalCliente');
        }
        window.App.openClientHistoryModal = openClientHistoryModal; // Expor ao HTML

        const openReportModal = function() {
            populateDateSelectors();
            generateAndShowReport(); 
            openModal('modalRelatorio');
        }
        window.App.openReportModal = openReportModal; // Expor ao HTML

        function populateDateSelectors() {
            const monthSelect = document.getElementById('reportMonth');
            const yearSelect = document.getElementById('reportYear');
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const anoAtual = new Date().getFullYear();
            if (monthSelect.options.length > 0) return; 
            meses.forEach((mes, index) => { monthSelect.add(new Option(mes, index)); });
            for (let i = anoAtual; i >= anoAtual - 5; i--) { yearSelect.add(new Option(i, i)); }
            monthSelect.value = new Date().getMonth();
            yearSelect.value = anoAtual;
        }

        function calculateMonthlyIncome(year, month) {
            let totalParcelas = 0;
            let totalExito = 0;
            let detailedPayments = [];

            database.contracts.filter(c => !c.isDeleted).forEach(contract => { // Filtra lixeira
                (contract.parcels || []).forEach(parcel => {
                    if(parcel.status === 'Paga') {
                        const d = new Date(parcel.paymentDate);
                        if (d.getFullYear() === year && d.getMonth() === month) {
                            totalParcelas += parcel.valuePaid;
                            detailedPayments.push({
                                type: `Parcela ${parcel.number}/${contract.parcels.length}`,
                                clientName: contract.clientName,
                                date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}),
                                value: parcel.valuePaid
                            });
                        }
                    }
                });
                if (contract.successFeePaymentDate) {
                    const d = new Date(contract.successFeePaymentDate);
                     if (d.getFullYear() === year && d.getMonth() === month) {
                        totalExito += contract.successFeeValueReceived;
                        detailedPayments.push({
                            type: 'Taxa de √äxito',
                            clientName: contract.clientName,
                            date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}),
                            value: contract.successFeeValueReceived
                        });
                     }
                }
            });
            detailedPayments.sort((a,b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')));
            return { totalParcelas, totalExito, totalGeral: totalParcelas + totalExito, detailedPayments };
        }

        const generateAndShowReport = function() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const resultDiv = document.getElementById('reportResult');
            const income = calculateMonthlyIncome(year, month);

            let detailsHtml = '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-white">Detalhes dos Recebimentos</h4>';
            if (income.detailedPayments.length > 0) {
                detailsHtml += '<ul class="space-y-2 mt-2 text-sm">';
                income.detailedPayments.forEach(p => {
                    detailsHtml += `
                        <li class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md">
                            <div>
                                <p class="font-semibold text-white">${p.clientName}</p>
                                <p class="text-xs text-gray-400">${p.type} - ${p.date}</p>
                            </div>
                            <span class="font-semibold text-green-400">${p.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        </li>
                    `;
                });
                detailsHtml += '</ul>';
            } else {
                detailsHtml += '<p class="text-sm text-gray-400 mt-2">Nenhum recebimento neste per√≠odo.</p>';
            }

            resultDiv.innerHTML = `<div class="dark-card p-4 rounded-lg"><p class="text-gray-400">Total Recebido (Parcelas):</p><p class="text-2xl font-bold text-white">${income.totalParcelas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div><div class="dark-card p-4 rounded-lg"><p class="text-gray-400">Total Recebido (√äxito):</p><p class="text-2xl font-bold text-indigo-400">${income.totalExito.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div><div class="bg-gray-900 p-4 rounded-lg border border-gray-700"><p class="text-white font-bold">TOTAL GERAL RECEBIDO:</p><p class="text-3xl font-extrabold text-green-400">${income.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>` + detailsHtml;
        }
        window.App.generateAndShowReport = generateAndShowReport; // Expor ao HTML

        const openExitoModal = function(contractId) {
            const contract = database.contracts.find(c => c.id === contractId);
            if (!contract) return;
            document.getElementById('exitoContractId').value = contractId;
            document.getElementById('exitoInfo').innerHTML = `<p><strong>Cliente:</strong> ${contract.clientName}</p><p><strong>Servi√ßo:</strong> ${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p><p><strong>Bonifica√ß√£o Prevista:</strong> <span class="font-bold text-indigo-400">${contract.successFee}</span></p>`;
            openModal('modalExito');
        }
        window.App.openExitoModal = openExitoModal; // Expor ao HTML

        const createServiceTag = function(serviceName, deadline) {
            const container = document.getElementById('servicosContainer');
            const tag = document.createElement('div');
            tag.className = 'service-tag';
            tag.dataset.name = serviceName;
            tag.dataset.deadline = deadline || '';

            let deadlineHtml = '';
            if (deadline) {
                const prazo = new Date(deadline + "T12:00:00Z");
                deadlineHtml = `<span class="text-xs text-gray-400 ml-2">(${prazo.toLocaleDateString('pt-BR', {timeZone: 'UTC'})})</span>`;
            }

            tag.innerHTML = `
                <span>${serviceName}${deadlineHtml}</span>
                <span class="remove-tag" onclick="this.parentElement.remove()">&times;</span>`;
            container.appendChild(tag);
        }
        window.App.createServiceTag = createServiceTag; // Expor ao HTML

        // --- FUN√á√ïES DE C√ÅLCULO DE JUROS (COM API REAL) ---

        async function fetchIPCA(startDate, endDate) {
            // Formata as datas para dd/MM/YYYY
            const formatApiDate = (date) => {
                const d = new Date(date);
                const day = String(d.getUTCDate()).padStart(2, '0');
                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                const year = d.getUTCFullYear();
                return `${day}/${month}/${year}`;
            };

            const startFormatted = formatApiDate(startDate);
            const endFormatted = formatApiDate(endDate);

            // Chave de cache para evitar m√∫ltiplas chamadas
            const cacheKey = `${startFormatted}-${endFormatted}`;
            if (ipcaCache.has(cacheKey)) {
                return ipcaCache.get(cacheKey);
            }

            // API do Banco Central para o √≠ndice IPCA (c√≥digo 16121)
            const proxyUrl = 'https://api.allorigins.win/get?url='; // Proxy CORS
            const apiBase = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.16121/dados'; // C√≥d 16121 = √çndice de pre√ßos

            try {
                // Busca o valor do √≠ndice no m√™s de vencimento
                const urlStart = `${proxyUrl}${encodeURIComponent(`${apiBase}?formato=json&dataInicial=${startFormatted}&dataFinal=${startFormatted}`)}`;
                const responseStart = await fetch(urlStart);
                if (!responseStart.ok) throw new Error('Falha ao buscar √≠ndice inicial do IPCA');
                let dataStart = await responseStart.json();
                dataStart = JSON.parse(dataStart.contents); // O proxy allorigins aninha a resposta
                const indexStart = parseFloat(dataStart[0]?.valor);

                // Busca o valor do √≠ndice mais recente
                const urlEnd = `${proxyUrl}${encodeURIComponent(`${apiBase}/ultimos/1?formato=json`)}`;
                const responseEnd = await fetch(urlEnd);
                if (!responseEnd.ok) throw new Error('Falha ao buscar √≠ndice final do IPCA');
                let dataEnd = await responseEnd.json();
                dataEnd = JSON.parse(dataEnd.contents);
                const indexEnd = parseFloat(dataEnd[0]?.valor);

                if (!indexStart || !indexEnd) {
                    console.warn("N√£o foi poss√≠vel obter os √≠ndices IPCA, usando fator 1.");
                    return 1; // Retorna 1 se falhar
                }

                // Calcula o fator de corre√ß√£o
                const multiplicador = indexEnd / indexStart;
                ipcaCache.set(cacheKey, multiplicador); // Salva no cache
                return multiplicador;

            } catch (error) {
                console.error("Erro ao buscar dados do IPCA:", error);
                return 1; // Retorna 1 (sem corre√ß√£o) em caso de erro
            }
        }

        async function calcularValorCorrigido(valorOriginal, dataVencimento) {
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);

            if (hoje <= vencimento) {
                return valorOriginal; // N√£o aplica juros se n√£o venceu
            }

            // 1. C√°lculo de Corre√ß√£o Monet√°ria (IPCA Real)
            const multiplicadorIPCA = await fetchIPCA(vencimento, hoje);
            let valorCorrigido = valorOriginal * multiplicadorIPCA;

            // 2. C√°lculo de Juros de Mora (1% ao m√™s)
            const diffInMs = hoje - vencimento;
            const diffInDays = diffInMs / (1000 * 60 * 60 * 24);
            const mesesAtraso = diffInDays / 30.44; // M√©dia de dias no m√™s

            // Juros SIMPLES de 1% ao m√™s (0.01)
            const fatorJuros = (1 + (0.01 * mesesAtraso));
            let valorFinal = valorCorrigido * fatorJuros;

            return valorFinal;
        }

        // --- FUN√á√ïES DE EXPORTA√á√ÉO CSV ---

        function formatCSVCell(data) {
            if (data == null) return '';
            let str = String(data);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        const exportContractsCSV = function() {
            const headers = ["ID", "Cliente", "Advogado", "Tipo Pagamento", "Valor Total", "Taxa √äxito", "Status", "Servi√ßos", "Observa√ß√µes"];
            let csvRows = [headers.join(',')];

            database.contracts.filter(c => !c.isDeleted).forEach(c => { // Filtra lixeira
                const status = getContractStatus(c).statusText;
                const services = (c.serviceTypes || []).map(s => s.name).join('; '); // Usar ; para n√£o conflitar
                const row = [
                    c.id,
                    c.clientName,
                    c.advogadoResponsavel,
                    c.paymentType,
                    c.totalValue,
                    c.successFee,
                    status,
                    services,
                    c.observations
                ].map(formatCSVCell).join(',');
                csvRows.push(row);
            });

            downloadCSV(csvRows.join('\n'), 'contratos_export.csv');
        }
        window.App.exportContractsCSV = exportContractsCSV; // Expor ao HTML

        const exportReportCSV = function() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const income = calculateMonthlyIncome(year, month);

            if (income.detailedPayments.length === 0) {
                alert("N√£o h√° dados para exportar neste relat√≥rio.");
                return;
            }

            const headers = ["Cliente", "Tipo", "Data", "Valor"];
            let csvRows = [headers.join(',')];

            income.detailedPayments.forEach(p => {
                const row = [
                    p.clientName,
                    p.type,
                    p.date,
                    p.value
                ].map(formatCSVCell).join(',');
                csvRows.push(row);
            });

            const monthName = document.getElementById('reportMonth').options[month].text;
            downloadCSV(csvRows.join('\n'), `relatorio_${monthName}_${year}.csv`);
        }
        window.App.exportReportCSV = exportReportCSV; // Expor ao HTML


        // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAndAuth(); // Chama a inicializa√ß√£o do Firebase

            // --- Handlers de Autentica√ß√£o ---
            const loginForm = document.getElementById('login-form');
            const authError = document.getElementById('auth-error');
            const logoutButton = document.getElementById('logout-button');

            const showAuthError = (message) => {
                authError.textContent = message;
                authError.classList.remove('hidden');
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // O listener onAuthStateChanged cuidar√° de mostrar o app
                } catch (error) {
                    console.error("Erro no login:", error.code);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        showAuthError('Email ou senha inv√°lidos.');
                    } else {
                        showAuthError('Erro ao tentar fazer login.');
                    }
                }
            });

            logoutButton.addEventListener('click', async () => {
                await signOut(auth);
                // O listener onAuthStateChanged cuidar√° de mostrar a tela de login
            });

            // NOVO: Handler para o formul√°rio de Display Name
            const displayNameForm = document.getElementById('formDisplayName');
            displayNameForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('inputDisplayName').value;
                if (name && auth.currentUser) {
                    try {
                        await updateProfile(auth.currentUser, { displayName: name });
                        // Sucesso! Agora recarregamos o estado do usu√°rio (o onAuthStateChanged vai disparar de novo)
                        // ou podemos simplesmente for√ßar a exibi√ß√£o do app
                        document.getElementById('user-display-name').textContent = name;
                        closeModal('modalDisplayName');
                        document.getElementById('app-container').style.display = 'block';

                        // Iniciar o listener do DB agora que temos o nome
                        contractsCollection = collection(db, `contracts`);
                        setupSnapshotListener();

                    } catch (error) {
                        console.error("Erro ao salvar nome:", error);
                        alert("N√£o foi poss√≠vel salvar seu nome. Tente novamente.");
                    }
                }
            });

            // --- Handlers do Aplicativo ---
            document.getElementById('formContrato').addEventListener('submit', async (e) => {
                e.preventDefault();
                const contractId = document.getElementById('contractId').value;
                const clientName = document.getElementById('clienteNome').value;
                const advogadoResponsavel = document.getElementById('advogadoResponsavel').value;
                const serviceTags = document.querySelectorAll('#servicosContainer .service-tag');
                const serviceTypes = Array.from(serviceTags).map(tag => ({ 
                    name: tag.dataset.name, 
                    status: 'Pendente', 
                    deadline: tag.dataset.deadline || null 
                }));
                const paymentType = document.getElementById('contratoTipoPagamento').value;
                const totalValue = parseFloat(document.getElementById('valorTotal').value) || 0;
                const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
                const firstDueDate = document.getElementById('vencimentoPrimeiraParcela').value;
                const successFee = document.getElementById('taxaExito').value;
                const observations = document.getElementById('contratoObservacoes').value;

                if (serviceTypes.length === 0) {
                    alert('Adicione pelo menos um tipo de servi√ßo.');
                    return;
                }

                const contractData = { 
                    clientName, 
                    advogadoResponsavel, 
                    serviceTypes, 
                    paymentType, 
                    totalValue, 
                    successFee, 
                    observations, 
                    parcels: [], 
                    successFeeValueReceived: 0, 
                    successFeePaymentDate: null,
                    isDeleted: false // Garante que novos contratos n√£o estejam na lixeira
                };

                if (numParcels > 0 && totalValue > 0) {
                    if (!firstDueDate) { alert('Informe a data de vencimento da primeira parcela.'); return; }
                    const parcelValue = totalValue / numParcels;
                    let currentDueDate = new Date(firstDueDate + 'T12:00:00Z');
                    for (let i = 0; i < numParcels; i++) {
                        contractData.parcels.push({ number: i + 1, value: parcelValue, dueDate: new Date(currentDueDate).toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null });
                        currentDueDate.setMonth(currentDueDate.getMonth() + 1);
                    }
                }

                if (contractId) {
                    // Ao editar, n√£o mexemos no status 'isDeleted'
                    const { isDeleted, ...dataToUpdate } = contractData; // Remove 'isDeleted' para n√£o sobrescrever
                    await updateDoc(doc(contractsCollection, contractId), dataToUpdate);
                } else {
                    await addDoc(contractsCollection, contractData);
                }
                closeModal('modalContrato');
            });

            document.getElementById('formPagamento').addEventListener('submit', async (e) => {
                e.preventDefault();
                const contractId = document.getElementById('pagamentoContractId').value;
                const parcelIndex = parseInt(document.getElementById('pagamentoParcelIndex').value);
                const valuePaid = parseFloat(document.getElementById('pagamentoValor').value);
                const paymentDate = document.getElementById('pagamentoData').value;

                const contractRef = doc(contractsCollection, contractId);
                const contract = database.contracts.find(c => c.id === contractId);

                if (contract) {
                    const updatedParcels = [...contract.parcels];
                    updatedParcels[parcelIndex].status = 'Paga';
                    updatedParcels[parcelIndex].valuePaid = valuePaid;
                    updatedParcels[parcelIndex].paymentDate = new Date(paymentDate + 'T12:00:00Z').toISOString();
                    await updateDoc(contractRef, { parcels: updatedParcels });
                    closeModal('modalPagamento');
                }
            });

            document.getElementById('formExito').addEventListener('submit', async (e) => {
                e.preventDefault();
                const contractId = document.getElementById('exitoContractId').value;
                const valueReceived = parseFloat(document.getElementById('exitoValorRecebido').value);
                const contract = database.contracts.find(c => c.id === contractId);
                if (contract && !isNaN(valueReceived) && valueReceived > 0) {
                    await updateDoc(doc(contractsCollection, contractId), {
                        successFeeValueReceived: valueReceived,
                        successFeePaymentDate: new Date().toISOString()
                    });
                    closeModal('modalExito');
                } else {
                    alert('Valor inv√°lido.');
                }
            });

            const backdrop = document.getElementById('modal-backdrop');
            if (backdrop) {
                backdrop.addEventListener('click', () => {
                    // N√£o fechar o modal de display name ao clicar fora
                    if (document.getElementById('modalDisplayName').style.display !== 'block') {
                        closeModal('modalContrato');
                        closeModal('modalRelatorio');
                        closeModal('modalExito');
                        closeModal('modalPagamento');
                        closeModal('modalCliente');
                    }
                });
            }

            // Listener para o novo bot√£o "Adicionar Servi√ßo"
            const addServiceButton = document.getElementById('addServiceButton');
            if(addServiceButton) {
                addServiceButton.addEventListener('click', () => {
                    const serviceInput = document.getElementById('contratoServicoInput');
                    const deadlineInput = document.getElementById('contratoPrazoInput');
                    const serviceName = serviceInput.value.trim();
                    const deadline = deadlineInput.value;

                    if (serviceName) {
                        createServiceTag(serviceName, deadline);
                        serviceInput.value = '';
                        deadlineInput.value = '';
                    } else {
                        alert('Por favor, insira um nome para o servi√ßo.');
                    }
                });
            }
        });
    </script>
</body>
</html>
~
