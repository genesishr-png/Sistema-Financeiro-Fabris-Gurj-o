<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira - Advocacia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Biblioteca de Gráficos (mantida caso seja usada em outro lugar, como relatórios) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            position: relative;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        body::after {
            content: '';
            background-image: url('https://i.postimg.cc/XNs7dp8C/fabris-e-gurjas.png');
            background-repeat: repeat;
            background-attachment: fixed;
            background-size: 300px;
            opacity: 0.03;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            position: fixed;
            z-index: -1;
        }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        .kanban-column { min-width: 320px; }
        .kanban-content { max-height: 60vh; overflow-y: auto; padding-right: 8px;}
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
        .service-tag {
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            margin-right: 4px;
            margin-bottom: 4px;
            width: 100%; /* Ocupa a largura toda */
        }
        .service-tag-small {
            display: inline-block;
            background-color: #374151; /* gray-700 */
            color: #9ca3af; /* gray-400 */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .service-tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .nav-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            color: #9ca3af; /* gray-400 */
            transition: all 0.2s;
        }
        .nav-tab:hover {
            color: #e5e7eb; /* gray-200 */
        }
        .nav-tab.active {
            border-bottom-color: #6366f1; /* indigo-500 */
            color: #e5e7eb; /* gray-200 */
        }
        /* Classe específica para o ícone da lixeira */
        .nav-tab-icon {
            cursor: pointer;
            padding: 10px 15px; /* Padding ligeiramente ajustado */
            color: #9ca3af; /* gray-400 */
            transition: all 0.2s;
        }
        .nav-tab-icon:hover {
            color: #e5e7eb; /* gray-200 */
        }
        .nav-tab-icon.active {
             color: #6366f1; /* indigo-500 */
        }
        .progress-bar-bg {
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .dark-card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        /* ***** CSS DO HEADER RESTAURADO ***** */
        .header-with-logo {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* ADICIONADO: Nova classe para o bloco de usuário */
        .header-user-block {
            margin-right: 160px; /* Margem para criar espaço para a logo */
        }
        .header-logo {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            max-height: 60px;
            opacity: 0.8;
        }
        /* ***** FIM DO CSS RESTAURADO ***** */

        /* CORREÇÃO: Removido aninhamento inválido */
        .sort-button, .filter-button {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sort-button:hover, .filter-button:hover {
            background-color: #4b5563;
            color: white;
        }
        .sort-button.active, .filter-button.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }

        /* NOVO: Botão de filtro de período */
        .period-filter-button {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .period-filter-button:hover {
            background-color: #4b5563;
            color: white;
        }
        .period-filter-button.active {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        .filter-select {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #9ca3af;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .filter-select:disabled {
            background-color: #4b5563;
            opacity: 0.7;
            cursor: not-allowed;
        }
        #loading-overlay, #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-size: 1.2rem;
            transition: opacity 0.3s;
        }
        #auth-overlay {
            z-index: 99; /* Fica abaixo do loading, mas acima do app */
        }
        #app-container {
            display: none; /* Começa escondido */
        }
        /* Esconder elementos para não-admins */
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; } /* Mostra se o body tiver a classe */
        body.is-admin .flex.admin-only { display: flex; } /* Ajuste para flex containers */
        body:not(.is-admin) .non-admin-hidden { display: none; }

        /* REMOVIDO: Estilo canvas-container */
        /* .canvas-container { ... } */

    </style>
</head>
<body class="text-gray-300"> <!-- Classe is-admin será adicionada via JS -->

    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin mr-3"></i> Conectando...
    </div>

    <!-- Tela de Login -->
    <div id="auth-overlay">
        <div class="w-full max-w-sm p-8 space-y-6 bg-[#1a173a] rounded-lg shadow-xl border border-indigo-800">
            <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Logo" class="w-48 mx-auto">
            <h2 class="text-2xl font-bold text-center text-white">Login</h2>

            <div id="auth-error" class="hidden p-3 text-sm text-red-300 bg-red-800/50 border border-red-700 rounded-lg"></div>

            <!-- Formulário de Login -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-400">Email</label>
                    <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-400">Senha</label>
                    <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                </div>
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-8">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal do App (Começa escondido) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8">

        <!-- ***** HEADER RESTAURADO AO ORIGINAL ***** -->
        <header class="mb-6 header-with-logo">
            <!-- Bloco Esquerdo: Título e Descrição -->
            <div>
                <h1 class="text-3xl font-bold text-white">Painel de Gestão</h1>
                <p class="text-gray-400">Controle Financeiro e de Produção do Escritório</p>
            </div>

            <!-- Bloco Direito: Usuário e Logout (CLASSE ADICIONADA AQUI) -->
            <div class="flex items-center header-user-block">
                <span id="user-display-name" class="text-sm text-gray-300 font-medium mr-4"></span>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg shadow-md text-sm flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
            <!-- Logo (flutuante) -->
            <img src="https://www.fabrisegurjao.adv.br/netpage/data/uploads/2019/12/logo-fabris-e-gurjao-491x325px.png" alt="Fabris e Gurjão Logo" class="header-logo">
        </header>
        <!-- ***** FIM DO HEADER RESTAURADO ***** -->


        <div class="border-b border-gray-700 mb-8">
            <!-- Nav ajustada com justify-between e items-center -->
            <!-- Container flex para a barra de navegação -->
            <nav class="flex justify-between items-center -mb-px">
                <!-- Tabs Principais (esquerda) -->
                <div class="flex">
                    <a onclick="window.App.showPage('page-dashboard')" id="tab-dashboard" class="nav-tab active">
                        <i class="fas fa-tachometer-alt mr-2"></i>Painel Principal
                    </a>
                    <a onclick="window.App.showPage('page-inadimplentes')" id="tab-inadimplentes" class="nav-tab">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Inadimplentes
                    </a>
                    <a onclick="window.App.showPage('page-servicos')" id="tab-servicos" class="nav-tab">
                        <i class="fas fa-tasks mr-2"></i>Serviços
                    </a>
                    <!-- REMOVIDO: Tab Análise Gráfica -->
                    <!-- <a onclick="window.App.showPage('page-analytics')" id="tab-analytics" class="nav-tab admin-only"> ... </a> -->
                </div>

                <!-- Ícone da Lixeira (direita) -->
                <div>
                    <!-- A lixeira é visível para todos para restaurar seus próprios itens, mas admins podem excluir perm -->
                    <a onclick="window.App.showPage('page-lixeira')" id="tab-lixeira" class="nav-tab-icon" title="Lixeira">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </div>
            </nav>
        </div>


        <!-- Conteúdo da Página: Painel Principal -->
        <div id="page-dashboard">
            <div class="flex flex-wrap gap-4 mb-8">
                <button onclick="window.App.openContractModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i> Novo Contrato
                </button>
                <!-- Botões apenas para admin -->
                <button onclick="window.App.openReportModal()" class="admin-only bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> Relatório Mensal
                </button>
                <!-- REMOVIDO: Botão Análise Gráfica -->
                <!-- <button onclick="window.App.showPage('page-analytics')" class="admin-only ..."> ... </button> -->
            </div>

            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                 <!-- Cards serão preenchidos via JS -->
                 <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">A Receber (Próx. 30 dias)</h3><p id="dash-a-receber" class="text-3xl font-bold text-green-400"></p></div>
                 <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">Vencido (Corrigido)</h3><p id="dash-vencido" class="text-3xl font-bold text-red-400"></p></div>
                 <div class="dark-card p-6 rounded-lg shadow-lg admin-only"><h3 class="text-lg font-semibold text-gray-400">Recebido (Este Mês)</h3><p id="dash-recebido" class="text-3xl font-bold text-indigo-400"></p></div>
                 <div class="dark-card p-6 rounded-lg shadow-lg"><h3 class="text-lg font-semibold text-gray-400">Meus Contratos Ativos</h3><p id="dash-contratos" class="text-3xl font-bold text-white"></p></div>
            </div>

            <div class="mb-4 border-b border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-white">Situação das Parcelas (Meus Contratos)</h2>
            </div>

            <div id="kanban-board" class="flex overflow-x-auto space-x-4 pb-4">
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i>Vencidas</h3>
                    <div id="kanban-vencidas" class="kanban-content space-y-3"></div>
                </div>
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-yellow-400 flex items-center gap-2"><i class="far fa-clock"></i>A Vencer (Próx. 30 dias)</h3>
                    <div id="kanban-a-vencer" class="kanban-content space-y-3"></div>
                </div>
                <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-gray-400 flex items-center gap-2"><i class="fas fa-check-circle"></i>Pagas (Este Mês)</h3>
                    <div id="kanban-pagas" class="kanban-content space-y-3"></div>
                </div>
                 <div class="kanban-column bg-gray-900/70 rounded-lg p-4 flex-1">
                    <h3 class="font-bold text-lg mb-4 text-indigo-400 flex items-center gap-2"><i class="fas fa-gavel"></i>Aguardando Êxito</h3>
                    <div id="kanban-exito" class="kanban-content space-y-3"></div>
                </div>
            </div>

            <div class="mt-12">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-semibold text-white">Meus Contratos</h2>
                    <div class="flex items-center gap-4">
                        <button onclick="window.App.exportContractsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2 text-sm">
                            <i class="fas fa-file-csv"></i> Exportar (CSV)
                        </button>
                        <!-- Filtro de advogado (visível para admin) -->
                        <select id="advogadoFilter" onchange="window.App.resetAndRenderContractList()" class="filter-select admin-only"></select>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-400">Ordenar por:</span>
                            <div id="contractSortButtons" class="flex gap-1"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchInput" onkeyup="window.App.resetAndRenderContractList()" placeholder="🔎 Pesquisar por cliente ou tipo de serviço..." class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                </div>
                <div id="contractListContainer"></div>
                <div id="loadMoreContainer" class="text-center mt-8">
                    <button onclick="window.App.loadMoreContracts()" id="loadMoreButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all flex items-center gap-2 mx-auto">
                        <i class="fas fa-plus"></i> Carregar Mais
                    </button>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Página: Inadimplentes -->
        <div id="page-inadimplentes" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Controle de Inadimplentes (Meus Contratos)</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400">Ordenar por:</span>
                    <div id="inadimplentesSortButtons" class="flex gap-1"></div>
                </div>
            </div>
            <div id="inadimplentesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Conteúdo da Página: Controle de Serviços -->
        <div id="page-servicos" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Controle de Produção de Serviços (Meus Contratos)</h2>
                <div class="flex items-center gap-4">
                    <!-- Filtro de advogado (visível para admin) -->
                    <select id="servicosAdvogadoFilter" onchange="window.App.renderServicosPage()" class="filter-select admin-only"></select>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Ordenar por:</span>
                        <div id="servicosSortButtons" class="flex gap-1"></div>
                    </div>
                    <input type="text" id="servicosSearchInput" onkeyup="window.App.renderServicosPage()" placeholder="🔎 Pesquisar..." class="w-full md:w-auto p-2 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                </div>
            </div>
             <div id="servicosListContainer" class="space-y-6"></div>
        </div>

        <!-- REMOVIDO: Conteúdo da Página: Análise Gráfica -->
        <!-- <div id="page-analytics" class="hidden admin-only"> ... </div> -->

        <!-- Conteúdo da Página: Lixeira -->
        <div id="page-lixeira" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Lixeira de Contratos</h2>
            </div>
            <p class="text-gray-400 mb-6">Contratos excluídos são mantidos aqui. Você pode restaurá-los ou excluí-los permanentemente (apenas admins).</p>
            <div id="lixeiraListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- Modais -->
    <!-- Modal: Adicionar Nome -->
    <div id="modalDisplayName" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo(a)!</h2>
            <p class="text-gray-400 mb-4">Percebemos que é seu primeiro acesso. Como você gostaria de ser chamado(a)?</p>
            <form id="formDisplayName">
                <div class="mb-4">
                    <label for="inputDisplayName" class="block text-sm font-medium text-gray-400">Seu Nome de Exibição</label>
                    <input type="text" id="inputDisplayName" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar e Entrar</button>
            </form>
        </div>
    </div>

    <!-- Modal: Contrato -->
    <div id="modalContrato" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalContratoTitle" class="text-2xl font-bold text-white">Cadastrar Novo Contrato</h2>
                <button onclick="window.App.closeModal('modalContrato')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formContrato">
                <input type="hidden" id="contractId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clienteNome" class="block text-sm font-medium text-gray-400">Nome do Cliente</label>
                        <input type="text" id="clienteNome" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                    <div>
                        <label for="advogadoResponsavel" class="block text-sm font-medium text-gray-400">Advogado Responsável</label>
                        <select id="advogadoResponsavel" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                            <!-- Opções preenchidas via JS -->
                        </select>
                    </div>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400">Adicionar Serviços</label>
                    <div id="servicosContainerWrapper" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm">
                        <div id="servicosContainer" class="flex flex-wrap items-center gap-1 w-full mb-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="contratoServicoInput" class="flex-grow outline-none bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="Nome do Serviço...">
                            <input type="date" id="contratoPrazoInput" class="bg-gray-800 border border-gray-600 rounded-md shadow-sm text-gray-400 px-3 py-2" style="color-scheme: dark;">
                            <button type="button" id="addServiceButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Adicionar</button>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="contratoTipoPagamento" class="block text-sm font-medium text-gray-400">Modalidade de Pagamento</label>
                    <select id="contratoTipoPagamento" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                        <option>Parcelado</option>
                        <option>Pró-Abono</option>
                        <option>Entrada única</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="contratoObservacoes" class="block text-sm font-medium text-gray-400">Observações</label>
                    <textarea id="contratoObservacoes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="Detalhes da negociação, informações do caso, etc..."></textarea>
                </div>
                <!-- Campos financeiros (Admin Only) -->
                <div class="admin-only">
                    <h3 class="text-lg font-semibold mb-2 border-t border-gray-700 pt-4 text-white">Detalhes Financeiros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="valorTotal" class="block text-sm font-medium text-gray-400">Valor Fixo Total (R$)</label>
                            <input type="number" step="0.01" id="valorTotal" placeholder="0 se for só êxito" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
                        </div>
                        <div class="mb-4">
                            <label for="numParcelas" class="block text-sm font-medium text-gray-400">N° de Parcelas</label>
                            <input type="number" id="numParcelas" placeholder="1 para 'À Vista'" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" value="1">
                        </div>
                    </div>
                     <div class="mb-4">
                        <label for="vencimentoPrimeiraParcela" class="block text-sm font-medium text-gray-400">Vencimento da 1ª Parcela</label>
                        <input type="date" id="vencimentoPrimeiraParcela" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" style="color-scheme: dark;">
                    </div>
                    <div class="mb-4">
                        <label for="taxaExito" class="block text-sm font-medium text-gray-400">Taxa de Êxito (Bonificação)</label>
                        <input type="text" id="taxaExito" placeholder="Ex: 20%, 10000, 5 SALARIOS" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalContrato')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Pagamento -->
    <div id="modalPagamento" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
         <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Registrar Pagamento</h2>
                <button onclick="window.App.closeModal('modalPagamento')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formPagamento">
                <div id="pagamentoInfo" class="mb-4 bg-gray-700 p-3 rounded-md text-white"></div>
                <div class="mb-4">
                    <label for="pagamentoValor" class="block text-sm font-medium text-gray-400">Valor Pago (R$)</label>
                    <input type="number" step="0.01" id="pagamentoValor" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
                </div>
                <div class="mb-4">
                    <label for="pagamentoData" class="block text-sm font-medium text-gray-400">Data do Pagamento</label>
                    <input type="date" id="pagamentoData" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required style="color-scheme: dark;">
                </div>
                <input type="hidden" id="pagamentoContractId">
                <input type="hidden" id="pagamentoParcelIndex">
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalPagamento')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cliente -->
    <div id="modalCliente" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3">
         <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="clienteModalTitle" class="text-2xl font-bold text-white"></h2>
                <button onclick="window.App.closeModal('modalCliente')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="clienteModalContent" class="space-y-6"></div>
        </div>
    </div>

    <!-- Modal: Relatório (Admin Only) -->
    <div id="modalRelatorio" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5 admin-only">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Relatório Financeiro Mensal</h2>
                <button onclick="window.App.closeModal('modalRelatorio')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label for="reportMonth" class="block text-sm font-medium text-gray-400">Mês</label>
                    <select id="reportMonth" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
                <div class="flex-1">
                    <label for="reportYear" class="block text-sm font-medium text-gray-400">Ano</label>
                    <select id="reportYear" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
            </div>
             <div class="flex gap-4 mb-6">
                <button onclick="window.App.generateAndShowReport()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Gerar Relatório</button>
                <button onclick="window.App.exportReportCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Exportar (CSV)</button>
             </div>
            <div id="reportResult" class="space-y-4">
                <!-- O conteúdo será injetado aqui pela generateAndShowReport -->
            </div>
        </div>
    </div>

    <!-- Modal: Êxito -->
    <div id="modalExito" class="modal bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-11/12 md:w-1/3">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Registrar Recebimento de Êxito</h2>
                <button onclick="window.App.closeModal('modalExito')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="formExito">
                <div id="exitoInfo" class="mb-4 bg-gray-700 p-3 rounded-md"></div>
                 <!-- Campo de valor apenas para admin -->
                <div class="mb-4 admin-only">
                    <label for="exitoValorRecebido" class="block text-sm font-medium text-gray-400">Valor Líquido Recebido (R$)</label>
                    <input type="number" step="0.01" id="exitoValorRecebido" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-white" placeholder="Ex: 9500.00" required>
                </div>
                 <!-- Texto para não-admin -->
                 <p class="mb-4 text-gray-400 non-admin-hidden">Confirme o recebimento do valor de êxito.</p>
                <input type="hidden" id="exitoContractId">
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.App.closeModal('modalExito')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Recebimento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Global App Object ---
        window.App = {};

        // --- Global Variables ---
        let db, auth, contractsCollection;
        let database = { contracts: [] };
        let currentContractSort = 'name-asc';
        let currentInadimplentesSort = 'days-desc';
        let currentServicosSort = 'name-asc';
        let ipcaCache = new Map();
        // REMOVIDO: Variáveis dos gráficos
        // let faturamentoChartInstance = null;
        // let producaoChartInstance = null;
        let backdrop;
        let contractListPage = 0;
        const CONTRACTS_PER_PAGE = 30;
        const ADMIN_USERS = ["Dra. Renata Fabris", "Dr. Felipe Gurjão", "D'Arc"]; // Usernames dos admins
        let currentUserDisplayName = null;
        let isUserAdmin = false;
        // REMOVIDO: Variável de período dos gráficos
        // let currentAnalyticsPeriod = '12m';
        // REMOVIDO: Variável currentPageId
        // let currentPageId = 'page-dashboard';

        // --- Initialization and Authentication ---
        async function initializeAndAuth() {
            try {
                const firebaseConfig = { /* Sua config do Firebase aqui */
                    apiKey: "AIzaSyA0TWb7DgZAHNl3TuoK3xQD-ANvCcQIDK4",
                    authDomain: "fabrisgurjao.firebaseapp.com",
                    projectId: "fabrisgurjao",
                    storageBucket: "fabrisgurjao.firebasestorage.app",
                    messagingSenderId: "466702265991",
                    appId: "1:466702265991:web:78c4d98b47cab537921222",
                    measurementId: "G-E99R5TFMQK"
                  };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'fabrisgurjao-app';
                const finalConfig = (typeof __firebase_config !== 'undefined' && __firebase_config !== '' && __firebase_config !== '{{ SCRIPT_DATA.firebase_config }}')
                    ? JSON.parse(__firebase_config) : firebaseConfig;

                const app = initializeApp(finalConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const authOverlay = document.getElementById('auth-overlay');
                    const appContainer = document.getElementById('app-container');

                    if (user) {
                        currentUserDisplayName = user.displayName;
                        isUserAdmin = ADMIN_USERS.includes(currentUserDisplayName);
                        document.body.classList.toggle('is-admin', isUserAdmin); // Adiciona/remove classe no body

                        if (!user.displayName) {
                            console.log("Primeiro login detectado.");
                            loadingOverlay.style.display = 'none';
                            authOverlay.style.display = 'none';
                            appContainer.style.display = 'none';
                            openModal('modalDisplayName');
                        } else {
                            console.log("Usuário logado:", user.displayName, "É admin?", isUserAdmin);
                            document.getElementById('user-display-name').textContent = user.displayName;
                            authOverlay.style.display = 'none';
                            appContainer.style.display = 'block';
                            setupUIAccess(isUserAdmin);
                            contractsCollection = collection(db, `contracts`);
                            setupSnapshotListener(); // Listener já chama render() e showPage() inicial
                            loadingOverlay.style.display = 'none';
                            // REMOVIDO: Chamada showPage daqui, pois render() cuidará disso
                            // showPage('page-dashboard');
                        }
                    } else {
                        console.log("Nenhum usuário logado.");
                        currentUserDisplayName = null;
                        isUserAdmin = false;
                        document.body.classList.remove('is-admin');
                        authOverlay.style.display = 'flex';
                        appContainer.style.display = 'none';
                        loadingOverlay.style.display = 'none';
                        // REMOVIDO: Limpeza de gráficos no logout
                        // if (faturamentoChartInstance) faturamentoChartInstance.destroy();
                        // if (producaoChartInstance) producaoChartInstance.destroy();
                        // faturamentoChartInstance = null;
                        // producaoChartInstance = null;
                        // currentPageId = 'page-dashboard';
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização:", error);
                document.getElementById('loading-overlay').textContent = "Erro ao conectar.";
            }
        }

        function setupUIAccess(isAdmin) {
            // Ajusta visibilidade de botões e inputs financeiros
             const advogadoFilters = [
                document.getElementById('advogadoFilter'),
                document.getElementById('servicosAdvogadoFilter')
            ];
             advogadoFilters.forEach(select => {
                if (select) {
                    select.disabled = !isAdmin;
                    select.value = isAdmin ? 'Todos' : currentUserDisplayName;
                }
            });
             // Habilita/desabilita campos no modal de contrato
             const financialFields = ['valorTotal', 'numParcelas', 'vencimentoPrimeiraParcela', 'taxaExito'];
             financialFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.disabled = !isAdmin;
             });

            // Popula o select de advogado no modal de contrato
            populateAdvogadoSelectModal();
        }

        function setupSnapshotListener() {
            onSnapshot(contractsCollection, (snapshot) => {
                database.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                contractListPage = 0; // Reseta a paginação da lista de contratos
                render(); // Re-renderiza a view atual com os novos dados
            }, (error) => {
                console.error("Erro ao buscar dados:", error);
            });
        }

        // --- Navigation and Rendering ---
        const getFilteredContracts = (includeDeleted = false) => {
            const allContracts = database.contracts;
            if (isUserAdmin) {
                return allContracts.filter(c => includeDeleted ? true : !c.isDeleted);
            }
            return allContracts.filter(c => {
                const isOwner = c.advogadoResponsavel === currentUserDisplayName;
                const isNotDeleted = includeDeleted ? true : !c.isDeleted;
                return isOwner && isNotDeleted;
            });
        }

        const showPage = (pageId) => {
             console.log(`Tentando mostrar página: ${pageId}.`);

             // Lista de todas as páginas e tabs
             // REMOVIDO: 'page-analytics', 'tab-analytics'
             const allPages = ['page-dashboard', 'page-inadimplentes', 'page-servicos', 'page-lixeira'];
             const allTabs = ['tab-dashboard', 'tab-inadimplentes', 'tab-servicos', 'tab-lixeira'];

             // Esconde todas as páginas primeiro
             allPages.forEach(id => {
                 const el = document.getElementById(id);
                 if (el) el.classList.add('hidden');
             });

             // Desativa todas as tabs primeiro
             allTabs.forEach(id => {
                 const tab = document.getElementById(id);
                  if (tab) {
                      // Verifica se é o ícone da lixeira para usar a classe correta
                      if (id === 'tab-lixeira') {
                          tab.classList.remove('active'); // Remove a classe de ícone ativo
                      } else {
                          tab.classList.remove('active'); // Remove a classe de tab ativa
                      }
                  }
             });

              // Mostra a página clicada (respeitando admin-only)
             const targetPage = document.getElementById(pageId);
             if (targetPage) {
                 // REMOVIDO: Checagem admin-only para page-analytics
                 targetPage.classList.remove('hidden');
                 console.log(`Página ${pageId} exibida.`);
             } else {
                  console.error(`Página ${pageId} não encontrada! Voltando para dashboard.`);
                  showPage('page-dashboard'); // Redireciona se a página não existe
                  return;
             }

             // Ativa a tab correspondente
             // REMOVIDO: Condição ternária envolvendo page-analytics
              const tabId = pageId === 'page-lixeira' ? 'tab-lixeira' : `tab-${pageId.split('-')[1]}`;
             const targetTab = document.getElementById(tabId);
             if (targetTab) {
                  // Aplica a classe ativa correta (nav-tab ou nav-tab-icon)
                  targetTab.classList.add('active');
                  console.log(`Tab ${tabId} ativada.`);
             } else {
                  console.warn(`Tab ${tabId} não encontrada para a página ${pageId}.`);
             }

             // Renderiza o conteúdo específico da página que acabou de ser mostrada
             const filteredData = getFilteredContracts(false);
             const allFilteredData = getFilteredContracts(true); // Para lixeira

             if (pageId === 'page-dashboard') {
                 renderKanban(filteredData);
                 renderContractList(true); // Reseta a lista ao voltar pro dashboard
             } else if (pageId === 'page-inadimplentes') {
                 renderInadimplentesPage(filteredData);
             } else if (pageId === 'page-servicos') {
                 renderServicosPage(filteredData);
             // REMOVIDO: Else if para page-analytics
             } else if (pageId === 'page-lixeira') {
                 renderLixeiraPage(allFilteredData);
             }
         }
        window.App.showPage = showPage;

        async function render() {
            // Garante que o render só aconteça se o app estiver visível E o usuário logado
            if (document.getElementById('app-container').style.display !== 'block' || !auth.currentUser) return;

            const filteredData = getFilteredContracts(false);
            const allFilteredData = getFilteredContracts(true); // Para lixeira

            // Determina a página atual
            const currentPage = document.querySelector('div[id^="page-"]:not(.hidden)');
            const pageId = currentPage ? currentPage.id : 'page-dashboard'; // Default para dashboard se nenhuma estiver visível

            console.log(`Renderizando conteúdo para a página atual: ${pageId}`);
            if (pageId === 'page-dashboard') {
                await renderKanban(filteredData);
                renderContractList(); // Renderiza a lista sem resetar paginação
            } else if (pageId === 'page-inadimplentes') {
                await renderInadimplentesPage(filteredData);
            } else if (pageId === 'page-servicos') {
                renderServicosPage(filteredData);
            // REMOVIDO: Else if para page-analytics
            } else if (pageId === 'page-lixeira') {
                renderLixeiraPage(allFilteredData);
            }

            // Renderiza elementos comuns que podem mudar com os dados (filtros, botões de sort)
            renderSortButtons();
            renderAdvogadoFilters(); // Atualiza os filtros de advogado
        }

        async function renderKanban(contractsToRender) {
             const kanbanVencidas = document.getElementById('kanban-vencidas');
             const kanbanAVencer = document.getElementById('kanban-a-vencer');
             const kanbanPagas = document.getElementById('kanban-pagas');
             const kanbanExito = document.getElementById('kanban-exito');

             // Verifica se os elementos existem antes de tentar acessá-los
             if (!kanbanVencidas || !kanbanAVencer || !kanbanPagas || !kanbanExito) {
                 console.error("Um ou mais containers do Kanban não foram encontrados.");
                 return;
             }

             kanbanVencidas.innerHTML = '';
             kanbanAVencer.innerHTML = '';
             kanbanPagas.innerHTML = '';
             kanbanExito.innerHTML = '';

             const hoje = new Date(); hoje.setHours(0, 0, 0, 0);
             const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
             const trintaDiasFrente = new Date(); trintaDiasFrente.setDate(hoje.getDate() + 30);

             let totalAVencer30dias = 0;
             let totalVencido = 0;
             const vencidasPromises = [];

             for (const contract of contractsToRender) {
                 if (!contract.parcels) contract.parcels = [];
                 let remainingValue = isUserAdmin ? contract.parcels.reduce((sum, p) => p.status === 'Pendente' ? sum + p.value : sum, 0) : 0; // Só calcula se for admin

                 for (let i = 0; i < contract.parcels.length; i++) {
                     const parcel = contract.parcels[i];
                     // Adiciona checagem para dueDate inválido
                     if (!parcel.dueDate) {
                         console.warn(`Contrato ${contract.id}, Parcela ${i+1}: dueDate inválido ou ausente.`);
                         continue; // Pula esta parcela
                     }
                     const vencimento = new Date(parcel.dueDate);
                      // Verifica se a data é válida
                     if (isNaN(vencimento.getTime())) {
                         console.warn(`Contrato ${contract.id}, Parcela ${i+1}: Data de vencimento inválida: ${parcel.dueDate}`);
                         continue; // Pula esta parcela
                     }


                     if (parcel.status === 'Paga') {
                         // Adiciona checagem para paymentDate inválido
                         if (!parcel.paymentDate) {
                            // console.warn(`Contrato ${contract.id}, Parcela ${i+1}: Status 'Paga' sem paymentDate.`);
                             continue; // Considera como não paga neste contexto ou pula
                         }
                         const dataPagamento = new Date(parcel.paymentDate);
                         if (isNaN(dataPagamento.getTime())) {
                            // console.warn(`Contrato ${contract.id}, Parcela ${i+1}: Data de pagamento inválida: ${parcel.paymentDate}`);
                             continue; // Pula esta parcela
                         }

                         if(dataPagamento >= primeiroDiaMes && dataPagamento <= hoje) {
                             kanbanPagas.innerHTML += createParcelCard(contract, parcel, i, 'paga', remainingValue);
                         }
                     } else { // Status Pendente (ou outro não pago)
                         if (vencimento < hoje) {
                             vencidasPromises.push(
                                 calcularValorCorrigido(parcel.value, parcel.dueDate).then(valorCorrigido => {
                                     if(isUserAdmin) totalVencido += valorCorrigido; // Só soma se for admin
                                     return createParcelCard(contract, parcel, i, 'vencida', remainingValue, valorCorrigido);
                                 }).catch(error => {
                                     console.error(`Erro ao calcular valor corrigido para contrato ${contract.id}, parcela ${i+1}:`, error);
                                     return ''; // Retorna string vazia em caso de erro
                                 })
                             );
                         } else if (vencimento >= hoje && vencimento <= trintaDiasFrente) {
                             kanbanAVencer.innerHTML += createParcelCard(contract, parcel, i, 'a-vencer', remainingValue);
                             if(isUserAdmin) totalAVencer30dias += parcel.value; // Só soma se for admin
                         }
                     }
                 }
                 // Mostra card de êxito
                 if (contract.successFee && !contract.successFeePaymentDate && (contract.parcels || []).every(p => p.status === 'Paga')) {
                     kanbanExito.innerHTML += createExitoCard(contract);
                 }
             }

             // Espera todas as promises e junta o HTML
             try {
                const vencidasHtmlArray = await Promise.all(vencidasPromises);
                kanbanVencidas.innerHTML = vencidasHtmlArray.join('');
             } catch(error) {
                 console.error("Erro ao processar parcelas vencidas:", error);
                 kanbanVencidas.innerHTML = '<p class="text-red-500">Erro ao carregar parcelas vencidas.</p>';
             }


             // Renderiza o dashboard APENAS se os elementos existirem
             if (document.getElementById('dash-a-receber')) {
                const totalPagoMes = isUserAdmin ? calculateMonthlyIncome(hoje.getFullYear(), hoje.getMonth(), contractsToRender).totalGeral : 0; // Só calcula se for admin
                renderDashboard(totalAVencer30dias, totalVencido, totalPagoMes, contractsToRender.length);
             }
        }

       // ... (Restante das funções createParcelCard, createExitoCard, renderDashboard, etc., permanecem as mesmas) ...
        function createParcelCard(contract, parcel, index, type, remainingValue, valorCorrigido = null) {
            const vencimento = new Date(parcel.dueDate);
            const formattedDate = vencimento.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            const formattedValue = isUserAdmin ? parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
            const formattedRemaining = isUserAdmin ? remainingValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
            const formattedCorrigido = isUserAdmin && valorCorrigido ? valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';

            let actionButton = '';
            let statusClass = '';
            let valorHtml = '';

             if (type === 'vencida') {
                 statusClass = 'border-red-400';
                 valorHtml = isUserAdmin ? `
                     <div class="flex items-center text-gray-400 text-xs"><strong>Original:</strong><span class="ml-auto font-medium line-through">${formattedValue}</span></div>
                     <div class="flex items-center text-red-400"><strong>Corrigido:</strong><span class="ml-auto font-semibold text-lg">${formattedCorrigido}</span></div>`
                     : `<div class="text-red-400 font-semibold">Vencida</div>`;
             } else if (type === 'a-vencer') {
                  statusClass = 'border-yellow-400';
                  valorHtml = isUserAdmin ? `
                     <div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`
                     : `<div class="text-yellow-400 font-semibold">A vencer</div>`;
             } else { // Paga
                  statusClass = 'border-gray-600';
                  const formattedPaidValue = isUserAdmin ? (parcel.valuePaid || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
                  const paymentDate = new Date(parcel.paymentDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                  valorHtml = isUserAdmin ? `
                     <div class="flex items-center text-gray-300"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2 text-gray-500"></i><strong>Valor:</strong><span class="ml-auto font-semibold text-lg text-white">${formattedValue}</span></div>`
                     : ''; // Não mostra valor se não for admin e já estiver pago
                  actionButton = `<div class="mt-4 text-center text-sm bg-green-900/50 text-green-300 p-2 rounded-md font-medium">Pago ${isUserAdmin ? formattedPaidValue : ''} em ${paymentDate}</div>`;
             }

            // Botão de pagamento visível para todos, mas modal não terá valor se não for admin
            if (type !== 'paga') {
                actionButton = `<button onclick="window.App.openPaymentModal('${contract.id}', ${index})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-check"></i> Registrar Pagamento</button>`;
            }

            // Informação extra de valor apenas para admin
            let extraInfoHtml = isUserAdmin ? `<div class="text-xs text-gray-400 border-t border-gray-700 pt-2 mt-3 flex justify-between"><span>Contrato: <strong>${(contract.totalValue || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></span> <span>Restante: <strong>${formattedRemaining}</strong></span></div>` : '';

            return `
                <div class="dark-card p-4 rounded-lg shadow-md border-l-4 ${statusClass}">
                    <p class="font-bold text-white">${contract.clientName}</p>
                    <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')} - Parcela ${parcel.number}/${contract.parcels.length || 1}</p>
                    <div class="space-y-2 text-sm">
                        ${valorHtml}
                        <div class="flex items-center text-gray-300">
                            <i class="fas fa-calendar-alt w-5 text-center mr-2 text-gray-500"></i>
                            <strong>Vencimento:</strong>
                            <span class="ml-auto font-medium">${formattedDate}</span>
                        </div>
                    </div>
                    ${extraInfoHtml}
                    ${actionButton}
                </div>`;
        }

        function createExitoCard(contract) {
             const taxaExitoDisplay = isUserAdmin ? contract.successFee : '[Restrito]';
             return `
                <div class="dark-card p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                    <p class="font-bold text-white">${contract.clientName}</p>
                    <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
                    <div class="my-4 text-center">
                        <p class="text-sm text-gray-400">Bonificação Pendente</p>
                        <p class="text-2xl font-semibold text-indigo-400">${taxaExitoDisplay}</p>
                    </div>
                    <button onclick="window.App.openExitoModal('${contract.id}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2"><i class="fas fa-gavel"></i> Registrar Recebimento</button>
                </div>`;
        }

        function renderDashboard(aVencer, vencido, pago, totalContratos) {
            // Atualiza apenas os cards que devem ser mostrados
             document.getElementById('dash-a-receber').textContent = aVencer.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
             document.getElementById('dash-vencido').textContent = vencido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
             document.getElementById('dash-recebido').textContent = pago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
             document.getElementById('dash-contratos').textContent = totalContratos; // Total de contratos do usuário (ou todos para admin)
        }


        // --- Analytics Functions (Admin Only) - REMOVIDO ---
        // function getAnnualChartData(...) { ... }
        // function getAnnualProducaoData(...) { ... }
        // function renderAnalyticsPage(...) { ... }
        // window.App.renderAnalyticsPage = renderAnalyticsPage;
        // const setAnalyticsPeriod = function(...) { ... }
        // window.App.setAnalyticsPeriod = setAnalyticsPeriod;
        // window.App.setChartPeriod = setAnalyticsPeriod; // Alias

        // --- Restante do código (Lixeira, Modais, Cálculos, CSV, Inicialização) ---
        // ... (Colar aqui o restante do código JS que não foi modificado nesta etapa) ...
        // --- Lixeira Functions ---
        function renderLixeiraPage(contractsToRender) {
             const container = document.getElementById('lixeiraListContainer');
             container.innerHTML = '';
             const deletedContracts = contractsToRender.filter(c => c.isDeleted === true); // Usa os dados já filtrados por permissão

             if (deletedContracts.length === 0) {
                 container.innerHTML = `<div class="col-span-1 md:col-span-3 text-center py-10"><div class="inline-block dark-card text-gray-400 p-6 rounded-lg shadow-md"><i class="fas fa-trash fa-3x mb-3"></i><p class="font-bold text-xl">Lixeira Vazia</p><p class="text-sm">Nenhum contrato foi excluído.</p></div></div>`;
                 return;
             }

             deletedContracts.forEach(contract => {
                 // Botão de exclusão permanente apenas para admin
                 const deleteButton = isUserAdmin ? `
                     <button onclick="window.App.deleteContractPermanently('${contract.id}')" class="w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                         <i class="fas fa-times-circle"></i> Excluir Prmt.
                     </button>` : '';

                 container.innerHTML += `
                      <div class="dark-card p-5 rounded-lg shadow-lg border-l-4 border-gray-600">
                          <p class="font-bold text-lg text-white">${contract.clientName}</p>
                          <p class="text-sm text-gray-400 mb-3">${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>
                          <div class="border-t border-gray-700 pt-3 mt-3 flex gap-2">
                              <button onclick="window.App.restoreContract('${contract.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                                  <i class="fas fa-undo"></i> Restaurar
                              </button>
                              ${deleteButton}
                          </div>
                      </div>`;
             });
        }

        function renderAdvogadoFilters() {
             // Popula filtros principais (visíveis apenas para admin)
             const advogados = [...new Set(database.contracts.map(c => c.advogadoResponsavel))].sort();
             const filterSelects = [document.getElementById('advogadoFilter'), document.getElementById('servicosAdvogadoFilter')];

             filterSelects.forEach(select => {
                 if (!select) return;
                 const currentValue = select.value;
                 select.innerHTML = '<option value="Todos">Todos</option>'; // 'Todos' só funciona para admin
                 select.add(new Option("Não Informado", "Não Informado"));

                 const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe Gurjão", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle Guimarães", "Dr. Joaquim Océlio", "Dra. Larissa Mendes"];
                 const allNames = new Set([...fixedNames, ...advogados]);

                 [...allNames].filter(adv => adv && adv !== "Não Informado" && adv !== "Todos").sort().forEach(adv => {
                     select.add(new Option(adv, adv));
                 });

                 // Mantém o valor selecionado se possível, senão define o padrão
                 const optionsArray = Array.from(select.options).map(opt => opt.value);
                 if (optionsArray.includes(currentValue)) {
                    select.value = currentValue;
                 } else {
                    select.value = isUserAdmin ? 'Todos' : currentUserDisplayName;
                 }
                 select.disabled = !isUserAdmin;
             });
        }
        // Popula o select de advogado no modal de contrato
        function populateAdvogadoSelectModal() {
             const select = document.getElementById('advogadoResponsavel');
             if (!select) return;
             const currentValue = select.value; // Salva o valor atual se estiver editando

             select.innerHTML = ''; // Limpa antes de popular
             select.add(new Option("Não Informado", "Não Informado"));

             const advogados = [...new Set(database.contracts.map(c => c.advogadoResponsavel))].sort();
             const fixedNames = ["Dra. Renata Fabris", "Dr. Felipe Gurjão", "Dr. Glaison", "Dr. Bruno D'Lucas", "Dra. Danielle Guimarães", "Dr. Joaquim Océlio", "Dra. Larissa Mendes"];
             const allNames = new Set([...fixedNames, ...advogados]);

             [...allNames].filter(adv => adv && adv !== "Não Informado").sort().forEach(adv => {
                 select.add(new Option(adv, adv));
             });

             // Restaura o valor ou define o padrão
             select.value = currentValue && currentValue !== 'Não Informado' ? currentValue : (isUserAdmin ? 'Não Informado' : currentUserDisplayName);
             select.disabled = !isUserAdmin && !!currentUserDisplayName; // Desabilita se não for admin e já tiver um nome
        }

        function renderSortButtons() {
            // ... (Lógica de renderizar botões como estava) ...
             const contractSortContainer = document.getElementById('contractSortButtons');
             const inadimplentesSortContainer = document.getElementById('inadimplentesSortButtons');
             const servicosSortContainer = document.getElementById('servicosSortButtons');
             if(!contractSortContainer || !inadimplentesSortContainer || !servicosSortContainer) return;
             contractSortContainer.innerHTML = ''; inadimplentesSortContainer.innerHTML = ''; servicosSortContainer.innerHTML = '';

             // Contratos: Ordenar por valor só para admin
             const contractSorts = [{ key: 'name-asc', label: 'Nome (A-Z)' }];
             if(isUserAdmin) contractSorts.push({ key: 'value-desc', label: 'Valor (Maior)' });
             contractSorts.forEach(sort => { /* ... criar botão ... */
                const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentContractSort === sort.key ? 'active' : ''}`;
                button.onclick = () => { currentContractSort = sort.key; contractListPage = 0; renderContractList(true); renderSortButtons(); };
                contractSortContainer.appendChild(button);
             });

             // Inadimplentes: Ordenar por valor só para admin
             const inadimplentesSorts = [{ key: 'days-desc', label: 'Mais Antigas' }, { key: 'name-asc', label: 'Nome (A-Z)' }];
             if(isUserAdmin) inadimplentesSorts.push({ key: 'value-desc', label: 'Maior Valor' });
             inadimplentesSorts.forEach(sort => { /* ... criar botão ... */
                 const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentInadimplentesSort === sort.key ? 'active' : ''}`;
                 button.onclick = () => { currentInadimplentesSort = sort.key; renderInadimplentesPage(getFilteredContracts(false)); renderSortButtons(); };
                 inadimplentesSortContainer.appendChild(button);
             });

             // Serviços: Ordenação não muda
             const servicosSorts = [{ key: 'name-asc', label: 'Cliente (A-Z)' }, { key: 'adv-asc', label: 'Advogado (A-Z)' }];
             servicosSorts.forEach(sort => { /* ... criar botão ... */
                 const button = document.createElement('button'); button.textContent = sort.label; button.className = `sort-button ${currentServicosSort === sort.key ? 'active' : ''}`;
                 button.onclick = () => { currentServicosSort = sort.key; renderServicosPage(getFilteredContracts(false)); renderSortButtons(); };
                 servicosSortContainer.appendChild(button);
             });
        }

        const updateServiceStatus = async function(contractId, serviceIndex, newStatus) { /* ... como estava ... */
             const contract = database.contracts.find(c => c.id === contractId);
             if (contract && contract.serviceTypes && contract.serviceTypes[serviceIndex]) { // Checa se serviceTypes existe
                 const updatedServiceTypes = [...contract.serviceTypes];
                 updatedServiceTypes[serviceIndex].status = newStatus;
                 const contractRef = doc(contractsCollection, contractId);
                 try {
                    await updateDoc(contractRef, { serviceTypes: updatedServiceTypes });
                 } catch (error) {
                     console.error("Erro ao atualizar status do serviço:", error);
                     // Opcional: Mostrar erro para o usuário
                 }
             } else {
                 console.warn(`Serviço no índice ${serviceIndex} não encontrado para o contrato ${contractId}`);
             }
        }
        window.App.updateServiceStatus = updateServiceStatus;

        // --- Lixeira Functions ---
        // ADICIONADO: Função genérica para confirmação (substitui window.confirm)
        function showConfirmationModal(message, onConfirm) {
            // Cria os elementos do modal dinamicamente
            const confirmBackdrop = document.createElement('div');
            confirmBackdrop.className = 'modal-backdrop';
            confirmBackdrop.style.display = 'block';
            confirmBackdrop.style.zIndex = '1050'; // Acima de outros modais

            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal bg-gray-800 border border-red-700 rounded-lg shadow-xl w-11/12 md:w-1/3';
            confirmModal.style.display = 'block';
            confirmModal.style.zIndex = '1060';
            confirmModal.innerHTML = `
                <div class="p-6">
                    <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-exclamation-triangle text-red-400 mr-2"></i> Confirmação</h3>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirmCancelBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmBackdrop);
            document.body.appendChild(confirmModal);

            const closeConfirmModal = () => {
                if (document.body.contains(confirmModal)) document.body.removeChild(confirmModal);
                if (document.body.contains(confirmBackdrop)) document.body.removeChild(confirmBackdrop);
            };

            document.getElementById('confirmCancelBtn').onclick = closeConfirmModal;
            document.getElementById('confirmOkBtn').onclick = () => {
                closeConfirmModal();
                onConfirm(); // Executa a ação confirmada
            };
            confirmBackdrop.onclick = closeConfirmModal; // Fecha ao clicar fora
        }

        const moveToLixeira = async function(contractId) {
             const contract = database.contracts.find(c => c.id === contractId);
             if (!contract) return;
             showConfirmationModal(
                 `Tem certeza que deseja mover o contrato de "${contract.clientName}" para a lixeira?`,
                 async () => {
                     const contractRef = doc(contractsCollection, contractId);
                     try {
                         await updateDoc(contractRef, { isDeleted: true });
                         console.log(`Contrato ${contractId} movido para lixeira.`);
                     } catch (error) {
                         console.error("Erro ao mover para lixeira:", error);
                     }
                 }
             );
        }
        window.App.moveToLixeira = moveToLixeira;

        const restoreContract = async function(contractId) {
             const contract = database.contracts.find(c => c.id === contractId);
              if (!contract) return;
             showConfirmationModal(
                 `Tem certeza que deseja restaurar o contrato de "${contract.clientName}"?`,
                 async () => {
                     const contractRef = doc(contractsCollection, contractId);
                      try {
                         await updateDoc(contractRef, { isDeleted: false });
                         console.log(`Contrato ${contractId} restaurado.`);
                         // Opcional: Mudar para a página do dashboard após restaurar
                         // showPage('page-dashboard');
                      } catch (error) {
                          console.error("Erro ao restaurar contrato:", error);
                      }
                 }
             );
        }
        window.App.restoreContract = restoreContract;

        const deleteContractPermanently = async function(contractId) {
             if (!isUserAdmin) {
                 console.warn("Apenas administradores podem excluir permanentemente.");
                 // Opcional: Mostrar uma mensagem para o usuário não-admin
                 return;
             }
             const contract = database.contracts.find(c => c.id === contractId);
             if (!contract) return;
             showConfirmationModal(
                 `EXCLUSÃO PERMANENTE: Tem certeza que deseja apagar o contrato de "${contract.clientName}" para sempre? Esta ação NÃO PODE ser desfeita.`,
                 async () => {
                      try {
                         await deleteDoc(doc(contractsCollection, contractId));
                         console.log(`Contrato ${contractId} excluído permanentemente.`);
                      } catch (error) {
                           console.error("Erro ao excluir permanentemente:", error);
                      }
                 }
             );
        }
        window.App.deleteContractPermanently = deleteContractPermanently;


        // --- Modal Functions ---
        // ... (openModal, closeModal como estavam) ...
        const openModal = function(modalId) { /* ... como estava ... */
             setTimeout(() => {
                 const modal = document.getElementById(modalId);
                 if(modal) { modal.style.display = 'block'; modal.style.zIndex = '1000'; }
                 else { console.error("Modal não encontrado:", modalId); }
                 if(backdrop) { backdrop.style.display = 'block'; backdrop.style.zIndex = '999'; }
             }, 0);
        }
        window.App.openModal = openModal;

        const closeModal = function(modalId) { /* ... como estava ... */
             const modal = document.getElementById(modalId);
             if(modal) modal.style.display = 'none';

             // Fecha o backdrop apenas se não houver outros modais abertos (exceto o de confirmação)
             const anyModalOpen = Array.from(document.querySelectorAll('.modal')).some(
                 m => m.style.display === 'block' && !m.querySelector('#confirmOkBtn') // Verifica se não é o modal de confirmação
             );
             if(backdrop && !anyModalOpen) {
                 backdrop.style.display = 'none';
             }
        }
        window.App.closeModal = closeModal;


        // ... (openContractModal, openPaymentModal, openClientHistoryModal, openReportModal como estavam) ...
         const openContractModal = function(contractId = null) {
            const form = document.getElementById('formContrato'); form.reset();
            const title = document.getElementById('modalContratoTitle');
            const servicosContainer = document.getElementById('servicosContainer'); servicosContainer.innerHTML = '';
            populateAdvogadoSelectModal(); // Popula o select com a lógica correta
            const advogadoSelect = document.getElementById('advogadoResponsavel');

             if (contractId) {
                 const contract = database.contracts.find(c => c.id === contractId);
                  if (!contract) { console.error(`Contrato com ID ${contractId} não encontrado.`); return; } // Checagem
                 title.textContent = "Editar Contrato";
                 document.getElementById('contractId').value = contract.id;
                 document.getElementById('clienteNome').value = contract.clientName;
                 advogadoSelect.value = contract.advogadoResponsavel;
                 (contract.serviceTypes || []).forEach(service => createServiceTag(service.name, service.deadline, service.status));
                 document.getElementById('contratoTipoPagamento').value = contract.paymentType;
                 document.getElementById('contratoObservacoes').value = contract.observations || ''; // Garante que é string
                 // Campos financeiros (apenas preenche se admin)
                 if (isUserAdmin) {
                     document.getElementById('valorTotal').value = contract.totalValue || '';
                     document.getElementById('numParcelas').value = (contract.parcels || []).length || 1;
                     document.getElementById('taxaExito').value = contract.successFee || '';
                     // Garante que dueDate existe e é válido antes de tentar formatar
                     if ((contract.parcels || []).length > 0 && contract.parcels[0].dueDate) {
                          try {
                              // Tenta converter para data e formatar
                              const dateString = contract.parcels[0].dueDate.split('T')[0];
                              // Validação simples do formato YYYY-MM-DD
                              if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                                  document.getElementById('vencimentoPrimeiraParcela').value = dateString;
                              } else {
                                  console.warn(`Formato inválido para dueDate da primeira parcela: ${contract.parcels[0].dueDate}`);
                                   document.getElementById('vencimentoPrimeiraParcela').value = ''; // Limpa se inválido
                              }
                          } catch (e) {
                               console.error(`Erro ao processar dueDate da primeira parcela: ${contract.parcels[0].dueDate}`, e);
                               document.getElementById('vencimentoPrimeiraParcela').value = ''; // Limpa em caso de erro
                          }
                     } else {
                          document.getElementById('vencimentoPrimeiraParcela').value = ''; // Limpa se não houver parcelas ou dueDate
                     }
                 }
             } else {
                 title.textContent = "Cadastrar Novo Contrato";
                 document.getElementById('contractId').value = '';
                 // Define advogado padrão
                 advogadoSelect.value = isUserAdmin ? 'Não Informado' : currentUserDisplayName;
                 // Limpa campos financeiros explicitamente ao criar novo
                 if(isUserAdmin){
                    document.getElementById('valorTotal').value = '';
                    document.getElementById('numParcelas').value = '1';
                    document.getElementById('taxaExito').value = '';
                    document.getElementById('vencimentoPrimeiraParcela').value = '';
                 }

             }
             // Habilita/desabilita campos financeiros
             setupUIAccess(isUserAdmin);
             openModal('modalContrato');
        }
        window.App.openContractModal = openContractModal;

        const openPaymentModal = async function(contractId, parcelIndex) {
            const contract = database.contracts.find(c => c.id === contractId);
            if (!contract || !contract.parcels || !contract.parcels[parcelIndex]) return;
            const parcel = contract.parcels[parcelIndex];

             // Adiciona checagem para dueDate inválido
             if (!parcel.dueDate) {
                 console.error(`Tentando abrir modal de pagamento para parcela sem dueDate (Contrato ${contractId}, Index ${parcelIndex})`);
                 // Opcional: Mostrar erro ao usuário
                 return;
             }
             const vencimentoDate = new Date(parcel.dueDate);
              if (isNaN(vencimentoDate.getTime())) {
                  console.error(`Tentando abrir modal de pagamento para parcela com dueDate inválido: ${parcel.dueDate} (Contrato ${contractId}, Index ${parcelIndex})`);
                 return;
             }


            let valorCorrigido = parcel.value;
            let infoCorrecao = '';
            if (vencimentoDate < new Date()) { // Usa a data validada
                try {
                    valorCorrigido = await calcularValorCorrigido(parcel.value, parcel.dueDate); // Passa a string original
                    if(isUserAdmin) infoCorrecao = `<p class="text-red-400"><strong>Valor Corrigido:</strong> ${valorCorrigido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>`;
                } catch(e) {
                    console.error("Erro ao calcular valor corrigido no modal de pagamento:", e);
                    infoCorrecao = '<p class="text-red-500">Erro ao calcular correção.</p>';
                    valorCorrigido = parcel.value; // Usa o valor original em caso de erro
                }
            }

            document.getElementById('pagamentoContractId').value = contractId;
            document.getElementById('pagamentoParcelIndex').value = parcelIndex;
            const infoDiv = document.getElementById('pagamentoInfo');
             infoDiv.innerHTML = `
                 <p><strong>Cliente:</strong> ${contract.clientName}</p>
                 <p><strong>Parcela:</strong> ${parcel.number}/${contract.parcels.length}</p>
                 ${isUserAdmin ? `<p><strong>Valor Original:</strong> ${parcel.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>` : ''}
                 ${infoCorrecao}`;

            const valorInput = document.getElementById('pagamentoValor');
            // Garante que valorCorrigido é um número antes de toFixed
            valorInput.value = isUserAdmin
                                ? (typeof valorCorrigido === 'number' ? valorCorrigido.toFixed(2) : parcel.value.toFixed(2))
                                : parcel.value.toFixed(2);
            valorInput.disabled = !isUserAdmin;

            document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
            openModal('modalPagamento');
        }
        window.App.openPaymentModal = openPaymentModal;

        const openClientHistoryModal = function(clientName) {
            // Usa todos os contratos do cliente, mesmo os de outros advogados (se admin)
             const clientContracts = (isUserAdmin ? database.contracts : getFilteredContracts(true))
                                         .filter(c => c.clientName === clientName)
                                         .sort((a,b) => { // Ordena por data da primeira parcela (mais recente primeiro)
                                             const dateA = (a.parcels && a.parcels[0]?.dueDate) ? new Date(a.parcels[0].dueDate) : new Date(0);
                                             const dateB = (b.parcels && b.parcels[0]?.dueDate) ? new Date(b.parcels[0].dueDate) : new Date(0);
                                             // Trata datas inválidas colocando-as no final
                                             if (isNaN(dateA.getTime())) return 1;
                                             if (isNaN(dateB.getTime())) return -1;
                                             return dateB - dateA;
                                         });
             const title = document.getElementById('clienteModalTitle'); title.textContent = `Histórico de ${clientName}`;
             const content = document.getElementById('clienteModalContent');

             let totalContratado = 0, totalPago = 0, html = '';

             clientContracts.forEach(contract => {
                 const contractValue = contract.totalValue || 0;
                 if(isUserAdmin) totalContratado += contractValue; // Soma apenas se admin

                 let contractHtml = `<div class="bg-gray-700 p-4 rounded-lg ${contract.isDeleted ? 'opacity-60 border-l-4 border-gray-500' : ''}">`;
                 contractHtml += `<div class="flex justify-between items-start">
                                     <h3 class="font-bold text-lg text-white">${(contract.serviceTypes || []).map(s => s.name).join(', ')} <span class="text-base font-normal text-gray-400">- ${contract.paymentType || 'N/A'}</span></h3>
                                     ${contract.isDeleted ? '<span class="text-xs bg-red-900/50 text-red-300 px-2 py-1 rounded-full font-semibold">Excluído</span>' : ''}
                                 </div>`;
                 contractHtml += `<p class="text-sm text-gray-400 mb-2">Adv: ${contract.advogadoResponsavel || 'N/A'}</p>`;
                  // Mostra a data do contrato (baseado na 1a parcela) se disponível
                 const firstDueDateStr = contract.parcels && contract.parcels[0]?.dueDate;
                 if (firstDueDateStr) {
                     try {
                        const firstDueDate = new Date(firstDueDateStr);
                        if (!isNaN(firstDueDate.getTime())) {
                             contractHtml += `<p class="text-xs text-gray-500 mb-2">Início: ${firstDueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</p>`;
                        }
                     } catch(e) {/* ignora data inválida */}
                 }


                 if (contract.observations) contractHtml += `<blockquote class="text-sm mt-2 p-2 bg-gray-600/50 rounded-md text-gray-300 border-l-4 border-indigo-500 pl-4 whitespace-pre-wrap"><strong>Obs:</strong> ${contract.observations}</blockquote>`;

                 if((contract.parcels || []).length > 0) {
                     contractHtml += `<h4 class="text-sm font-semibold mt-3 mb-1 text-gray-400">Parcelas:</h4><ul class="text-xs space-y-1">`;
                     contract.parcels.forEach(p => {
                         const statusClass = p.status === 'Paga' ? 'text-green-400' : (new Date(p.dueDate) < new Date() && p.status !== 'Paga' ? 'text-red-400' : 'text-yellow-400');
                         let valorPagoDisplay = '';
                         let paymentDateDisplay = '';
                         if (p.status === 'Paga') {
                             if(isUserAdmin) totalPago += p.valuePaid || 0; // Soma apenas se admin
                             valorPagoDisplay = isUserAdmin ? ` (pago ${(p.valuePaid || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})` : ' (pago)';
                              try { // Formata data de pagamento
                                  paymentDateDisplay = p.paymentDate ? ` em ${new Date(p.paymentDate).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}` : '';
                              } catch(e) {/* ignora data inválida */}
                         }
                         const valorParcelaDisplay = isUserAdmin ? (p.value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Restrito]';
                          let dueDateDisplay = 'N/A';
                          try { // Formata data de vencimento
                             dueDateDisplay = p.dueDate ? new Date(p.dueDate).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A';
                          } catch(e) {/* ignora data inválida */}

                         contractHtml += `<li class="flex justify-between items-center bg-gray-800/50 px-2 py-1 rounded-sm">
                                            <span> P${p.number}: ${valorParcelaDisplay} (Venc: ${dueDateDisplay})</span>
                                            <span class="${statusClass} font-medium">${p.status}${paymentDateDisplay}${valorPagoDisplay}</span>
                                          </li>`;
                     });
                     contractHtml += `</ul>`;
                 }
                 if(contract.successFeePaymentDate){
                      const exitoRecebidoDisplay = isUserAdmin ? (contract.successFeeValueReceived || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '[Recebido]';
                      if(isUserAdmin) totalPago += contract.successFeeValueReceived || 0; // Soma apenas se admin
                       let exitoDateDisplay = '';
                       try {
                           exitoDateDisplay = ` em ${new Date(contract.successFeePaymentDate).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}`;
                       } catch(e) {/* ignora data inválida */}
                      contractHtml += `<p class="mt-2 text-sm text-green-400 font-semibold"><i class="fas fa-star text-yellow-400 mr-1"></i>Êxito Recebido: ${exitoRecebidoDisplay}${exitoDateDisplay}</p>`;
                 } else if (contract.successFee) {
                      const exitoPrevistoDisplay = isUserAdmin ? contract.successFee : '[Previsto]';
                      contractHtml += `<p class="mt-2 text-sm text-indigo-400"><i class="far fa-star text-gray-500 mr-1"></i>Êxito Previsto: ${exitoPrevistoDisplay}</p>`;
                 }
                 contractHtml += `</div>`;
                 html += contractHtml;
             });

             // Sumário financeiro apenas para admin
             const summaryHtml = isUserAdmin ? `
                 <div class="grid grid-cols-3 gap-4 text-center mb-4 bg-gray-900 p-4 rounded-lg border border-gray-700">
                     <div><p class="text-xs text-gray-400 uppercase tracking-wider">Total Contratado</p><p class="font-bold text-lg text-white">${totalContratado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                     <div><p class="text-xs text-gray-400 uppercase tracking-wider">Total Pago</p><p class="font-bold text-lg text-green-400">${totalPago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                     <div><p class="text-xs text-gray-400 uppercase tracking-wider">Saldo Devedor</p><p class="font-bold text-lg text-red-400">${(totalContratado - totalPago).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                 </div>` : '';

             content.innerHTML = summaryHtml + (html || '<p class="text-center text-gray-400">Nenhum contrato encontrado para este cliente.</p>'); // Adiciona mensagem se não houver contratos
             openModal('modalCliente');
        }
        window.App.openClientHistoryModal = openClientHistoryModal;

        const openReportModal = function() {
            if (!isUserAdmin) return; // Ação apenas para admin
            populateDateSelectors();
            generateAndShowReport(); // Gera o relatório inicial para o mês atual
            openModal('modalRelatorio');
        }
        window.App.openReportModal = openReportModal;


        // ... (Restante das funções: populateDateSelectors, calculateMonthlyIncome, generateAndShowReport, openExitoModal, createServiceTag, fetchIPCA, calcularValorCorrigido, formatCSVCell, downloadCSV, exportContractsCSV, exportReportCSV, event listeners DOMContentLoaded) ...
        function populateDateSelectors() { /* ... como estava ... */
            const monthSelect = document.getElementById('reportMonth'); const yearSelect = document.getElementById('reportYear');
             const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
             const anoAtual = new Date().getFullYear();
              // Limpa selects antes de popular para evitar duplicação se chamado mais de uma vez
             monthSelect.innerHTML = '';
             yearSelect.innerHTML = '';

             meses.forEach((mes, index) => { monthSelect.add(new Option(mes, index)); });
             for (let i = anoAtual; i >= anoAtual - 5; i--) { yearSelect.add(new Option(i, i)); }
             monthSelect.value = new Date().getMonth(); yearSelect.value = anoAtual;
        }

        function calculateMonthlyIncome(year, month, contractsToRender) {
             // Retorna 0 se não for admin
             if (!isUserAdmin) return { totalParcelas: 0, totalExito: 0, totalGeral: 0, detailedPayments: [] };

            let totalParcelas = 0, totalExito = 0, detailedPayments = [];
             contractsToRender.filter(c => !c.isDeleted).forEach(contract => {
                 // Soma parcelas pagas no mês/ano
                 (contract.parcels || []).forEach(parcel => {
                      if(parcel.status === 'Paga' && parcel.paymentDate) { // Verifica se paymentDate existe
                         try {
                            const d = new Date(parcel.paymentDate);
                            // Verifica se a data é válida
                            if (!isNaN(d.getTime()) && d.getFullYear() === year && d.getMonth() === month) {
                                totalParcelas += (parcel.valuePaid || 0); // Usa 0 se valuePaid for undefined/null
                                detailedPayments.push({
                                    type: `Parcela ${parcel.number}/${contract.parcels.length}`,
                                    clientName: contract.clientName,
                                    date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), // Usa UTC para consistência
                                    value: (parcel.valuePaid || 0) // Usa 0 se valuePaid for undefined/null
                                });
                            }
                         } catch (e) {
                             console.warn(`Data de pagamento inválida encontrada: ${parcel.paymentDate}`, e);
                         }
                     }
                 });
                 // Soma êxito pago no mês/ano
                 if (contract.successFeePaymentDate) {
                     try {
                        const d = new Date(contract.successFeePaymentDate);
                         // Verifica se a data é válida
                        if (!isNaN(d.getTime()) && d.getFullYear() === year && d.getMonth() === month) {
                            totalExito += (contract.successFeeValueReceived || 0); // Usa 0 se não definido
                            detailedPayments.push({
                                type: 'Taxa de Êxito',
                                clientName: contract.clientName,
                                date: d.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), // Usa UTC
                                value: (contract.successFeeValueReceived || 0) // Usa 0 se não definido
                            });
                        }
                     } catch (e) {
                         console.warn(`Data de pagamento de êxito inválida encontrada: ${contract.successFeePaymentDate}`, e);
                     }
                 }
             });
             // Ordena pagamentos pela data (convertendo para objeto Date para ordenar corretamente)
             detailedPayments.sort((a,b) => {
                 try {
                     const dateA = new Date(a.date.split('/').reverse().join('-') + 'T12:00:00Z');
                     const dateB = new Date(b.date.split('/').reverse().join('-') + 'T12:00:00Z');
                     if (isNaN(dateA.getTime())) return 1; // Coloca datas inválidas no final
                     if (isNaN(dateB.getTime())) return -1;
                     return dateA - dateB;
                 } catch (e) {
                     console.error("Erro ao ordenar datas de pagamento:", e);
                     return 0; // Mantém a ordem em caso de erro
                 }
             });
             return { totalParcelas, totalExito, totalGeral: totalParcelas + totalExito, detailedPayments };
        }

        const generateAndShowReport = function() {
             if (!isUserAdmin) return; // Ação apenas para admin
             const month = parseInt(document.getElementById('reportMonth').value);
             const year = parseInt(document.getElementById('reportYear').value);
             const resultDiv = document.getElementById('reportResult');
             // Usa TODOS os contratos para o relatório, não apenas os filtrados na tela principal
             const income = calculateMonthlyIncome(year, month, database.contracts); // Usa database.contracts

             let detailsHtml = '<h4 class="text-lg font-semibold mt-6 border-t border-gray-700 pt-4 text-white">Detalhes dos Recebimentos</h4>';
             if (income.detailedPayments.length > 0) {
                 detailsHtml += '<ul class="space-y-2 mt-2 text-sm max-h-60 overflow-y-auto pr-2">'; // Adiciona scroll
                 income.detailedPayments.forEach(p => { detailsHtml += `<li class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><div><p class="font-semibold text-white">${p.clientName}</p><p class="text-xs text-gray-400">${p.type} - ${p.date}</p></div><span class="font-semibold text-green-400 text-lg">${p.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></li>`; });
                 detailsHtml += '</ul>';
             } else { detailsHtml += '<p class="text-sm text-gray-400 mt-2">Nenhum recebimento neste período.</p>'; }

             resultDiv.innerHTML = `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (Parcelas)</p><p class="text-2xl font-bold text-white">${income.totalParcelas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                     <div class="dark-card p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total (Êxito)</p><p class="text-2xl font-bold text-indigo-400">${income.totalExito.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
                 </div>
                 <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 text-center"><p class="text-white font-bold">TOTAL GERAL RECEBIDO</p><p class="text-3xl font-extrabold text-green-400">${income.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p></div>
             ` + detailsHtml;
        }
        window.App.generateAndShowReport = generateAndShowReport;

        const openExitoModal = function(contractId) {
             const contract = database.contracts.find(c => c.id === contractId); if (!contract) return;
             document.getElementById('exitoContractId').value = contractId;
             const exitoInfoEl = document.getElementById('exitoInfo');
             const valorRecebidoInput = document.getElementById('exitoValorRecebido');

             exitoInfoEl.innerHTML = `<p><strong>Cliente:</strong> ${contract.clientName}</p><p><strong>Serviço:</strong> ${(contract.serviceTypes || []).map(s => s.name).join(', ')}</p>${isUserAdmin ? `<p><strong>Bonificação Prevista:</strong> <span class="font-bold text-indigo-400">${contract.successFee || 'N/A'}</span></p>` : ''}`; // Adiciona N/A se não houver

             // Habilita/desabilita input de valor
             valorRecebidoInput.value = ''; // Limpa o valor anterior
             valorRecebidoInput.closest('.admin-only').style.display = isUserAdmin ? 'block' : 'none'; // Mostra/esconde a div
             document.querySelector('#modalExito .non-admin-hidden').style.display = isUserAdmin ? 'none' : 'block'; // Mostra/esconde o texto

             openModal('modalExito');
        }
        window.App.openExitoModal = openExitoModal;

        const createServiceTag = function(serviceName, deadline, status = 'Pendente') { /* ... como estava ... */
             const container = document.getElementById('servicosContainer');
             if (!container) return; // Checa se o container existe
             const tag = document.createElement('div'); tag.className = 'service-tag';
             tag.dataset.name = serviceName; tag.dataset.deadline = deadline || ''; tag.dataset.status = status;
             let deadlineHtml = '';
             if (deadline) {
                  try {
                    const prazo = new Date(deadline + "T12:00:00Z"); // Adiciona hora para evitar problemas de fuso
                     if(!isNaN(prazo.getTime())) { // Verifica se a data é válida
                        deadlineHtml = `<span class="text-xs text-gray-400 ml-2">(${prazo.toLocaleDateString('pt-BR', {timeZone: 'UTC'})})</span>`;
                     } else {
                         console.warn(`Data de prazo inválida fornecida: ${deadline}`);
                     }
                  } catch(e) {
                      console.error(`Erro ao processar data de prazo: ${deadline}`, e);
                  }
             }
             tag.innerHTML = `<span>${serviceName}${deadlineHtml}</span><span class="remove-tag" onclick="this.parentElement.remove()">&times;</span>`; container.appendChild(tag);
        }
        window.App.createServiceTag = createServiceTag;

        // --- Calculation Functions ---
        async function fetchIPCA(startDate, endDate) {
            // Valida as datas de entrada
            if (!(startDate instanceof Date) || isNaN(startDate.getTime()) || !(endDate instanceof Date) || isNaN(endDate.getTime())) {
                console.error("Datas inválidas fornecidas para fetchIPCA:", startDate, endDate);
                return 1; // Retorna 1 (sem correção) se as datas forem inválidas
            }

             const formatApiDate = (d) => {
                 // Usa UTC para evitar problemas de fuso horário na formatação da data para a API
                 const day = String(d.getUTCDate()).padStart(2, '0');
                 const month = String(d.getUTCMonth() + 1).padStart(2, '0'); // Mês é 0-indexado
                 const year = d.getUTCFullYear();
                 return `${day}/${month}/${year}`;
             };

             const startF = formatApiDate(startDate);
             const endF = formatApiDate(endDate); // Usa data final real para cache, mas busca só o último índice
             const cacheKey = `${startF}-${endF}`; // Chave de cache inclui data final para diferenciar períodos
             if (ipcaCache.has(cacheKey)) {
                 // console.log("IPCA Cache Hit:", cacheKey, ipcaCache.get(cacheKey));
                 return ipcaCache.get(cacheKey);
             }

             // Usa proxy para contornar CORS
             const proxy = 'https://api.allorigins.win/get?url=';
             // API do Banco Central para o índice IPCA (SGS 433) - Usar o índice geral 433
             const apiBaseUrl = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados';

             try {
                 // Busca o índice na data inicial
                 const urlStart = `${proxy}${encodeURIComponent(`${apiBaseUrl}?formato=json&dataInicial=${startF}&dataFinal=${startF}`)}`;
                 //console.log("Fetching IPCA Start:", urlStart);
                 const responseStart = await fetch(urlStart);
                 if (!responseStart.ok) throw new Error(`BCB API Start Error: ${responseStart.statusText}`);
                 let dataStartRaw = await responseStart.json();
                 let dataStart = JSON.parse(dataStartRaw.contents);
                 //console.log("BCB Start Response:", dataStart);

                 // Busca o índice mais recente (último valor disponível)
                 const urlEnd = `${proxy}${encodeURIComponent(`${apiBaseUrl}/ultimos/1?formato=json`)}`;
                 //console.log("Fetching IPCA End:", urlEnd);
                 const responseEnd = await fetch(urlEnd);
                 if (!responseEnd.ok) throw new Error(`BCB API End Error: ${responseEnd.statusText}`);
                 let dataEndRaw = await responseEnd.json();
                 let dataEnd = JSON.parse(dataEndRaw.contents);
                 //console.log("BCB End Response:", dataEnd);

                 // Verifica se os dados foram retornados e extrai os valores
                 const indexStart = dataStart && dataStart.length > 0 ? parseFloat(dataStart[0].valor.replace(',', '.')) : null; // Troca vírgula por ponto
                 const indexEnd = dataEnd && dataEnd.length > 0 ? parseFloat(dataEnd[0].valor.replace(',', '.')) : null; // Troca vírgula por ponto

                 if (indexStart === null || indexEnd === null || indexStart === 0) {
                     console.warn(`Índices IPCA não encontrados ou inválidos para o período ${startF} - (último). Start: ${indexStart}, End: ${indexEnd}. Usando fator 1.`);
                     ipcaCache.set(cacheKey, 1); // Guarda 1 no cache para evitar novas buscas falhas
                     return 1;
                 }

                 const multiplier = indexEnd / indexStart;
                 console.log(`IPCA Calculado: Start=${indexStart} (${startF}), End=${indexEnd} (Último), Multiplier=${multiplier}`);
                 ipcaCache.set(cacheKey, multiplier);
                 return multiplier;

             } catch (error) {
                 console.error("Erro ao buscar dados do IPCA:", error);
                 // Não guarda erro no cache, pode tentar de novo depois
                 return 1; // Retorna 1 em caso de erro na busca
             }
        }
        async function calcularValorCorrigido(valorOriginal, dataVencimentoStr) {
             const hoje = new Date(); hoje.setHours(0, 0, 0, 0); // Zera hora para comparação de dias
             let venc;
             try {
                // Tenta criar a data a partir da string, adicionando hora para evitar fuso
                 venc = new Date(dataVencimentoStr + 'T12:00:00Z');
                 if (isNaN(venc.getTime())) throw new Error("Data Inválida"); // Verifica se a data é válida
                 venc.setUTCHours(0, 0, 0, 0); // Zera hora UTC para comparação
             } catch (e) {
                 console.error(`Data de vencimento inválida para correção: ${dataVencimentoStr}`, e);
                 return valorOriginal; // Retorna original se data for inválida
             }


             if (hoje <= venc) return valorOriginal; // Não corrige se não venceu

             const valorOriginalNum = parseFloat(valorOriginal);
             if (isNaN(valorOriginalNum)) {
                 console.error(`Valor original inválido para correção: ${valorOriginal}`);
                 return 0; // Ou retorna erro, dependendo da lógica desejada
             }


             const ipcaMultiplier = await fetchIPCA(venc, hoje);
             let valorCorrigidoIPCA = valorOriginalNum * ipcaMultiplier;

             // Cálculo de Juros de Mora (1% ao mês pro rata die)
             const diffTime = hoje - venc; // Diferença em milissegundos
             const diffDays = Math.max(0, diffTime / (1000 * 60 * 60 * 24)); // Dias de atraso (mínimo 0)
             const jurosPercentual = (0.01 / 30) * diffDays; // Juros pro rata die (considerando mês de 30 dias)
             const jurosValor = valorCorrigidoIPCA * jurosPercentual;

             // Multa de 2% (aplicada sobre o valor corrigido pelo IPCA)
             const multaValor = valorCorrigidoIPCA * 0.02;

             const valorFinalCorrigido = valorCorrigidoIPCA + jurosValor + multaValor;

             // console.log(`Correção: Original=${valorOriginalNum}, Venc=${venc.toLocaleDateString()}, Hoje=${hoje.toLocaleDateString()}, Dias Atraso=${diffDays.toFixed(2)}, IPCA Mult=${ipcaMultiplier.toFixed(4)}, Corrigido IPCA=${valorCorrigidoIPCA.toFixed(2)}, Juros=${jurosValor.toFixed(2)}, Multa=${multaValor.toFixed(2)}, Final=${valorFinalCorrigido.toFixed(2)}`);

             return valorFinalCorrigido;
        }

        // --- CSV Export Functions ---
        // ... (formatCSVCell, downloadCSV, exportContractsCSV, exportReportCSV como estavam) ...
        function formatCSVCell(data) { /* ... como estava ... */ if (data == null) return ''; let s = String(data); if (s.includes(',') || s.includes('"') || s.includes('\n')) { s = s.replace(/"/g, '""'); return `"${s}"`; } return s; }
        function downloadCSV(csvContent, filename) { /* ... como estava ... */ const b = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement("a"); const u = URL.createObjectURL(b); l.href = u; l.download = filename; l.style.visibility = 'hidden'; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(u); } // Adiciona BOM e revokeObjectURL

        const exportContractsCSV = function() {
            // Usa os contratos atualmente filtrados na tela (respeitando filtro de advogado e busca)
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const advogadoFilterEl = document.getElementById('advogadoFilter');
            let advogadoFilter = advogadoFilterEl.value;
            if (!isUserAdmin) advogadoFilter = currentUserDisplayName;

            const contractsToExport = getFilteredContracts(false).filter(c => {
                 const matchesAdvogado = (isUserAdmin && advogadoFilter === 'Todos') || c.advogadoResponsavel === advogadoFilter;
                 const matchesSearch = c.clientName.toLowerCase().includes(searchTerm) || (c.serviceTypes || []).some(s => s.name.toLowerCase().includes(searchTerm));
                 return matchesAdvogado && matchesSearch;
            });
             // Aplica a ordenação atual da lista
             if (currentContractSort === 'name-asc') {
                contractsToExport.sort((a, b) => a.clientName.localeCompare(b.clientName));
             } else if (currentContractSort === 'value-desc' && isUserAdmin) {
                contractsToExport.sort((a, b) => (b.totalValue || 0) - (a.totalValue || 0));
             }


             const headers = ["Cliente", "Advogado", "Serviços", "Tipo Pagamento", "Valor Fixo Total", "Taxa Êxito", "Status Atual", "Observações"];
             let csvRows = [headers.join(',')];

             contractsToExport.forEach(c => {
                 const status = getContractStatus(c).statusText;
                 const services = (c.serviceTypes || []).map(s => s.name).join('; '); // Usa ; como separador interno
                 const row = [
                     c.clientName,
                     c.advogadoResponsavel,
                     services,
                     c.paymentType,
                     isUserAdmin ? (c.totalValue || 0) : 'Restrito', // Formata valor ou restringe
                     isUserAdmin ? (c.successFee || '') : 'Restrito', // Formata êxito ou restringe
                     status,
                     c.observations
                 ].map(formatCSVCell).join(','); // Usa função para tratar aspas e vírgulas
                 csvRows.push(row);
             });
             downloadCSV(csvRows.join('\n'), `contratos_export_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.csv`);
        }
        window.App.exportContractsCSV = exportContractsCSV;

        const exportReportCSV = function() {
            if (!isUserAdmin) return; // Ação apenas para admin
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            const income = calculateMonthlyIncome(year, month, database.contracts); // Usa TODOS os contratos para o relatório

            if (income.detailedPayments.length === 0) {
                // Usa o modal de confirmação como alerta simples
                showConfirmationModal("Nenhum dado de recebimento encontrado para exportar neste período.", () => {}); // Ação vazia no confirm
                console.warn("Nenhum dado para exportar no relatório.");
                return;
            }

            const headers = ["Cliente", "Tipo Recebimento", "Data Pagamento", "Valor Recebido"];
            let csvRows = [headers.join(',')];
            income.detailedPayments.forEach(p => {
                const row = [
                    p.clientName,
                    p.type,
                    p.date,
                    p.value // Valor já é número
                ].map(formatCSVCell).join(',');
                csvRows.push(row);
            });

            // Adiciona linhas de total
            csvRows.push(''); // Linha em branco
            csvRows.push(formatCSVCell(`Total Parcelas (${income.detailedPayments.filter(p=>p.type.includes('Parcela')).length})`) + ',' + ','+ ',' + formatCSVCell(income.totalParcelas));
            csvRows.push(formatCSVCell(`Total Êxito (${income.detailedPayments.filter(p=>p.type.includes('Êxito')).length})`) + ',' + ','+ ',' + formatCSVCell(income.totalExito));
            csvRows.push(''); // Linha em branco
             csvRows.push(formatCSVCell('TOTAL GERAL RECEBIDO') + ',' + ','+ ',' + formatCSVCell(income.totalGeral));


            const monthName = document.getElementById('reportMonth').options[month].text;
            downloadCSV(csvRows.join('\n'), `relatorio_recebimentos_${monthName}_${year}.csv`);
        }
        window.App.exportReportCSV = exportReportCSV;


        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            backdrop = document.getElementById('modal-backdrop');
            initializeAndAuth(); // Inicia autenticação e setup inicial

            // --- Authentication Handlers ---
            // ... (como estavam) ...
            const loginForm = document.getElementById('login-form');
            const authError = document.getElementById('auth-error');
            const logoutButton = document.getElementById('logout-button');
            const showAuthError = (m) => { authError.textContent = m; authError.classList.remove('hidden'); }
            loginForm.addEventListener('submit', async (e) => { /* ... como estava ... */
                 e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
                 try { await signInWithEmailAndPassword(auth, email, password); authError.classList.add('hidden'); /* Limpa erro no sucesso */}
                 catch (error) { console.error("Login Error:", error.code); if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) showAuthError('Email ou senha inválidos.'); else showAuthError('Erro ao tentar fazer login. Verifique sua conexão.'); }
            });
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("Usuário deslogado.");
                    // A lógica de onAuthStateChanged cuidará de mostrar a tela de login
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                }
            });


            // --- Display Name Handler ---
            // ... (como estava) ...
            const displayNameForm = document.getElementById('formDisplayName');
            displayNameForm.addEventListener('submit', async (e) => { /* ... como estava ... */
                 e.preventDefault(); const name = document.getElementById('inputDisplayName').value.trim(); // Adiciona trim()
                 if (name && auth.currentUser) {
                     // Adiciona validação simples para nome não vazio
                     if (name.length < 3) {
                         alert("Por favor, insira um nome com pelo menos 3 caracteres."); // Usando alert temporariamente aqui
                         return;
                     }
                     try {
                         await updateProfile(auth.currentUser, { displayName: name });
                         currentUserDisplayName = name; isUserAdmin = ADMIN_USERS.includes(name);
                         document.body.classList.toggle('is-admin', isUserAdmin); // Atualiza classe do body
                         document.getElementById('user-display-name').textContent = name;
                         closeModal('modalDisplayName'); document.getElementById('app-container').style.display = 'block';
                         setupUIAccess(isUserAdmin);
                         // Não precisa recriar collection ou listener aqui, já foi feito no onAuthStateChanged
                         // contractsCollection = collection(db, `contracts`); setupSnapshotListener();
                         showPage('page-dashboard'); // Renderiza a página atual após salvar nome (Dashboard por padrão)
                     } catch (error) {
                          console.error("Erro ao salvar nome:", error);
                          alert("Erro ao salvar seu nome. Tente novamente."); // Alert temporário
                     }
                 }
            });


            // --- App Handlers ---
            // ... (formContrato, formPagamento, formExito como estavam) ...
            document.getElementById('formContrato').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const contractId = document.getElementById('contractId').value;
                 const serviceTags = document.querySelectorAll('#servicosContainer .service-tag');
                 const serviceTypes = Array.from(serviceTags).map(tag => ({
                    name: tag.dataset.name,
                    status: tag.dataset.status || 'Pendente',
                    // Garante que deadline seja null se vazio, e não string vazia
                    deadline: tag.dataset.deadline ? tag.dataset.deadline : null
                }));


                 if (serviceTypes.length === 0) {
                     // Substituir alert por UI melhor
                     alert('Adicione pelo menos um serviço ao contrato.');
                     return;
                 }
                 // Validação de Nome do Cliente
                const clientName = document.getElementById('clienteNome').value.trim();
                if (!clientName) {
                    alert('O nome do cliente é obrigatório.');
                    return;
                }
                 // Validação do Advogado Responsável
                const advogadoResp = document.getElementById('advogadoResponsavel').value;
                 if (!advogadoResp || advogadoResp === "Não Informado") {
                     // Permite "Não Informado" se for admin, mas força seleção se não for
                     if (!isUserAdmin) {
                         alert('Selecione o advogado responsável.');
                         return;
                     }
                 }


                 const contractData = {
                     clientName: clientName,
                     advogadoResponsavel: advogadoResp,
                     serviceTypes: serviceTypes,
                     paymentType: document.getElementById('contratoTipoPagamento').value,
                     observations: document.getElementById('contratoObservacoes').value.trim(), // Adiciona trim()
                     // Campos financeiros só são adicionados/atualizados se for admin
                     ...(isUserAdmin && {
                         totalValue: parseFloat(document.getElementById('valorTotal').value) || 0,
                         successFee: document.getElementById('taxaExito').value.trim() || null, // Usa null se vazio
                     })
                 };

                 // Validações financeiras (apenas se admin)
                 if (isUserAdmin) {
                     const totalValue = contractData.totalValue;
                     const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
                     const firstDueDateStr = document.getElementById('vencimentoPrimeiraParcela').value;

                     if (totalValue > 0 && numParcels > 0 && !firstDueDateStr) {
                         alert('Informe a data de vencimento da primeira parcela para contratos com valor e parcelas definidos.');
                         return;
                     }
                      if (totalValue > 0 && numParcels <= 0) {
                         alert('O número de parcelas deve ser 1 ou maior se houver valor total.');
                         return;
                     }
                      // Valida formato da data se informada
                      if (firstDueDateStr && !/^\d{4}-\d{2}-\d{2}$/.test(firstDueDateStr)) {
                         alert('Formato inválido para a data de vencimento da primeira parcela. Use AAAA-MM-DD.');
                         return;
                     }
                 }


                 try {
                     if (!contractId) { // Criando novo contrato
                         contractData.parcels = [];
                         contractData.successFeeValueReceived = 0;
                         contractData.successFeePaymentDate = null;
                         contractData.isDeleted = false;

                         if (isUserAdmin) { // Parcelas só podem ser criadas por admin
                             const totalValue = contractData.totalValue;
                             const numParcels = parseInt(document.getElementById('numParcelas').value) || 1;
                             const firstDueDateStr = document.getElementById('vencimentoPrimeiraParcela').value;

                             if (numParcels > 0 && totalValue > 0 && firstDueDateStr) {
                                 const parcelValue = totalValue / numParcels;
                                 let currentDueDate = new Date(firstDueDateStr + 'T12:00:00Z'); // Usa UTC
                                 if (isNaN(currentDueDate.getTime())) throw new Error("Data inválida para primeira parcela.");

                                 for (let i = 0; i < numParcels; i++) {
                                     contractData.parcels.push({
                                        number: i + 1,
                                        value: parcelValue,
                                        dueDate: new Date(currentDueDate).toISOString(), // Salva como ISO String UTC
                                        status: 'Pendente',
                                        valuePaid: 0,
                                        paymentDate: null
                                    });
                                     // Adiciona 1 mês à data UTC
                                     currentDueDate.setUTCMonth(currentDueDate.getUTCMonth() + 1);
                                 }
                             } else if (totalValue === 0 && numParcels === 1 && firstDueDateStr) {
                                // Caso especial: Contrato sem valor fixo (só êxito) mas com data de referência
                                 contractData.parcels.push({
                                     number: 1, value: 0, dueDate: new Date(firstDueDateStr + 'T12:00:00Z').toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null
                                 });
                             }
                         }
                         await addDoc(contractsCollection, contractData);
                         console.log("Novo contrato adicionado:", contractData.clientName);

                     } else { // Editando contrato existente
                        const existingContract = database.contracts.find(c => c.id === contractId);
                         if (!existingContract) throw new Error("Contrato existente não encontrado para edição.");

                         // Se admin está editando, recalcula as parcelas APENAS se os dados financeiros relevantes mudaram
                        let shouldRecalculateParcels = false;
                        if (isUserAdmin) {
                            const newTotalValue = contractData.totalValue;
                            const newNumParcels = parseInt(document.getElementById('numParcelas').value) || 1;
                            const newFirstDueDateStr = document.getElementById('vencimentoPrimeiraParcela').value;
                            const oldNumParcels = (existingContract.parcels || []).length;
                            const oldFirstDueDateStr = (existingContract.parcels && existingContract.parcels[0]?.dueDate) ? existingContract.parcels[0].dueDate.split('T')[0] : '';

                            if (newTotalValue !== existingContract.totalValue || newNumParcels !== oldNumParcels || newFirstDueDateStr !== oldFirstDueDateStr) {
                                // Verifica se alguma parcela já foi paga. Se sim, impede a recriação.
                                const hasPaidParcel = (existingContract.parcels || []).some(p => p.status === 'Paga');
                                if (hasPaidParcel) {
                                     alert("Não é possível alterar dados financeiros (valor, nº parcelas, 1º vencimento) de um contrato que já possui parcelas pagas. Edite manualmente se necessário.");
                                     // Mantém os dados financeiros e parcelas originais
                                      contractData.totalValue = existingContract.totalValue;
                                      contractData.successFee = existingContract.successFee; // Mantém taxa de êxito também
                                      contractData.parcels = existingContract.parcels;
                                } else if (newTotalValue > 0 && newNumParcels > 0 && newFirstDueDateStr) {
                                     console.log("Recalculando parcelas para contrato existente:", contractId);
                                     shouldRecalculateParcels = true;
                                     contractData.parcels = []; // Limpa parcelas antigas
                                     const parcelValue = newTotalValue / newNumParcels;
                                     let currentDueDate = new Date(newFirstDueDateStr + 'T12:00:00Z');
                                     if (isNaN(currentDueDate.getTime())) throw new Error("Data inválida para primeira parcela.");
                                     for (let i = 0; i < newNumParcels; i++) {
                                        contractData.parcels.push({ number: i + 1, value: parcelValue, dueDate: new Date(currentDueDate).toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null });
                                        currentDueDate.setUTCMonth(currentDueDate.getUTCMonth() + 1);
                                     }
                                } else if (newTotalValue === 0 && newNumParcels === 1 && newFirstDueDateStr) {
                                     // Caso especial: Editando para ser só êxito com data de referência
                                     shouldRecalculateParcels = true;
                                     contractData.parcels = [{ number: 1, value: 0, dueDate: new Date(newFirstDueDateStr + 'T12:00:00Z').toISOString(), status: 'Pendente', valuePaid: 0, paymentDate: null }];
                                } else {
                                     // Se os novos dados financeiros são inválidos (ex: valor > 0 sem data), mantém as parcelas antigas
                                     console.warn("Dados financeiros inválidos na edição, mantendo parcelas existentes.");
                                     contractData.parcels = existingContract.parcels;
                                }
                            } else {
                                // Dados financeiros não mudaram, mantém parcelas existentes
                                contractData.parcels = existingContract.parcels;
                            }
                        } else {
                             // Não é admin, mantém todos os dados financeiros e parcelas originais
                             contractData.totalValue = existingContract.totalValue;
                             contractData.successFee = existingContract.successFee;
                             contractData.parcels = existingContract.parcels;
                        }

                         // Mantém dados de pagamento de êxito e status da lixeira
                         contractData.successFeeValueReceived = existingContract.successFeeValueReceived;
                         contractData.successFeePaymentDate = existingContract.successFeePaymentDate;
                         contractData.isDeleted = existingContract.isDeleted || false;

                         const contractRef = doc(contractsCollection, contractId);
                         await updateDoc(contractRef, contractData);
                         console.log("Contrato editado:", contractData.clientName);
                     }
                     closeModal('modalContrato');
                 } catch (error) {
                      console.error("Erro ao salvar contrato:", error);
                      alert(`Erro ao salvar contrato: ${error.message}`); // Alert temporário
                 }
            });

            document.getElementById('formPagamento').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const contractId = document.getElementById('pagamentoContractId').value;
                 const parcelIndex = parseInt(document.getElementById('pagamentoParcelIndex').value);
                 const paymentDateStr = document.getElementById('pagamentoData').value;

                 // Valida data de pagamento
                 if (!paymentDateStr || !/^\d{4}-\d{2}-\d{2}$/.test(paymentDateStr)) {
                     alert('Informe uma data de pagamento válida.');
                     return;
                 }
                 const paymentDate = new Date(paymentDateStr + 'T12:00:00Z'); // Usa UTC
                 if (isNaN(paymentDate.getTime())) {
                     alert('Data de pagamento inválida.');
                     return;
                 }


                 const contractRef = doc(contractsCollection, contractId);
                 const contract = database.contracts.find(c => c.id === contractId);

                 if (!contract || !contract.parcels || !contract.parcels[parcelIndex]) {
                     console.error("Contrato ou parcela não encontrada para pagamento.");
                     alert("Erro: Contrato ou parcela não encontrada.");
                     return;
                 }

                 // Usa o valor do input se for admin, senão usa o valor original da parcela
                 let valuePaid;
                 if (isUserAdmin) {
                     valuePaid = parseFloat(document.getElementById('pagamentoValor').value);
                     if (isNaN(valuePaid) || valuePaid < 0) { // Permite pagamento de 0
                         alert('Informe um valor de pagamento válido (número maior ou igual a zero).');
                         return;
                     }
                 } else {
                     valuePaid = contract.parcels[parcelIndex].value || 0; // Usa valor original ou 0
                 }


                 try {
                     const updatedParcels = [...contract.parcels];
                     updatedParcels[parcelIndex].status = 'Paga';
                     updatedParcels[parcelIndex].valuePaid = valuePaid; // Salva o valor pago (pode ser 0)
                     updatedParcels[parcelIndex].paymentDate = paymentDate.toISOString(); // Salva como ISO String UTC
                     await updateDoc(contractRef, { parcels: updatedParcels });
                     console.log(`Pagamento registrado para contrato ${contractId}, parcela ${parcelIndex + 1}`);
                     closeModal('modalPagamento');
                 } catch (error) {
                      console.error("Erro ao registrar pagamento:", error);
                      alert("Erro ao registrar pagamento. Tente novamente."); // Alert temporário
                 }
            });

            document.getElementById('formExito').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const contractId = document.getElementById('exitoContractId').value;
                 const contractRef = doc(contractsCollection, contractId);
                 const contract = database.contracts.find(c => c.id === contractId);

                 if (!contract) {
                     console.error("Contrato não encontrado para registrar êxito.");
                     alert("Erro: Contrato não encontrado.");
                     return;
                 }

                 let valueReceived = 0; // Valor padrão para não-admin
                 if (isUserAdmin) {
                     valueReceived = parseFloat(document.getElementById('exitoValorRecebido').value);
                     if (isNaN(valueReceived) || valueReceived < 0) { // Permite 0
                         alert('Informe um valor de êxito válido (número maior ou igual a zero).');
                         return;
                     }
                 }

                 try {
                     await updateDoc(contractRef, {
                         successFeeValueReceived: valueReceived, // Salva valor (ou 0 se não for admin)
                         successFeePaymentDate: new Date().toISOString() // Data da confirmação/recebimento UTC ISO
                     });
                     console.log(`Recebimento de êxito registrado para contrato ${contractId}`);
                     closeModal('modalExito');
                 } catch (error) {
                      console.error("Erro ao registrar recebimento de êxito:", error);
                      alert("Erro ao registrar recebimento de êxito. Tente novamente."); // Alert temporário
                 }
            });


            if (backdrop) {
                // Modificado para fechar APENAS o modal de cima se houver sobreposição
                backdrop.addEventListener('click', () => {
                     // Encontra o modal visível com maior z-index
                     let topModal = null;
                     let maxZ = 0;
                     document.querySelectorAll('.modal').forEach(m => {
                         if (m.style.display === 'block') {
                             const z = parseInt(m.style.zIndex || '0');
                             if (z >= maxZ) {
                                 maxZ = z;
                                 topModal = m;
                             }
                         }
                     });

                     // Fecha apenas o modal de cima, e não o de display name ou confirmação
                     if (topModal && topModal.id !== 'modalDisplayName' && !topModal.querySelector('#confirmOkBtn')) { // Verifica se não é o modal de confirmação
                         closeModal(topModal.id);
                     }
                 });
            }

            // --- Service Tag Handler ---
            const addServiceButton = document.getElementById('addServiceButton');
            if(addServiceButton) {
                const handleAddService = () => { // Função separada para reusar
                    const serviceInput = document.getElementById('contratoServicoInput');
                    const deadlineInput = document.getElementById('contratoPrazoInput');
                    const serviceName = serviceInput.value.trim();
                    const deadline = deadlineInput.value; // Formato YYYY-MM-DD

                    if (serviceName) {
                        // Valida formato da data se informada
                        if (deadline && !/^\d{4}-\d{2}-\d{2}$/.test(deadline)) {
                           alert('Formato inválido para a data de prazo. Use AAAA-MM-DD.');
                           return; // Não adiciona se a data for inválida
                        }
                        createServiceTag(serviceName, deadline, 'Pendente');
                        serviceInput.value = '';
                        deadlineInput.value = '';
                        serviceInput.focus(); // Foca no input de serviço novamente
                    } else {
                        alert('Insira um nome para o serviço.'); // Alert temporário
                        serviceInput.focus();
                    }
                };

                addServiceButton.addEventListener('click', handleAddService);

                 // Adiciona listener para Enter nos inputs de serviço/prazo
                const serviceInput = document.getElementById('contratoServicoInput');
                const deadlineInput = document.getElementById('contratoPrazoInput');
                if(serviceInput) {
                    serviceInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Impede envio do formulário
                            handleAddService();
                        }
                    });
                }
                 if(deadlineInput) {
                    deadlineInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Impede envio do formulário
                            handleAddService(); // Tenta adicionar ao pressionar Enter na data também
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>

